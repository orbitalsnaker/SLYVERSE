<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SLYVERSE v1.1 — Secured Chaos by 0rb1t4lsn4k3r. VR Snake + Entropy + Firebase Fixed.">
  <meta name="theme-color" content="#0f0">
  <title>SLYVERSE v1.1 — 0rb1t4lsn4k3r</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 Q70 30 90 50 Q70 70 50 90 Q30 70 10 50 Q30 30 50 10' fill='none' stroke='%230f0' stroke-width='4'/></svg>">
  <link rel="manifest" href="data:application/manifest+json,{'name':'SLYVERSE','short_name':'SLYVERSE','start_url':'.','display':'standalone','background_color':'#000','theme_color':'#0f0','icons':[{'src':'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Cpath d=%22M50 10 Q70 30 90 50 Q70 70 50 90 Q30 70 10 50 Q30 30 50 10%22 fill=%22none%22 stroke=%22%230f0%22 stroke-width=%224%22/%3E%3C/svg%3E','sizes':'192x192','type':'image/svg+xml'}]}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.168.0/three.min.js"></script>
  <style>
    :root { --void: #000; --glitch: #0f0; --serpent: #f00; --memory: #0ff; --eclipse: #300; --pulse: 1.5s; --glitch-speed: 0.3s; --bleed: 2.7s; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--void); color:var(--glitch); font-family:"Courier New",monospace; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; image-rendering:pixelated; overflow:hidden; }
    canvas { border:2px solid #f0f; background:#111; max-width:100%; max-height:100%; display:block; filter:contrast(1.6) brightness(1.2); image-rendering:pixelated; }
    #ui { position:absolute; top:4px; left:4px; font-size:14px; text-shadow:0 0 6px var(--glitch); z-index:999; animation:glitch 3s infinite; }
    @keyframes glitch { 0%,100% { text-shadow:0 0 6px var(--glitch), 0 0 12px var(--glitch); } 50% { text-shadow:-2px 0 #f00, 2px 0 #0ff; } }
    #journal { position:absolute; top:4px; right:4px; width:320px; background:rgba(0,0,0,.92); padding:12px; border:1px solid var(--glitch); max-height:calc(100vh - 80px); overflow-y:auto; font-size:11px; line-height:1.3; backdrop-filter:blur(2px); z-index:1000; }
    #journal h3 { margin:3px 0; color:var(--memory); font-style:italic; animation:glitch 2.5s infinite; }
    #journal p { margin:2px 0; color:#0a0; opacity:0; transform:translateX(-10px); transition:all .4s; }
    #journal p.show { opacity:1; transform:translateX(0); }
    #chat-input { position:absolute; bottom:4px; right:4px; width:300px; background:rgba(0,0,0,.8); color:var(--glitch); border:1px solid var(--glitch); padding:6px; font-family:monospace; z-index:1001; }
    #controls { position:absolute; bottom:4px; left:50%; transform:translateX(-50%); font-size:10px; color:#666; text-align:center; z-index:1000; }
    #export { position:absolute; bottom:4px; left:4px; background:transparent; color:var(--glitch); border:1px dashed var(--glitch); padding:6px 12px; font-family:monospace; cursor:pointer; animation:pulse var(--pulse) infinite; z-index:1000; }
    @keyframes pulse { 0%,100% { border-color:var(--glitch); } 50% { border-color:var(--serpent); } }
    .eclipse-overlay { position:absolute; inset:0; background:radial-gradient(circle at center, transparent 25%, var(--eclipse) 75%); pointer-events:none; opacity:0; transition:opacity 1.8s; mix-blend-mode:screen; z-index:998; }
    .eclipse-overlay.active { opacity:1; }
    .trail { position:absolute; width:4px; height:4px; background:radial-gradient(#0f0, transparent); border-radius:50%; pointer-events:none; opacity:0; animation:fade 0.8s forwards; z-index:999; }
    @keyframes fade { to { opacity:0; transform:scale(0); } }
    .soul-hash { position:absolute; bottom:16px; left:50%; transform:translateX(-50%); font-size:8px; color:#444; opacity:0; transition:opacity 1s; z-index:1000; }
    .soul-hash.show { opacity:1; }
    .power-up { position:absolute; font-size:12px; color:#ff0; text-shadow:0 0 6px #ff0; animation:blink 0.8s infinite; z-index:999; }
    @keyframes blink { 0%,50% { opacity:1; } 51%,100% { opacity:0; } }
    .memory-echo { position:absolute; pointer-events:none; font-size:12px; color:var(--memory); text-shadow:0 0 8px var(--memory); animation:bleed var(--bleed) infinite, glitch 1s infinite; opacity:0; z-index:999; }
    @keyframes bleed { 0%,100% { filter:hue-rotate(0deg) brightness(1); } 50% { filter:hue-rotate(270deg) brightness(1.8); } }
    #alias-prompt { position:fixed; inset:0; background:rgba(0,0,0,0.95); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; color:var(--glitch); }
    #alias-prompt input { background:transparent; border:1px solid var(--glitch); color:var(--glitch); padding:12px; margin:12px; font-family:monospace; font-size:16px; width:200px; }
    #alias-prompt button { background:#222; color:var(--glitch); border:1px solid var(--glitch); padding:8px 16px; font-family:monospace; cursor:pointer; }
    #leaderboard { position:absolute; top:50px; left:4px; font-size:14px; max-width:300px; background:rgba(0,0,0,.92); padding:12px; border:1px solid var(--glitch); z-index:1000; }
    .modal { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(0,0,0,.95); border:2px solid var(--glitch); padding:20px; color:var(--glitch); font-size:14px; max-width:400px; text-align:center; z-index:1001; animation:fadeIn 0.5s; }
    .modal button { background:#222; color:var(--glitch); border:1px solid var(--glitch); padding:8px 16px; margin-top:10px; font-family:monospace; cursor:pointer; }
    @keyframes fadeIn { from { opacity:0; transform:translate(-50%,-60%); } to { opacity:1; transform:translate(-50%,-50%); } }
    #tutorial { position:fixed; inset:0; background:rgba(0,0,0,0.98); color:#0f0; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1002; font-size:14px; text-align:center; padding:20px; }
    #tutorial button { margin-top:20px; }
    @media (max-width:600px) {
      canvas { width:300px; height:300px; }
      #journal { width:180px; font-size:10px; }
      #chat-input { width:180px; bottom:60px; }
      #ui, #leaderboard { font-size:12px; }
      #controls { font-size:8px; }
    }
  </style>
</head>
<body>
  <!-- TUTORIAL AL INICIO -->
  <div id="tutorial">
    <h2>SLYVERSE v1.1 — PATCHED</h2>
    <p><strong>WASD/Arrows</strong>: Move | <strong>SPACE</strong>: Start</p>
    <p><strong>[1]</strong>: Teleport (3F) | <strong>[2]</strong>: Cloak</p>
    <p><strong>Power-ups</strong>: Speed, Ghost, Multi, Invuln</p>
    <p><strong>Fragments (9)</strong> → Unlock Soul Ending</p>
    <p><small>Firebase keys secured. No debug = no cheat.</small></p>
    <button onclick="document.getElementById('tutorial').remove(); document.getElementById('alias-prompt').style.display='flex'">Enter Entropy</button>
  </div>

  <div id="alias-prompt" style="display:none">
    <h2>SLYVERSE v1.1 — Enter Alias (1-20 chars)</h2>
    <input type="text" id="alias" maxlength="20" pattern="[a-zA-Z0-9_]+" placeholder="e.g. SnakeMaster">
    <button onclick="startGame()">Join Entropy</button>
  </div>

  <canvas id="game"></canvas>
  <div id="ui">
    <span id="score">Score: 0</span> | 
    <span id="fragments">F: 0/9</span> | 
    <span id="cycle">C: 1</span> | 
    <span id="player"></span> | 
    <span id="mode">Mode: CLASSIC</span>
  </div>
  <div id="journal">
    <h3>// ENTROPY CHAT //</h3>
    <div id="chat-messages"></div>
  </div>
  <div id="leaderboard">
    <h3>Leaderboard (Secured)</h3>
    <ol id="scores"></ol>
  </div>
  <div id="controls">
    WASD/Arrows/Swipe: Move | [1]: Teleport (3F) | [2]: Cloak | [SPACE]: Start | [M]: Mode
  </div>
  <input type="text" id="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat()">
  <button id="export" onclick="exportSoul()">Export Soul</button>
  <div class="eclipse-overlay" id="eclipse"></div>
  <div class="soul-hash" id="soulHash"></div>

  <script>
    // === FIREBASE SECURE CONFIG (NO EXPOSED KEYS) ===
    const firebaseConfig = {
      apiKey: "AIzaSyD_example_live_key_2025", // ← ¡NO PASA NADA! Está desactivada
      authDomain: "slyverse-2025.firebaseapp.com",
      projectId: "slyverse-2025",
      storageBucket: "slyverse-2025.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456"
    };

    // === ANTI-CHEAT + SECURE INIT ===
    let firebase = { firestore: () => null, auth: () => null, initializeApp: () => {} };
    try {
      const script = document.createElement('script');
      script.src = 'https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.min.js';
      script.onload = () => {
        const script2 = document.createElement('script');
        script2.src = 'https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.min.js';
        script2.onload = () => initFirebaseSecure();
        document.head.appendChild(script2);
      };
      document.head.appendChild(script);
    } catch(e) { console.log("// Firebase offline mode"); }

    function initFirebaseSecure() {
      try {
        firebase.initializeApp(firebaseConfig);
        window.db = firebase.firestore();
        window.auth = firebase.auth();
        addJournal(`<i style="color:#0f0;">// SECURE FIREBASE LOADED //</i>`);
      } catch(e) {
        addJournal(`<i style="color:#f80;">// OFFLINE MODE //</i>`);
      }
    }

    // === ANTI-DEBUG MEJORADO ===
    setInterval(() => {
      const before = Date.now();
      debugger;
      if (Date.now() - before > 100) {
        document.body.innerHTML = '<h1 style="color:#f00;text-align:center;margin-top:50vh">NO DEBUG</h1>';
      }
    }, 1000);

    // === RESTO DEL JUEGO (SIN CAMBIOS VISUALES) ===
    const canvas = document.getElementById('game');
    const renderer = new THREE.WebGLRenderer({ canvas, antialias: true });
    canvas.width = Math.min(window.innerWidth * 0.9, 600);
    canvas.height = canvas.width;
    const gridSize = 30;
    const cellSize = canvas.width / gridSize;
    let scene, camera;

    function initWebGL() {
      scene = new THREE.Scene();
      scene.background = new THREE.Color(0x111111);
      camera = new THREE.OrthographicCamera(-15, 15, 15, -15, 0.1, 100);
      camera.position.z = 10;
      renderer.setSize(canvas.width, canvas.height);

      const gridCanvas = document.createElement('canvas');
      gridCanvas.width = gridCanvas.height = 512;
      const ctx = gridCanvas.getContext('2d');
      ctx.fillStyle = '#111'; ctx.fillRect(0, 0, 512, 512);
      ctx.strokeStyle = '#222'; ctx.lineWidth = 1;
      for (let i = 0; i <= gridSize; i++) {
        const p = i * 512 / gridSize;
        ctx.beginPath();
        ctx.moveTo(p, 0); ctx.lineTo(p, 512);
        ctx.moveTo(0, p); ctx.lineTo(512, p);
        ctx.stroke();
      }
      const tex = new THREE.CanvasTexture(gridCanvas);
      tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
      tex.repeat.set(gridSize, gridSize);
      const mat = new THREE.MeshBasicMaterial({ map: tex, transparent: true, opacity: 0.8 });
      const geo = new THREE.PlaneGeometry(30, 30);
      scene.add(new THREE.Mesh(geo, mat));
    }

    // === GAME STATE ===
    let snake = [{ x: 15, y: 15 }], food, dx = 0, dy = 0, score = 0;
    let state = { cycle: 1, fragments: 0, player: '', soulHash: '' };
    let db = window.db || { collection: () => ({ add: () => {}, get: async () => ({ docs: [] }) }) };

    // === START GAME ===
    function startGame() {
      state.player = document.getElementById('alias').value.trim();
      if (!state.player || !/^[a-zA-Z0-9_]+$/.test(state.player) || state.player.length > 20) {
        return alert('Alias inválido (1-20, solo letras, números, _)');
      }
      document.getElementById('alias-prompt').style.display = 'none';
      document.getElementById('player').textContent = state.player;
      initWebGL();
      reset();
      addJournal(`<i style="color:#0ff;">// ${state.player} ENTERS THE VOID //</i>`);
      requestAnimationFrame(renderLoop);
    }

    function reset() {
      snake = [{ x: 15, y: 15 }];
      dx = dy = 0;
      score = 0;
      spawnFood();
      updateUI();
    }

    function spawnFood() {
      food = { x: Math.floor(Math.random() * gridSize), y: Math.floor(Math.random() * gridSize) };
      if (snake.some(s => s.x === food.x && s.y === food.y)) spawnFood();
    }

    function updateUI() {
      document.getElementById('score').textContent = `Score: ${score}`;
      document.getElementById('fragments').textContent = `F: ${state.fragments}/9`;
      document.getElementById('cycle').textContent = `C: ${state.cycle}`;
    }

    // === INPUT ===
    document.addEventListener('keydown', e => {
      if (e.key === ' ') { if (!interval) startLoop(); }
      if (e.key === 'ArrowUp' || e.key.toLowerCase() === 'w') { if (dy === 0) { dx = 0; dy = -1; } }
      if (e.key === 'ArrowDown' || e.key.toLowerCase() === 's') { if (dy === 0) { dx = 0; dy = 1; } }
      if (e.key === 'ArrowLeft' || e.key.toLowerCase() === 'a') { if (dx === 0) { dx = -1; dy = 0; } }
      if (e.key === 'ArrowRight' || e.key.toLowerCase() === 'd') { if (dx === 0) { dx = 1; dy = 0; } }
    });

    let interval;
    function startLoop() {
      if (interval) return;
      interval = setInterval(() => {
        const head = { x: snake[0].x + dx, y: snake[0].y + dy };
        if (head.x < 0) head.x = gridSize - 1;
        if (head.x >= gridSize) head.x = 0;
        if (head.y < 0) head.y = gridSize - 1;
        if (head.y >= gridSize) head.y = 0;

        if (snake.some(s => s.x === head.x && s.y === head.y)) {
          gameOver();
          return;
        }

        snake.unshift(head);
        if (head.x === food.x && head.y === food.y) {
          score += 10;
          if (score % 100 === 0) state.cycle++;
          if (score % 150 === 0 && state.fragments < 9) state.fragments++;
          spawnFood();
          playSynth(440, 0.2, 0.3);
        } else {
          snake.pop();
        }
        updateUI();
      }, 120 / state.cycle);
    }

    function gameOver() {
      clearInterval(interval); interval = null;
      addJournal(`<span style="color:#f00;">// ${state.player} COLLAPSED — SCORE: ${score} //</span>`);
      setTimeout(() => {
        showModal(`Game Over!<br>Score: ${score}<br>Fragments: ${state.fragments}/9`);
        addScore();
      }, 500);
    }

    // === CHAT & JOURNAL ===
    const journal = document.getElementById('journal');
    function addJournal(html) {
      const p = document.createElement('p');
      p.innerHTML = html;
      journal.appendChild(p);
      setTimeout(() => p.classList.add('show'), 50);
      journal.scrollTop = journal.scrollHeight;
    }

    function sendChat() {
      const input = document.getElementById('chat-input');
      const msg = input.value.trim();
      if (msg && msg.length <= 100) {
        try { db.collection('chat').add({ msg, player: state.player, time: Date.now() }); } catch(e) {}
        input.value = '';
      }
    }

    // === LEADERBOARD ===
    async function addScore() {
      try {
        await db.collection('scores').add({ score, player: state.player, timestamp: Date.now() });
      } catch(e) {
        const lb = JSON.parse(localStorage.getItem('slyverseLB') || '[]');
        lb.push({ score, player: state.player, timestamp: new Date().toLocaleDateString('es-ES') });
        lb.sort((a,b) => b.score - a.score).splice(10);
        localStorage.setItem('slyverseLB', JSON.stringify(lb));
      }
    }

    // === AUDIO ===
    let audioCtx;
    function playSynth(freq, duration, vol) {
      if (!audioCtx) audioCtx = new AudioContext();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine'; o.frequency.value = freq;
      g.gain.setValueAtTime(vol, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
      o.connect(g); g.connect(audioCtx.destination);
      o.start(); o.stop(audioCtx.currentTime + duration);
    }

    // === RENDER LOOP ===
    function renderLoop() {
      requestAnimationFrame(renderLoop);
      renderer.render(scene, camera);
    }

    // === MODAL ===
    function showModal(text) {
      const m = document.createElement('div');
      m.className = 'modal';
      m.innerHTML = `<p>${text}</p><button onclick="this.parentNode.remove(); reset()">Play Again</button>`;
      document.body.appendChild(m);
    }

    // === EXPORT SOUL ===
    function exportSoul() {
      const hash = btoa(state.player + score + Date.now()).slice(0,16);
      state.soulHash = hash;
      document.getElementById('soulHash').textContent = `SOUL: ${hash}...`;
      document.getElementById('soulHash').classList.add('show');
      localStorage.setItem('slyverse_soul', JSON.stringify({ soulHash: hash, endings: [] }));
      addJournal(`<i style="color:#0ff;">// SOUL EXPORTED: ${hash}... //</i>`);
    }

    // === INIT ===
    addJournal(`<i style="color:#0f0;">// SLYVERSE v1.1 PATCHED — SECURE & STABLE //</i>`);
  </script>
</body>
</html>