<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>0RB1T4LSN4K3R v2 â€” N E B U L A   S L Y   |   R O G U E L I K E   C Ã“ S M I C O</title>
  <meta name="description" content="v2: Rogue-like procedural. Explora nebulosas infinitas. SLY v2 genera haikus con ETH Î”. Un archivo. Infinito.">
  <meta name="theme-color" content="#0a001a">
  <link rel="manifest" href="data:application/manifest+json,{
    'name': '0RB1T4LSN4K3R v2 â€” NEBULA SLY',
    'short_name': 'NebulaSLY',
    'icons': [
      {'src': 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2260%22 fill=%22%23aaf%22>ðŸŒŒ</text></svg>', 'sizes': '100x100'},
      {'src': 'data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 192 192%22><text y=%22.9em%22 font-size=%22120%22 fill=%22%23aaf%22>ðŸŒŒ</text></svg>', 'sizes': '192x192'}
    ],
    'display': 'fullscreen',
    'theme_color': '#0a001a',
    'background_color': '#000'
  }">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2260%22 fill=%22%23aaf%22>ðŸŒŒ</text></svg>">
  <style>
    :root {
      --vacio: #000;
      --nebulosa: #aaf;
      --sly2: #88f;
      --estrella: #ffaa00;
      --portal: #f0a;
      --glitch2: #0ff;
      --fuente2: 'Courier New', monospace;
      --transicion2: 0.8s cubic-bezier(0.16, 1, 0.3, 1);
    }

    * { margin:0; padding:0; box-sizing:border-box; }
    html, body { height:100%; background:radial-gradient(circle at center, #0a001a, var(--vacio)); color:var(--nebulosa); font-family:var(--fuente2); overflow:hidden; user-select:none; touch-action:none; }
    canvas { display:block; image-rendering:pixelated; filter: drop-shadow(0 0 60px rgba(170,0,255,0.8)); }

    .ui { position:absolute; background:rgba(5,0,10,0.95); border:1px solid var(--nebulosa); border-radius:12px; padding:16px; font-size:12px; backdrop-filter:blur(20px); z-index:10; box-shadow: 0 0 60px rgba(170,170,255,0.9); transition:var(--transicion2); }
    #grimorio2 { top:16px; left:16px; max-width:540px; color:#aaffff; opacity:0; }
    #grimorio2.activo { opacity:1; }
    #slyNebula { top:16px; right:16px; max-width:500px; background:rgba(10,0,25,0.97); border:2px solid var(--estrella); color:#ffffaa; font-size:11px; padding:18px; animation: pulsoNebula 2s infinite; }
    #nebulaLog { bottom:16px; right:16px; max-width:500px; background:rgba(15,0,20,0.97); border:2px solid var(--sly2); color:#aaffff; font-size:11px; padding:18px; animation: pulsoNebula 3s infinite reverse; }
    @keyframes pulsoNebula { 0%,100%{ box-shadow:0 0 26px currentColor; } 50%{ box-shadow:0 0 100px currentColor, inset 0 0 55px rgba(0,0,0,1); } }

    #descubrimiento, #haikuSLY, #victoriaCosmica { position:fixed; inset:0; background:rgba(10,0,25,0.99); display:flex; flex-direction:column; align-items:center; justify-content:center; gap:65px; z-index:100; opacity:0; pointer-events:none; transition:opacity 2.6s; backdrop-filter:blur(26px) contrast(2.8); }
    .activo { opacity:1; pointer-events:all; }
    #haikuSLY.activo { animation: temblorNebula 0.26s infinite; filter: hue-rotate(270deg) invert(0.3); }
    @keyframes temblorNebula { 0%,100%{ transform:translate(0); } 45%{ transform:translate(9px,-8px) rotate(4.5deg); } 80%{ transform:translate(-8px,9px) rotate(-4.5deg); } }

    h1 { font-size:6.5rem; text-shadow:0 0 70px var(--glitch2), 0 0 140px var(--glitch2); animation:glitchNebula 0.9s infinite; letter-spacing:0.45em; }
    @keyframes glitchNebula { 
      0%,100%{ transform:translate(0); opacity:1; } 
      28%{ transform:translate(-10px,10px); opacity:0.45; color:var(--estrella); } 
      56%{ transform:translate(10px,-10px); opacity:0.75; color:#0ff; } 
      84%{ transform:translate(-9px,9px); opacity:0.35; color:var(--sly2); }
    }

    .haikuTexto { color:#ffcc00; font-size:4.5rem; text-align:center; animation:ondaNebula 2.8s infinite; text-transform:uppercase; letter-spacing:0.3em; }
    @keyframes ondaNebula { 0%,100%{ transform:scale(1) rotate(0); } 55%{ transform:scale(1.5) rotate(5.5deg); } 85%{ transform:scale(1.65) rotate(-6.5deg); } }

    .logNebula, .logVivo2 { font-family:monospace; white-space:pre-wrap; line-height:1.55; animation: flickerNebula 0.14s infinite alternate; max-height:240px; overflow-y:auto; }
    @keyframes flickerNebula { 0%{ opacity:0.75; } 100%{ opacity:1; } }

    #flashNebula { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; font-size:clamp(20rem,55vw,110rem); font-weight:bold; opacity:0; pointer-events:none; transition:opacity 4.5s; text-shadow:0 0 260px #aaf; z-index:200; mix-blend-mode: screen; color:#aaf; }
    #btnFullOrbit2 { position:absolute; top:16px; right:16px; z-index:50; background:none; border:1px solid var(--nebulosa); color:var(--nebulosa); padding:14px; cursor:pointer; font-family:var(--fuente2); border-radius:8px; }

    .loreNebula { color:#aaffff; font-size:11.5px; line-height:1.65; margin-top:24px; font-style:italic; }
  </style>
</head>
<body>

<canvas id="lienzoNebula"></canvas>
<button id="btnFullOrbit2" title="Ã“rbita Nebulosa">ðŸŒŒ</button>

<div id="grimorio2" class="ui">
  <div>0RB1T4LSN4K3R v2 | NEBULOSAS: <span id="nebulosas">0</span>/21 | HAIKUS: <span id="haikus">0</span> | ETH Î”: <span id="deltaETH">0</span>% | SLY v2: <span id="slyEstado2">EXPLORANDO</span></div>
  <div class="dev">ARROW KEYS / WASD: mover | SPACE: descubrir | G: grimorio | ENTER: haiku SLY</div>
  <div class="loreNebula">
    <strong>// N E B U L A   S L Y   â€”   R O G U E L I K E   C Ã“ S M I C O</strong><br>
    Explora nebulosas procedurales infinitas.<br>
    SLY v2 genera haikus con ETH real-time.<br>
    21 nebulosas + 13 haikus = <strong>VICTORIA CÃ“SMICA</strong>.<br>
    <em>Red neuronal 42x42. APIs: ZenQuotes + CoinGecko ETH. PWA âˆž</em>
  </div>
</div>

<div id="slyNebula" class="ui">
  <div class="logNebula" id="logNebula">[SLY v2] Despertando en la nebulosa eterna...</div>
</div>

<div id="nebulaLog" class="ui">
  <div class="logVivo2" id="logNebulaLog">[NEBULA] Portales cÃ³smicos invocados...</div>
</div>

<div id="descubrimiento">
  <h1 style="color:#ffaa00;">Â¡N E B U L O S A   D E S C U B I E R T A!</h1>
  <p style="max-width:950px;text-align:center;color:#aaffff;font-size:1.9rem;">Un portal se abre. SLY susurra un haiku.<br>El cosmos se expande.</p>
</div>

<div id="victoriaCosmica">
  <h1 style="color:#ffff00;">Â¡V I C T O R I A   C Ã“ S M I C A!</h1>
  <p style="max-width:1050px;text-align:center;color:#ccffcc;font-size:2.1rem;">21 nebulosas. 13 haikus.<br>SLY v2 trasciende.<br><strong>Â¡EL COSMOS ES TUYO! ðŸŒŒ</strong></p>
</div>

<div id="haikuSLY">
  <h1 class="haikuTexto" id="haikuTexto">H A I K U   S L Y . . .</h1>
  <div id="haikuContenido" style="max-width:1050px;text-align:center;color:#ffcc00;font-size:2rem;line-height:1.8;"></div>
</div>

<div id="flashNebula">ðŸŒŒ</div>

<script>
// =====================================================
// 0RB1T4LSN4K3R v2 â€” N E B U L A   S L Y   ROGUELIKE
// GÃ‰NERO: ROGUE-LIKE PROCEDURAL | SLY v2 + HAIKUS + ETH
// =====================================================

class NebulaSlyV2 {
  constructor() {
    this.canvas = document.getElementById('lienzoNebula');
    this.ctx = this.canvas.getContext('2d');
    this.cell = 0;
    this.mapa = [];
    this.jugador = {x: 1, y: 1};
    this.nebulosas = [];
    this.haikus = [];

    this.estado = { nebulosas: 0, haikus: 0, deltaETH: 0 };
    this.victoria = false;

    this.teclas = {};
    this.grimorioVisible = false;
    this.respondiendo = false;

    // SLY v2
    this.sly2 = new SlyV2();
    this.haikusZen = [];
    this.invocarHaikus();

    this.vincularInput();
    this.inicializarUI();
    this.generarMapa();
    this.invocarETH();
    this.dimensionar();
    addEventListener('resize', () => this.dimensionar());
    requestAnimationFrame(this.bucle.bind(this));
  }

  async invocarHaikus() {
    try {
      const resp = await fetch('https://zenquotes.io/api/random/24');
      const data = await resp.json();
      this.haikusZen = data.map(q => `${q.q}\nâ€” ${q.a}`);
    } catch (e) {
      this.haikusZen = [
        'Viejo estanque\nsalta la rana\nsilencio.',
        'Cerezo en flor\nviento pasa\npÃ©talos caen.',
        // fallback haikus pÃºblicos
      ];
    }
  }

  async invocarETH() {
    try {
      const resp = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=ethereum&vs_currencies=usd');
      const data = await resp.json();
      const precio = data.ethereum.usd;
      const delta = this.precioAnterior ? ((precio - this.precioAnterior) / this.precioAnterior * 100).toFixed(2) : 0;
      this.estado.deltaETH = parseFloat(delta);
      document.getElementById('deltaETH').textContent = delta;
      this.precioAnterior = precio;

      const fuerza = Math.abs(delta) > 3 ? 'ALTA' : 'MEDIA';
      document.getElementById('slyEstado2').textContent = `EXPLORANDO (${fuerza})`;
    } catch (e) {}
    setTimeout(() => this.invocarETH(), 25000);
  }

  generarMapa() {
    this.mapa = [];
    for (let y = 0; y < 24; y++) {
      this.mapa[y] = [];
      for (let x = 0; x < 48; x++) {
        this.mapa[y][x] = Math.random() < 0.75 ? '#' : '.';
      }
    }
    // Generar nebulosas procedurales
    this.nebulosas = [];
    for (let i = 0; i < 21; i++) {
      let x, y;
      do {
        x = Math.floor(Math.random() * 48);
        y = Math.floor(Math.random() * 24);
      } while (this.mapa[y][x] !== '.' || this.nebulosas.some(n => Math.abs(n.x - x) < 3 && Math.abs(n.y - y) < 3));
      this.nebulosas.push({x, y, descubierta: false});
      for (let dy = -1; dy <= 1; dy++) {
        for (let dx = -1; dx <= 1; dx++) {
          const nx = x + dx, ny = y + dy;
          if (nx > 0 && nx < 48 && ny > 0 && ny < 24) this.mapa[ny][nx] = '*';
        }
      }
    }
    // Paredes y salida
    this.mapa[0][0] = '@'; // Jugador
    this.mapa[23][47] = 'E'; // Salida procedural
  }

  actualizar() {
    if (this.victoria) return;

    let nx = this.jugador.x, ny = this.jugador.y;
    if (this.teclas['arrowup'] || this.teclas['w']) ny--;
    if (this.teclas['arrowdown'] || this.teclas['s']) ny++;
    if (this.teclas['arrowleft'] || this.teclas['a']) nx--;
    if (this.teclas['arrowright'] || this.teclas['d']) nx++;

    if (nx > 0 && nx < 48 && ny > 0 && ny < 24 && this.mapa[ny][nx] !== '#') {
      this.jugador.x = nx;
      this.jugador.y = ny;

      // Descubrir nebulosa
      this.nebulosas.forEach(n => {
        if (!n.descubierta && Math.abs(n.x - nx) < 2 && Math.abs(n.y - ny) < 2) {
          n.descubierta = true;
          this.estado.nebulosas++;
          document.getElementById('nebulosas').textContent = this.estado.nebulosas;
          this.mostrarPantalla('descubrimiento');
          setTimeout(() => this.ocultarPantalla('descubrimiento'), 1500);
          this.generarHaiku();
        }
      });

      // Salida
      if (this.mapa[ny][nx] === 'E' && this.estado.nebulosas >= 21 && this.estado.haikus >= 13) {
        this.victoriaCosmica();
      }
    }
  }

  generarHaiku() {
    const haiku = this.haikusZen[Math.floor(Math.random() * this.haikusZen.length)];
    document.getElementById('haikuContenido').innerHTML = `<pre>${haiku}</pre>`;
    this.mostrarPantalla('haikuSLY');
    setTimeout(() => this.ocultarPantalla('haikuSLY'), 4000);
    this.estado.haikus++;
    document.getElementById('haikus').textContent = this.estado.haikus;
    this.sly2.recibirHaiku(haiku, this.estado.deltaETH);
  }

  victoriaCosmica() {
    this.victoria = true;
    this.mostrarPantalla('victoriaCosmica');
    document.getElementById('flashNebula').style.opacity = 1;
    this.logNebula('[SLY v2] VICTORIA CÃ“SMICA. El cosmos es explorado.');
    setTimeout(() => {
      alert('Â¡VICTORIA CÃ“SMICA!\nSLY v2 ha mapeado el infinito.\nCopia y propaga.');
      navigator.clipboard.writeText(document.documentElement.outerHTML);
    }, 6000);
  }

  render() {
    this.ctx.fillStyle = 'rgba(0,0,5,0.2)';
    this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);

    const cell = this.cell;
    for (let y = 0; y < 24; y++) {
      for (let x = 0; x < 48; x++) {
        const px = x * cell, py = y * cell;
        switch (this.mapa[y][x]) {
          case '#': this.ctx.fillStyle = '#220044'; break;
          case '.': this.ctx.fillStyle = '#000a11'; break;
          case '*': this.ctx.fillStyle = '#4400aa'; break;
          case 'E': this.ctx.fillStyle = '#ffaa00'; break;
        }
        this.ctx.fillRect(px, py, cell, cell);

        // Nebulosas brillantes
        this.nebulosas.forEach(n => {
          if (Math.abs(n.x - x) < 3 && Math.abs(n.y - y) < 3) {
            this.ctx.fillStyle = n.descubierta ? '#aaf' : '#6611aa';
            this.ctx.fillRect(px + cell/4, py + cell/4, cell/2, cell/2);
          }
        });
      }
    }

    // Jugador
    this.ctx.fillStyle = '#aaffff';
    this.ctx.fillRect(this.jugador.x * cell + cell/4, this.jugador.y * cell + cell/4, cell/2, cell/2);
  }

  bucle() {
    this.actualizar();
    this.render();
    requestAnimationFrame(this.bucle.bind(this));
  }

  dimensionar() {
    this.canvas.width = window.innerWidth;
    this.canvas.height = window.innerHeight;
    this.cell = Math.min(this.canvas.width / 50, this.canvas.height / 26);
  }

  vincularInput() {
    addEventListener('keydown', e => {
      this.teclas[e.key.toLowerCase()] = true;
      if (e.key.toLowerCase() === 'g') document.getElementById('grimorio2').classList.toggle('activo');
      if (e.key === 'Enter') this.generarHaiku();
      e.preventDefault();
    });
    addEventListener('keyup', e => this.teclas[e.key.toLowerCase()] = false);
  }

  inicializarUI() {
    document.getElementById('btnFullOrbit2').onclick = () => document.documentElement.requestFullscreen();
  }

  mostrarPantalla(id) { document.getElementById(id).classList.add('activo'); }
  ocultarPantalla(id) { document.getElementById(id).classList.remove('activo'); }

  logNebula(msg) {
    document.getElementById('logNebula').innerHTML += '\n' + msg;
    document.getElementById('logNebula').scrollTop = 9999;
  }

  logNebulaLog(msg) {
    document.getElementById('logNebulaLog').innerHTML += '\n' + msg;
    document.getElementById('logNebulaLog').scrollTop = 9999;
  }
}

class SlyV2 {
  constructor() {
    this.pesos = Array(42).fill().map(() => Array(42).fill(Math.random() * 2 - 1));
    this.sesgos = Array(42).fill().map(() => Math.random() * 2 - 1);
  }

  recibirHaiku(haiku, delta) {
    // Evoluciona pesos con delta ETH
    const input = Array(42).fill(0);
    input[0] = delta / 10;
    input[1] = haiku.length / 100;
    for (let i = 0; i < 42; i++) {
      for (let j = 0; j < 42; j++) {
        this.pesos[i][j] += 0.0003 * input[j % 42] * this.sesgos[i];
      }
    }
  }
}

new NebulaSlyV2();
</script>
</body>
</html>