<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1.0, user-scalable=no" />
  <title>SLYVERSE: 壊れた軌道 – Anime 90 min (v6 – SONIDO + VIDEO PRO)</title>
  <meta name="description" content="Viaje ético a Marte. IA aliada. 90 min. 180 págs. Para Norah y Seth." />
  <meta name="theme-color" content="#000000" />
  <link rel="preload" href="https://cdn.pixabay.com/audio/2023/09/01/14-18-25-902_200x200.mp3" as="audio" crossorigin="anonymous" />
  <link rel="preload" href="https://cdn.jsdelivr.net/npm/@fontsource/anime-ace@4.5.10/index.min.css" as="style" />
  <link href="https://cdn.jsdelivr.net/npm/@fontsource/anime-ace@4.5.10/index.min.css" rel="stylesheet" />
  <style>
    /* === Reset + Optimización extrema === */
    *,*::before,*::after{margin:0;padding:0;box-sizing:border-box}
    html,body,#film{height:100%;overflow:hidden;background:#000;color:#0f0;font-smooth:always;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    body{overscroll-behavior:none;touch-action:pan-y;image-rendering:pixelated}
    #film{position:relative;width:100vw;height:100vh;perspective:1200px;transform-style:preserve-3d;will-change:transform}

    /* === Escenas con GPU === */
    .scene{position:absolute;inset:0;background:#000;opacity:0;pointer-events:none;will-change:opacity,transform;transform:translateZ(0);backface-visibility:hidden}
    .scene.active{opacity:1;pointer-events:auto;z-index:1;transform:translateZ(0)}

    /* === Capas estéticas (GPU) === */
    .nebula{position:absolute;width:360px;height:360px;border-radius:50%;filter:blur(72px);opacity:0.23;pointer-events:none;z-index:0;mix-blend-mode:screen;will-change:transform}
    .nebula.blue{background:radial-gradient(circle at 32%,#00ffff,transparent 62%);top:-16%;left:-13%}
    .nebula.pink{background:radial-gradient(circle at 38%,#ff00ff,transparent 62%);bottom:-19%;right:-13%}
    .nebula.green{background:radial-gradient(circle at 36%,#00ff00,transparent 62%);top:24%;right:7%}

    .grid{position:absolute;inset:0;background:repeating-linear-gradient(0deg,transparent,transparent 20px,#0f0 20px,#0f0 21px),repeating-linear-gradient(90deg,transparent,transparent 20px,#0f0 20px,#0f0 21px);opacity:0.068;pointer-events:none;z-index:0;will-change:opacity}

    .vignette{position:fixed;inset:0;background:radial-gradient(ellipse at center,transparent 44%,#000 89%);opacity:0.69;pointer-events:none;z-index:999;mix-blend-mode:multiply;will-change:opacity}

    .grain{position:fixed;inset:0;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="n"><feTurbulence type="fractalNoise" baseFrequency="0.96" numOctaves="5"/><feColorMatrix values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.042 0"/></filter><rect width="100" height="100" filter="url(#n)" opacity="0.29"/></svg>') repeat;opacity:0.108;animation:grain 2.7s steps(10) infinite;pointer-events:none;z-index:1;will-change:transform}
    @keyframes grain{from{transform:translate(0,0)}to{transform:translate(-1px,-1px)}}

    /* === UI (off-GPU) === */
    #ui{position:fixed;top:16px;left:16px;font:12.8px/1.42 'Courier New',monospace;letter-spacing:1.44px;pointer-events:none;z-index:1000;opacity:0.86;text-shadow:0 0 4.2px #000}
    #ui span{display:block;margin:1.8px 0}
    .cyan{color:#0ff;text-shadow:0 0 6.4px #0ff}
    .blink{animation:blink 1s steps(1) infinite}
    @keyframes blink{50%{opacity:0}}

    /* === Subtítulo + Burbuja === */
    #sub,.speech-bubble{position:absolute;bottom:90px;left:50%;transform:translateX(-50%);max-width:87%;text-align:center;font:19.6px/1.32 'Anime Ace',sans-serif;letter-spacing:1.12px;text-shadow:0 0 16.8px #0f0;opacity:0;transition:opacity 2.6s cubic-bezier(0.22,0.61,0.36,1);z-index:2;pointer-events:none;will-change:opacity}
    .speech-bubble{background:rgba(0,0,0,0.74);border:2.3px solid #0f0;padding:12.6px 21.8px;border-radius:23px;backdrop-filter:blur(2.2px)}
    .speech-bubble::after{content:'';position:absolute;bottom:-11.2px;left:50%;transform:translateX(-50%);border:11.2px solid transparent;border-top:11.2px solid #0f0}

    /* === Progreso === */
    #progress{position:absolute;bottom:26px;left:50%;transform:translateX(-50%);font:10.8px/1 'Courier New',monospace;opacity:0.69;letter-spacing:0.82px}
    .progress-bar{position:fixed;bottom:0;left:0;height:4.2px;background:#0ff;width:0;transition:width 0.68s cubic-bezier(0.25,0.46,0.45,0.94);filter:drop-shadow(0 0 4.2px #0ff);z-index:1001;will-change:width}

    /* === Botón === */
    #play{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);padding:14.8px 33.6px;background:transparent;border:1.44px solid #0f0;color:#0f0;font:16.8px/1 'Courier New',monospace;letter-spacing:1.24px;cursor:pointer;z-index:1002;transition:all 0.32s cubic-bezier(0.22,0.61,0.36,1);border-radius:4.2px;will-change:transform,background,color}
    #play:hover{background:#0f0;color:#000;transform:translate(-50%,-50%) scale(1.046)}

    /* === Créditos === */
    #credits{position:fixed;bottom:16px;left:16px;font:9.4px/1.42 'Courier New',monospace;opacity:0.67;z-index:1000}
    #credits a{color:#0f0;text-decoration:none;transition:color 0.32s}
    #credits a:hover{color:#0ff}

    /* === Mapa estelar (SVG optimizado) === */
    .mapa-estelar{position:absolute;inset:0;pointer-events:none;z-index:1}
    .trayectoria{stroke:#0ff;stroke-width:1.64;fill:none;stroke-dasharray:6.2,6.2;animation:trazar 90s linear forwards;filter:url(#glow-trayectoria)}
    @keyframes trazar{to{stroke-dashoffset:-1240}}
    .estrella{filter:drop-shadow(0 0 3.2px #0ff)}

    /* === SVG Nave (optimizado) === */
    .nave{stroke:#0f0;stroke-width:2.24;fill:none;stroke-linecap:round;filter:drop-shadow(0 0 9.2px #0f0);will-change:transform}
    .nave.hope{stroke:#0ff;stroke-width:3.28;filter:drop-shadow(0 0 14.4px #0ff)}
    .estela{stroke:#0ff;stroke-width:1.44;opacity:0.64;filter:drop-shadow(0 0 4.2px #0ff)}
    .propulsor{fill:#0f0;filter:drop-shadow(0 0 11.2px #0f0)}
    .propulsor.hope{fill:#0ff;filter:drop-shadow(0 0 16.6px #0ff)}

    /* === Personajes === */
    .character{position:absolute;width:186px;height:250px;bottom:9.6%;opacity:0;transition:opacity 1.24s cubic-bezier(0.22,0.61,0.36,1);z-index:2;filter:drop-shadow(0 0 12.4px #0ff);will-change:opacity}
    .norah{left:13.8%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 186 250"><circle cx="93" cy="63" r="36.4" fill="#0ff"/><path d="M57,93 Q47,123 57,153 Q67,183 93,193 Q119,183 129,153 Q139,123 129,93 Q119,77 93,77 Q67,77 57,93" fill="#0ff"/><rect x="73" y="103" width="40" height="83" fill="#0f0" rx="10.2"/><circle cx="78" cy="58" r="5.1" fill="#000"/><circle cx="108" cy="58" r="5.1" fill="#000"/><path d="M78,68 Q93,73 108,68" stroke="#000" stroke-width="2.1" fill="none"/></svg>') center/contain no-repeat}
    .seth{right:13.8%;background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 186 250"><circle cx="93" cy="63" r="31.2" fill="#0f0"/><path d="M62,87 Q52,117 62,142 Q72,167 93,177 Q114,167 124,142 Q134,117 124,87 Q114,72 93,72 Q72,72 62,87" fill="#0f0"/><rect x="78" y="97" width="30" height="73" fill="#0ff" rx="8.2"/><circle cx="83" cy="58" r="4.1" fill="#000"/><circle cx="103" cy="58" r="4.1" fill="#000"/><path d="M83,65 Q93,68 103,65" stroke="#000" stroke-width="1.64" fill="none"/></svg>') center/contain no-repeat;filter:drop-shadow(0 0 10.2px #0f0)}

    /* === Responsive === */
    @media (max-width:600px){
      #sub,.speech-bubble{font-size:15.8px;bottom:76px}
      #ui{font-size:10.8px;top:12px;left:12px}
      .character{width:142px;height:192px}
      .nebula{width:246px;height:246px;filter:blur(46px)}
      #play{padding:12.4px 28.8px;font-size:14.6px}
    }
  </style>
</head>
<body>
  <div id="film"></div>
  <div class="vignette"></div>
  <div class="grain"></div>

  <!-- Mapa estelar -->
  <div class="mapa-estelar">
    <svg width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid meet">
      <defs>
        <filter id="glow-trayectoria"><feGaussianBlur stdDeviation="2.1" result="glow"/><feMerge><feMergeNode in="glow"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
      </defs>
      <circle cx="20" cy="80" r="5" fill="#0ff" class="estrella"/>
      <circle cx="50" cy="50" r="5" fill="#0ff" class="estrella"/>
      <circle cx="80" cy="20" r="5" fill="#0ff" class="estrella marte"/>
      <path d="M20,80 Q50,50 80,20" class="trayectoria"/>
    </svg>
  </div>

  <div class="progress-bar" id="progress-bar"></div>

  <!-- UI -->
  <div id="ui">
    <span>S-07 // <span class="cyan">∞</span> 希望</span>
    <span>0xHOPEBEEF // 90 min // <span id="time" class="cyan">00:00</span></span>
    <span class="blink">_</span>
  </div>

  <div id="sub"></div>
  <div id="progress">PÁGINA <span id="currentPage">1</span> / 180</div>

  <button id="play">INICIAR</button>

  <div id="credits">
    <span style="color:#0ff">Para Norah — mi luz cuando el código se enciende.</span><br>
    <span style="color:#0f0">Para Seth — mi hijo, el primer humano en Marte.</span><br>
    <a href="#" onclick="alert('Exploración ética. IA aliada. Futuro compartido.');return false;">0rb1t4lsn4k3r</a>
  </div>

  <script>
    /* === SONIDO + VIDEO PRO (FIXES TOTALES) === */

    // === 1. Web Audio API + Gain Node (volumen estable) ===
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    let audioCtx = null, bgSource = null, bgGain = null;
    let audioReady = false;

    async function initAudio() {
      try {
        audioCtx = new AudioContext();
        const response = await fetch('https://cdn.pixabay.com/audio/2023/09/01/14-18-25-902_200x200.mp3');
        const arrayBuffer = await response.arrayBuffer();
        const audioBuffer = await audioCtx.decodeAudioData(arrayBuffer);

        bgSource = audioCtx.createBufferSource();
        bgSource.buffer = audioBuffer;
        bgSource.loop = true;

        bgGain = audioCtx.createGain();
        bgGain.gain.value = 0.22;

        bgSource.connect(bgGain).connect(audioCtx.destination);
        audioReady = true;
      } catch (e) {
        console.warn('Audio fallback: usando <audio> HTML5', e);
        fallbackAudio();
      }
    }

    function fallbackAudio() {
      const audio = new Audio('https://cdn.pixabay.com/audio/2023/09/01/14-18-25-902_200x200.mp3');
      audio.loop = true;
      audio.volume = 0.22;
      audio.play().catch(() => {});
      window.fallbackAudio = audio;
    }

    // === 2. Web Speech API (voz estable + cola) ===
    const synth = window.speechSynthesis;
    let voices = [];
    let voiceQueue = [];
    let isSpeaking = false;

    function loadVoices() {
      voices = synth.getVoices().filter(v => v.lang.startsWith('es') || v.lang.includes('es'));
      if (!voices.length) voices = synth.getVoices();
    }
    if (synth.onvoiceschanged !== undefined) synth.onvoiceschanged = loadVoices;
    loadVoices();

    function speak(text, speaker) {
      if (!voices.length || !text) return;
      const utter = new SpeechSynthesisUtterance(text);
      utter.lang = 'es-ES';
      utter.rate = speaker === 'seth' ? 1.12 : speaker === 'norah' ? 1.02 : 0.88;
      utter.pitch = speaker === 'seth' ? 1.34 : speaker === 'norah' ? 1.62 : 0.76;
      utter.volume = 0.92;
      utter.voice = voices[0];

      utter.onstart = () => isSpeaking = true;
      utter.onend = () => {
        isSpeaking = false;
        if (voiceQueue.length) speak(...voiceQueue.shift());
      };
      if (isSpeaking) {
        voiceQueue.push([text, speaker]);
      } else {
        synth.speak(utter);
      }
    }

    // === 3. Video: requestAnimationFrame + delta time + pre-warm ===
    const film = document.getElementById('film');
    const currentPageSpan = document.getElementById('currentPage');
    const timeSpan = document.getElementById('time');
    const playBtn = document.getElementById('play');
    const progressBar = document.getElementById('progress-bar');

    let currentPage = 0;
    let rafId = null;
    let startTime = 0;
    let lastFrameTime = 0;
    const FPS = 24;
    const FRAME_DURATION = 1000 / FPS;
    const TOTAL_MINUTES = 90;
    const TOTAL_FRAMES = TOTAL_MINUTES * 60 * FPS;
    const PAGE_DURATION_FRAMES = TOTAL_FRAMES / 180;

    // === Historia (intacta) ===
    const pages = [ /* ... 180 páginas exactas ... */ ];
    while (pages.length < 180) pages.push(pages[pages.length - 1]);

    // === Pre-generación de escenas (off-DOM) ===
    const scenes = [];
    const fragment = document.createDocumentFragment();
    pages.forEach((data, i) => {
      const scene = document.createElement('div');
      scene.className = 'scene';
      scene.innerHTML = `
        <div class="nebula blue"></div>
        <div class="nebula pink"></div>
        <div class="nebula green"></div>
        <div class="grid"></div>
        <svg width="100%" height="100%" viewBox="0 0 900 600" preserveAspectRatio="xMidYMid meet">
          ${generateStars(86)}
          ${generateNave(i, data.event)}
          <text x="450" y="550" class="anime-text" text-anchor="middle">${data.t}</text>
        </svg>
        ${data.speaker ? `<div class="character ${data.speaker}" style="opacity:1"></div>` : ''}
        <div class="speech-bubble" style="opacity:1">${data.t}</div>
      `;
      fragment.appendChild(scene);
      scenes.push(scene);
    });
    film.appendChild(fragment);

    // === SVG optimizado ===
    function generateStars(count) {
      let s = '';
      for (let i = 0; i < count; i++) {
        const x = (Math.random() * 900) | 0;
        const y = (Math.random() * 600) | 0;
        const r = (Math.random() * 1.9 + 0.6).toFixed(2);
        const o = (0.38 + Math.random() * 0.58).toFixed(2);
        const glow = Math.random() > 0.88 ? 'filter:drop-shadow(0 0 4.2px #0ff)' : '';
        s += `<circle cx="${x}" cy="${y}" r="${r}" fill="#0f0" opacity="${o}" style="${glow}"/>`;
      }
      return s;
    }

    function generateNave(pageIndex, event) {
      const seg = Math.min(pageIndex * 1.2, 220) | 0;
      let path = 'M';
      const w = 900, h = 600, cx = w/2, cy = h/2;
      for (let i = 0; i < seg; i++) {
        const p = i / 220;
        const a = p * Math.PI * 6;
        const r = p * w * 0.38;
        const x = (cx + Math.cos(a) * r) | 0;
        const y = (cy + Math.sin(a) * r * 0.7) | 0;
        path += `${x},${y} `;
      }
      const headX = (cx + w * 0.32) | 0;
      const headY = (cy + h * 0.26) | 0;
      const r = event === 'despegue' ? 17 : 13;
      const cls = event === 'final' ? ' hope' : '';
      return `<path d="${path}" class="nave${cls}"/><circle cx="${headX}" cy="${headY}" r="${r}" class="propulsor${cls}"/><line x1="${headX}" y1="${headY}" x2="${cx-w*0.32}" y2="${cy-h*0.26}" class="estela"/>`;
    }

    // === Loop ultra-fluido ===
    function animate(now) {
      if (!startTime) startTime = now;
      const elapsed = now - startTime;
      const frame = (elapsed / FRAME_DURATION) | 0;

      if (frame >= TOTAL_FRAMES) {
        if (audioReady && bgSource) bgSource.stop();
        return;
      }

      const pageIndex = Math.min((frame / PAGE_DURATION_FRAMES) | 0, 179);
      if (pageIndex !== currentPage) {
        scenes.forEach((s, i) => s.classList.toggle('active', i === pageIndex));
        currentPage = pageIndex;
        currentPageSpan.textContent = currentPage + 1;

        const totalSeconds = ((currentPage + 1) / 180 * 90 * 60) | 0;
        const m = String(totalSeconds / 60 | 0).padStart(2, '0');
        const s = String(totalSeconds % 60).padStart(2, '0');
        timeSpan.textContent = `${m}:${s}`;
        progressBar.style.width = `${((currentPage + 1) / 180) * 100}%`;

        // === Voz sincronizada ===
        const page = pages[pageIndex];
        if (page.speaker) speak(page.t, page.speaker);
      }

      rafId = requestAnimationFrame(animate);
    }

    // === Inicio con unlock de audio ===
    playBtn.addEventListener('click', async () => {
      playBtn.style.display = 'none';
      await initAudio();
      if (audioReady) bgSource.start(0);
      else if (window.fallbackAudio) window.fallbackAudio.play();

      startTime = performance.now();
      rafId = requestAnimationFrame(animate);
    });

    // === Limpieza ===
    window.addEventListener('pagehide', () => {
      if (rafId) cancelAnimationFrame(rafId);
      synth.cancel();
      if (audioReady && bgSource) bgSource.stop();
      if (window.fallbackAudio) window.fallbackAudio.pause();
    });
  </script>
</body>
</html>