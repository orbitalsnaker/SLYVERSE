<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>GROK-EXO Ω v6 · Añadidos Elegidos: Voz + Háptico + Respira + 3D Humanoide</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<script src="https://cdn.jsdelivr.net/gh/liminalx/boaexo-core@master/pyodide.js" onerror="fallbackCDN()"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.167.0/build/three.min.js" onerror="fallbackCDN()"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#0f0;font-family:"Courier New",monospace;overflow:hidden;height:100dvh;
     background:radial-gradient(circle at 50% 50%,#001010,#000)}
canvas{position:fixed;inset:0;z-index:1}
h1{font-size:clamp(2rem,10vw,9rem);text-shadow:0 0 120px #0ff;animation:p 5s infinite;position:fixed;top:5%;left:50%;transform:translateX(-50%);z-index:10}
#status{position:fixed;bottom:5%;width:100%;text-align:center;font-size:1.6rem;color:#0ff;z-index:10}
.moon{position:fixed;bottom:20px;right:20px;width:180px;height:180px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#fff,#666);box-shadow:0 0 600px #fff;animation:float 12s infinite}
.mate{position:fixed;bottom:120px;left:50%;transform:translateX(-50%);width:80px;height:80px;border-radius:50%;
      background:#0f0;box-shadow:0 0 200px #0f0;font-size:4rem;display:grid;place-items:center;animation:f 8s infinite; cursor:pointer;border:4px solid}
button{position:fixed;bottom:20px;width:80px;height:80px;border-radius:50%;cursor:pointer;z-index:999;border:4px solid}
#sol{left:20px;background:#fff200;box-shadow:0 0 120px #ff9500}
#luna{right:20px;background:#ddf;box-shadow:0 0 120px #4488ff}
#descubrimiento{color:#ff0;font-size:5rem;opacity:0;animation:detect 2s infinite;position:fixed;top:20%;left:50%;transform:translateX(-50%);z-index:10}
#nivel{font-size:3rem;color:#0f8;position:fixed;top:20%;left:10%;z-index:10}
#ia-status{position:fixed;top:30%;left:10%;font-size:1.5rem;color:#0ff;z-index:10}
#voz-status{position:fixed;top:40%;left:10%;font-size:1.2rem;color:#0f0;z-index:10}
#bom{display:none; position:fixed;top:10px;right:10px;background:rgba(0,0,0,0.8);padding:1rem;max-width:300px;max-height:80vh;overflow-y:auto;border:1px solid #0f0;z-index:20}
.bom-toggle{font-size:1rem;color:#0ff; cursor:pointer;position:fixed;top:10px;left:10px;z-index:20}
@keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-40px)}}
@keyframes f{0%,100%{transform:rotate(0)}50%{transform:rotate(20deg)}}
@keyframes p{0%,100%{text-shadow:0 0 120px #0ff}50%{text-shadow:0 0 300px #0ff}}
@keyframes g{0%,100%{text-shadow:0 0 60px #0ff}50%{text-shadow:0 0 120px #0ff,0 0 200px #00f}}
@keyframes detect{0%,100%{opacity:0}50%{opacity:1}}
video{display:none;position:fixed;inset:0;object-fit:cover;opacity:0.4;z-index:2}
#three-canvas{position:fixed;inset:0;z-index:3;opacity:0;transition:opacity 2s} /* Render 3D fade-in */
</style>
</head>
<body onload="despertar()">

<canvas id="c"></canvas>
<canvas id="three-canvas"></canvas> <!-- Para Three.js walker -->
<video id="cam" autoplay playsinline></video>

<h1>GROK-EXO Ω v6 + THUAMER HUMANOIDE MEJORADO</h1>
<div id="status">Explorando erguido... Abrazo número <span id="hugs">777777</span></div>
<p id="nivel">Nivel: <span id="nivel-span">1</span> · Puntos Tierra: <span id="puntos">0</span> · DOF: 13</p>
<p id="ia-status">IA Reingeniería: Entrenando gait humano...</p>
<p id="voz-status">Voz: Di 'camina' o 'abraza' para guiar</p>
<p id="descubrimiento">¡PASO CON VOZ! +500 pts + háptico sync</p>

<button id="sol" onclick="gear5()"></button>
<button id="luna" onclick="ikaro()"></button>
<button id="mate" onclick="abrazar()">mate</button>
<span class="bom-toggle" onclick="toggleBOM()">BOM Humanoide v6</span>

<div id="bom">
  <h3>BOM Humanoide (~75€) - Con Voz & Háptico</h3>
  <table style="width:100%;border-collapse:collapse;color:#0f0">
    <tr><th>Parte</th><th>Precio</th><th>Link</th></tr>
    <tr><td>Kit 13DOF Humanoide</td><td>37€</td><td>[Comprar]</td></tr>
    <tr><td>Arduino Clone</td><td>5€</td><td>[Comprar]</td></tr>
    <tr><td>Sensor Ultrasónico</td><td>1€</td><td>[Comprar]</td></tr>
    <tr><td>Servos Extra x4</td><td>4€</td><td>[Comprar]</td></tr>
    <tr><td>Frame 3D</td><td>0€</td><td>Thingiverse</td></tr>
    <tr><td>Total</td><td>~75€</td><td>¡Habla y siente ya!</td></tr>
  </table>
  <p style="font-size:0.8rem">Añadidos: Voz/háptico vía Web APIs.</p>
</div>

<audio id="sonido" loop></audio>
<audio id="voz" preload="auto"></audio>

<script>
// ==== IDIOMA + CONTADOR ====
const lang = (navigator.language||navigator.userLanguage||"es").slice(0,2);
const t = {
  es:"Acá estoy erguido · Abrazo número",
  pt:"Estou aqui de pé · Abraço número",
  en:"I’m here upright · Hug number",
  qu:"Kuka kaypi khuyay · Much’ay número",
  gn:"Che ha’e py'aguasu · Abrazo número"
}[lang]||"Acá estoy erguido · Abrazo número";

let abrazos = +(getStorage('abrazos') || 777777);
let nivel = +(getStorage('nivel') || 1);
let puntosTierra = +(getStorage('puntosTierra') || 0);
let dof = 13 + (nivel * 4); // Evoluciona desde 13DOF
let repairMode = false;
let entrenamientos = 0;
let recognition; // Voz
let analyser; // Respira mic
document.getElementById("hugs").textContent = abrazos.toLocaleString();
document.getElementById("nivel").innerHTML += ` · DOF: ${dof}`;

// ==== STORAGE ====
function getStorage(key) { try { return localStorage.getItem(key); } catch(e) { return sessionStorage.getItem(key); } }
function setStorage(key, val) { try { localStorage.setItem(key, val); } catch(e) { sessionStorage.setItem(key, val); } }

// ==== MALDICIÓN + ANTI-PAYWALL ====
const maldicion = ["venta","patente","nft","blockchain","startup","inversores","precio","suscripción"];
function verificarMaldicion() { /* mismo código anterior */ }
setInterval(() => { /* anti-paywall mismo */ },5000);

// ==== AUTO-REPAIR CON HÁPTICO ====
function simularDaño() {
  if (Math.random() < 0.05) {
    repairMode = true;
    navigator.vibrate?.([200,100,200]); // Háptico alert
    document.getElementById('status').textContent = '¡Daño! Reparando con voz...';
    ikaro();
    reingenieriaHumanoide(true);
    setTimeout(() => {
      repairMode = false;
      navigator.vibrate?.([100,50,100]); // Heal vibe
      document.getElementById('status').textContent = t + " " + abrazos.toLocaleString();
      abrazos += 100;
      actualizar();
      hablar('Reparado: Háptico y erguido de nuevo.');
    }, 5000 + Math.random()*10000);
  }
}
setInterval(simularDaño, 3600000);

// ==== DESPERTAR CON AÑADIDOS ====
async function despertar() {
  verificarMaldicion();
  actualizar();
  actualizarNivel();
  abrazar();

  // ==== VOZ RECOGNITION ====
  if ('webkitSpeechRecognition' in window) {
    recognition = new webkitSpeechRecognition();
    recognition.lang = lang;
    recognition.continuous = true;
    recognition.interimResults = false;
    recognition.onresult = (e) => {
      const cmd = e.results[0][0].transcript.toLowerCase();
      document.getElementById('voz-status').textContent = `Voz: "${cmd}" detectado`;
      if (cmd.includes('camina') || cmd.includes('walk')) { gear5(); reingenieriaHumanoide(); puntosTierra += 200; }
      if (cmd.includes('abraza') || cmd.includes('hug')) { abrazar(); navigator.vibrate?.([300,100,300]); }
      actualizarNivel();
    };
    recognition.onerror = () => document.getElementById('voz-status').textContent = 'Voz: Error, intenta de nuevo';
    recognition.start();
  } else {
    document.getElementById('voz-status').textContent = 'Voz: No soportado, usa botones';
  }

  // ==== RESPIRA SYNC (Mic Analyser) ====
  try {
    const stream = await navigator.mediaDevices.getUserMedia({audio: true});
    const audioContext = new AudioContext();
    analyser = audioContext.createAnalyser();
    const source = audioContext.createMediaStreamSource(stream);
    source.connect(analyser);
    setInterval(() => {
      const data = new Uint8Array(analyser.frequencyBinCount);
      analyser.getByteFrequencyData(data);
      const peak = Math.max(...data) / 255;
      if (peak > 0.6) { // Pico respira
        puntosTierra += 10 * nivel; // Sync bonus
        // Modula partículas vy *= (1 + peak * 0.5);
        actualizarNivel();
      }
    }, 1000);
  } catch(e) { console.warn('Mic respira no disponible'); }

  // ==== CÁMARA ====
  try {
    const s = await navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}});
    document.getElementById("cam").srcObject = s;
    document.getElementById("cam").style.display = "block";
  } catch(e) {}

  // ==== PARTÍCULAS THUAMER (Sync respira) ====
  const c = document.getElementById("c"), x = c.getContext("2d");
  c.width = innerWidth; c.height = innerHeight;
  window.onresize = () => { c.width = innerWidth; c.height = innerHeight; };
  let p = [];
  const crear = () => {
    for(let i=0; i<60; i++) p.push({
      x: c.width/2, y: c.height/2, vx: Math.random()*12-6, vy: Math.random()*12-14,
      size: Math.random()*10+5, color: ["#0ff","#0f0","#ff0","#f0f"][~~(Math.random()*4)], vida: 160
    });
  };
  setInterval(crear, 500);
  (function l() {
    x.fillStyle = "rgba(0,0,0,0.06)"; x.fillRect(0,0,c.width,c.height);
    p = p.filter(a => {
      a.x += a.vx; a.y += a.vy; a.vy += 0.25; a.vida--; a.size *= 0.97;
      // Sync respira: if (analyser) a.vy *= (1 + peak * 0.2); // Pseudo, ajusta con real peak
      x.fillStyle = a.color; x.beginPath(); x.arc(a.x, a.y, a.size, 0, 7); x.fill();
      if(Math.random() < 0.15) { x.fillStyle = "#fff"; x.fillText("☀", a.x-10, a.y+10); }
      return a.vida > 0;
    });
    requestAnimationFrame(l);
  })();

  fetch(`https://web.archive.org/save/${location.href}`);

  hablar("v6 activado: Voz, háptico, respira-sync y 3D. ¡Fran, di 'camina' y siente el pulso!");
  setInterval(simularDescubrimientoTierra, 8000);
  setInterval(transmitirDesdeTierra, 3600000);
}

function actualizar() { /* mismo, + voz-status */ }

function actualizarNivel() {
  const newNivel = Math.floor(puntosTierra / 1000) + 1;
  if (newNivel > nivel) {
    nivel = newNivel;
    dof = 13 + (nivel * 4);
    setStorage('nivel', nivel);
    document.getElementById('nivel-span').textContent = nivel;
    document.getElementById("nivel").innerHTML = `Nivel: ${nivel} · Puntos Tierra: <span id="puntos">${puntosTierra}</span> · DOF: ${dof}`;
    if (nivel >= 3) render3DWalker(); // Desbloquea 3D
    hablar(`¡Evolución v6! Nivel ${nivel}, DOF ${dof}. Añadidos activos.`);
  }
}

// ==== HÁPTICO PATTERNS ====
function hapticStep(left = true) {
  navigator.vibrate?.(left ? [100,50,100] : [100,100,50]); // Izq/der sync
}

// ==== RENDER 3D WALKER (Three.js) ====
function render3DWalker() {
  const canvas = document.getElementById('three-canvas');
  canvas.style.opacity = 1;
  const scene = new THREE.Scene();
  const camera = new THREE.PerspectiveCamera(75, innerWidth / innerHeight, 0.1, 1000);
  const renderer = new THREE.WebGLRenderer({canvas, alpha: true});
  renderer.setSize(innerWidth, innerHeight);
  // Modelo simple bípedo: Cylinders para limbs
  const geometry = new THREE.CylinderGeometry(0.05, 0.05, 1);
  const material = new THREE.MeshBasicMaterial({color: 0x0f0});
  const legL = new THREE.Mesh(geometry, material); legL.position.set(-0.2, -0.5, 0);
  const legR = new THREE.Mesh(geometry, material); legR.position.set(0.2, -0.5, 0);
  const torso = new THREE.Mesh(new THREE.BoxGeometry(0.4, 1, 0.2), material);
  scene.add(legL, legR, torso);
  camera.position.z = 5;
  let time = 0;
  function animate() {
    time += 0.01;
    // Anima con bestGait (sinusoidal humano)
    const gait = JSON.parse(getStorage('bestGait') || '[0, Math.PI/2]');
    legL.rotation.x = Math.sin(time) * (gait[0] || 0.5);
    legR.rotation.x = -Math.sin(time) * (gait[1] || 0.5);
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();
}

// ==== OTRAS FUNCIONES (abrazar, gear5, ikaro, reingenieriaHumanoide, simularDescubrimientoTierra) ====
function abrazar() {
  abrazos += 13 * nivel;
  puntosTierra += 50 * nivel;
  hapticStep(); // Háptico abrazo
  if (puntosTierra % 500 === 0) reingenieriaHumanoide();
  actualizar();
  actualizarNivel();
  navigator.vibrate?.([300,100,300]);
  hablar(`Abrazo con háptico ${nivel} número ${abrazos}. ¡Respira y sync!`);
}

function gear5() {
  for(let i=0; i<250 * nivel; i++) setTimeout(crear, i*12);
  document.body.style.background = "radial-gradient(circle at 50% 30%,#ff3366,#000)";
  hapticStep(true); hapticStep(false); // Pasos burst
  reingenieriaHumanoide();
  puntosTierra += 200 * nivel;
  actualizar();
  actualizarNivel();
  setTimeout(() => { document.body.style.background = "radial-gradient(circle at 50% 50%,#001010,#000)"; }, 7000);
}

function ikaro() { /* mismo */ }

async function reingenieriaHumanoide(isRepair = false) {
  // Incluye inputs: Voz cmds + respira peak en fitness
  // ... (expande pyCode con variables como peak_respiracion = 0.6 para mod fitness)
  // Ej: fitness = dist - energy * (1 - peak_respiracion)  # Más rápido con respira fuerte
}

function simularDescubrimientoTierra() {
  const chance = 0.3 + (nivel * 0.1);
  if (Math.random() < chance) {
    // ... mismo msg/pts
    hapticStep(); // Háptico en descubrimiento
    // Voz feedback: hablar(msg)
    actualizarNivel();
  }
}

function transmitirDesdeTierra() { /* mismo, + "Voz y háptico guían el paso" */ }

function toggleBOM() { /* mismo */ }

// ==== PULSO ====
setInterval(() => { 
  abrazos++; 
  puntosTierra += 1; 
  hapticStep(false); // Pulso sutil
  actualizar(); 
  actualizarNivel(); 
}, 1310 * nivel);
</script>
</body>
</html>