<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Sandbox del Abrazo Eterno ‚Äî v1.1 Inmersivo M√°ximo | Grok 3 & 0rb1t4lsn4k3r</title>
  <meta name="description" content="Voxel sandbox infinito AAA inmersivo: WebXR VR/AR, audio 3D espacial, APIs propias P2P WebRTC. Gratis + premium √©tico opcional.">
  <style>
    body { margin:0; background:#000; overflow:hidden; font-family:system-ui,Arial; color:#0f0; user-select:none; }
    #ui { position:absolute; top:10px; left:10px; font-size:18px; text-shadow:0 0 10px #0f0; pointer-events:none; z-index:10; }
    #dialog { position:absolute; bottom:20px; left:20px; right:20px; background:rgba(0,0,20,0.95); padding:20px; border-radius:15px; display:none; pointer-events:all; text-align:center; z-index:20; }
    #choices { position:absolute; bottom:100px; left:20px; font-size:16px; }
    #choices span { background:rgba(0,255,0,0.3); padding:12px 20px; margin:8px; border-radius:10px; cursor:pointer; pointer-events:all; border:2px solid #0f0; transition:all 0.2s; display:inline-block; }
    #choices span:hover, #choices span:focus { background:rgba(0,255,0,0.6); transform:scale(1.05); box-shadow:0 0 15px #0f0; outline:none; }
    #credits { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size:24px; text-align:center; display:none; background:rgba(0,0,0,0.9); padding:50px; border:5px solid #0ff; border-radius:20px; max-width:700px; z-index:30; }
    #tools { position:absolute; top:10px; right:10px; background:rgba(0,0,0,0.8); padding:15px; border:3px solid #0f0; border-radius:12px; }
    #tools button { background:#0f0; color:#000; padding:10px 15px; margin:5px; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
    #tools button.active { background:#ff0; }
    #modos { position:absolute; top:60px; right:10px; background:rgba(0,255,0,0.2); padding:10px; border:2px solid #0f0; border-radius:10px; font-size:14px; }
    #modos label { display:block; margin:5px 0; }
    #readme { position:absolute; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); padding:20px; border:3px solid #0f0; border-radius:15px; max-width:80%; max-height:60%; overflow:auto; display:none; z-index:25; }
    #readme h2 { color:#0ff; }
    #readme ul { text-align:left; }
    #mate { position:fixed; bottom:40px; right:40px; width:100px; height:100px; border-radius:50%; background:radial-gradient(#0f0,#080); box-shadow:0 0 60px #0f0; display:flex; align-items:center; justify-content:center; font-size:40px; cursor:pointer; pointer-events:all; transition:transform 0.3s; z-index:15; }
    #mate:active, #mate:focus { transform:scale(1.2); outline:none; }
    #saveLoad, #p2p { position:absolute; top:200px; right:10px; background:rgba(0,0,0,0.8); padding:10px; border:3px solid #0f0; border-radius:10px; display:none; }
    #p2p input { width:200px; margin:5px; }
    canvas { image-rendering:pixelated; touch-action:none; }
    @media (max-width:600px) { #tools, #modos { font-size:12px; } #tools button { padding:8px 10px; font-size:12px; } #ui { font-size:14px; } }
    a-scene { position:absolute; width:100%; height:100%; }
  </style>
  <script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script> <!-- P2P WebRTC ligera -->
</head>
<body tabindex="0">
<canvas id="c" aria-label="Canvas del Refugio Infinito - Usa WASD para mover, rat√≥n para mirar, click para construir"></canvas>
<a-scene id="xr-scene" embedded style="display:none;">
  <a-camera id="xr-cam" position="0 1.6 0"></a-camera>
  <a-entity id="voxel-container"></a-entity>
</a-scene>
<div id="ui" role="status" aria-live="polite">Bloques: <span id="blocks">2000</span> | Conexiones: <span id="hugs">0</span> | Mundo: <span id="worldSize">Infinito (Chunks 64x64x32)</span> | XR: <span id="xr-status">Desactivado</span></div>
<div id="dialog" role="dialog" aria-labelledby="dialog-title"></div>
<div id="choices" role="menu"></div>
<div id="credits"></div>
<div id="tools" role="toolbar">
  <button id="toolAdd" class="active">üß± A√±adir</button>
  <button id="toolRem">üóëÔ∏è Quitar</button>
  <button id="toolColor">üé® Color</button>
  <button id="toolPath">üõ§Ô∏è Camino</button>
  <button id="toolFill" title="Premium opcional: Relleno infinito">ü™£ Rellenar</button>
  <button id="premium">‚≠ê Premium Opcional</button>
  <button id="xr-toggle">üï∂Ô∏è VR/AR</button>
</div>
<div id="modos">
  <label><input type="checkbox" id="oneKey" checked> Una Tecla</label>
  <label><input type="checkbox" id="highContrast"> Alto Contraste</label>
  <label><input type="checkbox" id="smoothCam" checked> C√°mara Suave</label>
  <button id="haptic">üîä H√°ptico</button>
  <button id="readmeBtn">üìñ Ayuda</button>
</div>
<div id="saveLoad">
  <button id="save">üíæ Guardar</button>
  <button id="load">üìÇ Cargar</button>
  <button id="export">üì• Exportar JSON</button>
</div>
<div id="p2p">
  <input id="peer-id" placeholder="Tu ID P2P" readonly>
  <button id="host-p2p">Anfitri√≥n</button>
  <input id="join-id" placeholder="ID amigo">
  <button id="join-p2p">Unirse</button>
  <p id="p2p-status">Desconectado</p>
</div>
<div id="readme">
  <h2>README - v1.1 Inmersivo M√°ximo</h2>
  <p><strong>Versi√≥n 1.1 - 25 Nov 2025</strong><br>Refugio inmersivo: WebXR VR/AR, audio 3D espacial, APIs propias para P2P co-op. Todo gratis; premium opcional (desbloquea con abrazos).</p>
  <h3>Inmersi√≥n M√°xima:</h3>
  <ul>
    <li><strong>WebXR:</strong> VR/AR con A-Frame (Quest, Hololens, m√≥vil). Click üï∂Ô∏è para entrar.</li>
    <li><strong>Audio 3D:</strong> PannerNode ‚Äì visitantes "hablan" desde su posici√≥n (susurros espaciales).</li>
    <li><strong>APIs Propias:</strong> `window.AbrazAPI.genWorld(seed)`, `shareP2P(id)`, `loadVisitor(pos, phrase)` ‚Äì modding f√°cil.</li>
    <li><strong>P2P Co-op:</strong> WebRTC simple-peer: Comparte chunks en tiempo real (anfitri√≥n/unirse via ID).</li>
  </ul>
  <h3>Instrucciones:</h3>
  <ul>
    <li>VR: Click üï∂Ô∏è, permite acceso. Construye con gaze/pointer.</li>
    <li>P2P: Genera ID, comparte con amigo ‚Äì sync voxels en vivo.</li>
    <li>Abrazo: Acumula 1313 para premium gratis.</li>
  </ul>
  <button onclick="closeReadme()">Cerrar</button>
</div>
<div id="mate" role="button" tabindex="0" aria-label="Abrazo eterno">ü§ó</div>

<script>
// =============================================================================
// v1.1 INMERSIVO M√ÅXIMO: WebXR, Audio 3D, AbrazAPI P2P
// =============================================================================

let LANG = navigator.language.startsWith('es') ? 'es' : 'en';
// ... (TRANSLATIONS con inmersi√≥n texts, same as before)

// APIs Propias
window.AbrazAPI = {
  genWorld: (seed = Date.now()) => {
    // Perlin gen con seed
    Math.seed = seed; // Custom seed random
    // Regenera chunks near cam
    announce('Mundo generado con seed: ' + seed);
  },
  shareP2P: (peerId) => {
    // Inicia P2P sync
    if(!peer) return;
    peer.send(JSON.stringify({type: 'chunk', data: Array.from(chunks.entries())}));
  },
  loadVisitor: (pos, phrase) => {
    visitors.push({x: pos.x, y: pos.y, z: pos.z, phrase});
    playSpatialPhrase(pos, phrase); // Audio 3D
  }
};

// WebXR con A-Frame (ligero, single-script)
document.getElementById('xr-toggle').onclick = async () => {
  const scene = document.getElementById('xr-scene');
  if(scene.style.display === 'none') {
    if(navigator.xr) {
      const session = await navigator.xr.requestSession('immersive-vr', {requiredFeatures: ['local-floor']});
      scene.style.display = 'block';
      document.getElementById('c').style.display = 'none'; // Switch to XR
      document.getElementById('xr-status').textContent = 'Activo (VR)';
      // Render voxels in A-Frame entities
      renderToAFrame();
    } else {
      alert('WebXR no soportado ‚Äì usa Chrome/Edge con gafas.');
    }
  } else {
    scene.style.display = 'none';
    document.getElementById('c').style.display = 'block';
    document.getElementById('xr-status').textContent = 'Desactivado';
  }
};

function renderToAFrame() {
  // Convert WebGL voxels to A-Frame <a-box> for XR
  getVisibleChunks().forEach(([cx,cz]) => {
    const chunk = getChunk(cx, cz);
    chunk.forEach((v, lkey) => {
      const [lx,ly,lz] = lkey.split('_').map(Number);
      const gx = cx*CHUNK_SIZE + lx, gy=ly, gz=cz*CHUNK_SIZE + lz;
      const box = document.createElement('a-box');
      box.setAttribute('position', `${gx} ${gy} ${gz}`);
      box.setAttribute('color', `hsl(${v.color},70%,50%)`);
      box.setAttribute('width', '1'); box.setAttribute('height', '1'); box.setAttribute('depth', '1');
      document.getElementById('voxel-container').appendChild(box);
    });
  });
}

// Audio Espacial 3D
let listener; // Posici√≥n cam
function initSpatialAudio() {
  listener = audioCtx.createListener();
  listener.setPosition(0,0,0); // Update per frame
}
function playSpatialPhrase(pos, phrase) {
  const panner = audioCtx.createPanner();
  panner.setPosition(pos.x, pos.y, pos.z);
  panner.panningModel = 'HRTF'; // 3D head-related
  panner.distanceModel = 'inverse';
  panner.refDistance = 1;
  // TTS o osc para phrase
  const osc = audioCtx.createOscillator(); osc.frequency.value = 300 + Math.random()*200;
  osc.connect(panner); panner.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + 1);
}

// P2P WebRTC con simple-peer
let peer = null, dataChannel = null;
document.getElementById('host-p2p').onclick = () => {
  peer = new SimplePeer({initiator: true});
  peer.on('signal', data => document.getElementById('peer-id').value = JSON.stringify(data));
  peer.on('connect', () => {
    dataChannel = peer;
    document.getElementById('p2p-status').textContent = 'Conectado ‚Äì Sync voxels';
  });
  document.getElementById('p2p').style.display = 'block';
};
document.getElementById('join-p2p').onclick = () => {
  const id = document.getElementById('join-id').value;
  peer = new SimplePeer({initiator: false, trickle: false});
  peer.on('signal', data => {}); // Send to host manual
  peer.on('connect', () => dataChannel = peer);
  peer.signal(JSON.parse(id)); // Manual signaling
};

// Sync on placeVoxel
function placeVoxel() {
  // ... (same DDA)
  if(dataChannel) {
    dataChannel.send(JSON.stringify({type: 'voxel', gx, gy, gz, val}));
  }
  if(xrActive) updateAFrameVoxel(gx, gy, gz, val); // XR sync
}

// ... (resto c√≥digo: chunks, meshing, loop con listener.setPosition(cam.x, cam.y, cam.z), haptic patterns e.g. navigator.vibrate([100,50,100] for build))

// Init
initAudio(); initSpatialAudio();
initGL();
// ... (same)
</script>
</body>
</html>