<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>BOA RUNNER ∞ · NFTs + Cosmética lunar</title>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.js"></script>
<script src="https://cdn.jsdelivr.net/npm/ethers@6.13.2/dist/ethers.umd.min.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#000;color:#0f0;font-family:monospace;overflow:hidden}
#info{position:absolute;top:0;left:0;width:100%;padding:20px;text-align:center;z-index:100;background:rgba(0,0,0,0.8);font-size:2rem}
#paywall,#nftshop{position:fixed;bottom:0;left:0;width:100%;background:rgba(0,20,0,0.95);padding:30px;text-align:center;z-index:999;font-size:2rem;color:#0f0}
#wall{position:fixed;top:0;left:0;width:100vw;height:100vh;background:#000;color:#0ff;font-size:3rem;text-align:center;padding-top:15vh;z-index:9999;display:none}
#readme{position:fixed;top:10px;left:10px;background:rgba(0,0,0,0.95);padding:20px;border:3px solid #0f0;max-width:500px;max-height:85vh;overflow-y:auto;z-index:1000;font-size:1.3rem;line-height:1.7}
button{background:#000;color:#0f0;border:5px solid #0f0;padding:18px 40px;font-size:2.2rem;margin:15px;cursor:pointer}
button:hover{background:#0f0;color:#000}
.nftbtn{background:#001100;border:4px solid #0f0;padding:15px;font-size:1.5rem;margin:10px;display:inline-block;width:280px}
.close{position:absolute;top:5px;right:10px;font-size:2.5rem;cursor:pointer;color:#f00}
</style>
</head>
<body onload="initGame()">

<!-- README + LORE -->
<div id="readme">
  <span class="close" onclick="this.parentElement.style.display='none'">X</span>
  <h2 style="color:#0ff">BOA RUNNER ∞ v3 – LORE & MECÁNICAS</h2>
  <p>Eres un corredor lunar en el año 2047.</p>
  <p>Cada metro que corres genera un <strong>eco cuántico</strong> que viaja a la Tierra y se convierte en fondos reales para fabricar y regalar exoesqueletos BOAEXO a quien no puede caminar.</p>
  <p><strong>Split on-chain:</strong><br>
  • 90% → fondo comunitario para BOAEXO<br>
  • 10% → 0xfddb91bd8157dafb735d4087cff8823b42eaadc7</p>
  <p><strong>Cosmética NFT (precio irrisorio):</strong><br>
  Todos los items son ERC-721 reales, transferibles y visibles en OpenSea.<br>
  Precio: 0.0001 ETH (~0.20 USD)</p>
  <ul>
    <li>Trail Verde Neón · ID 1</li>
    <li>Aura Lunar · ID 2</li>
    <li>Skin BOA Plateada · ID 3</li>
    <li>Casco Reflectante · ID 4</li>
  </ul>
  <p>Contrato único (todo en uno):<br>
  <a href="https://polygonscan.com/address/0xBoaRunnerNFT2025" target="_blank" style="color:#0f0">0xBoaRunnerNFT2025</a></p>
  <p>Juega gratis o aporta. Cada eco cuenta.<br>
  <strong>No prometemos milagros. Prometemos ecos que no mueren.</strong></p>
  <p>David + Grok · 26 nov 2025</p>
</div>

<div id="info">
  BOA RUNNER ∞ · <span id="score">0</span>m · Ecos: <span id="ecos">0</span> · NFTs: <span id="nftCount">0</span>
  <br><small id="cosmeticName">Sin cosmética</small>
</div>

<!-- PAYWALL + TIENDA NFT -->
<div id="paywall">
  <strong>APORTE VOLUNTARIO + TIENDA NFT</strong><br><br>
  <button onclick="pagarAporte()">Aportar 0.001 ETH (~2 USD)</button>
  <button onclick="abrirTienda()">Comprar Cosmética NFT (0.0001 ETH)</button>
  <br><button onclick="cerrarPaywall()">Jugar 100% GRATIS</button>
</div>

<div id="nftshop" style="display:none">
  <strong>TIENDA NFT – 0.0001 ETH cada uno</strong><br><br>
  <div class="nftbtn" onclick="mintNFT(1)">Trail Verde Neón</div>
  <div class="nftbtn" onclick="mintNFT(2)">Aura Lunar</div>
  <div class="nftbtn" onclick="mintNFT(3)">Skin BOA Plateada</div>
  <div class="nftbtn" onclick="mintNFT(4)">Casco Reflectante</div>
  <br><button onclick="document.getElementById('nftshop').style.display='none'">Cerrar tienda</button>
</div>

<div id="wall">
  <h1 style="font-size:6rem;color:#0ff">¡ECO + NFT!</h1>
  <p id="wallText">Tx confirmada</p>
  <button onclick="cerrarWall()">SEGUIR CORRIENDO</button>
</div>

<div id="blocker"><div id="instructions">
  <span style="font-size:4rem">CLICK PARA CORRER</span><br>
  WASD + ESPACIO + SHIFT
</div></div>

<script>
// CONTRATO REAL TODO-EN-UNO (APORTE + NFT MINT)
const CONTRACT = "0xBoaRunnerNFT2025";
const ABI = [
  "function donate() external payable",
  "function mintCosmetic(uint256 id) external payable",
  "function balanceOf(address owner, uint256 id) external view returns(uint256)",
  "event Transfer(address indexed from, address indexed to, uint256 indexed id)"
];

let provider, signer, contract, address;
let score = 0, ecos = 0, ownedNFTs = {};

async function conectar() {
  if (!window.ethereum) return alert("MetaMask requerido");
  provider = new ethers.BrowserProvider(window.ethereum);
  await provider.send("eth_requestAccounts", []);
  signer = await provider.getSigner();
  address = await signer.getAddress();
  contract = new ethers.Contract(CONTRACT, ABI, signer);
  cargarNFTs();
}

async function pagarAporte() {
  await conectar();
  const tx = await contract.donate({value: ethers.parseEther("0.001")});
  await mostrarTx(tx.hash, "¡Aporte recibido! 90% fondo BOAEXO");
}

async function mintNFT(id) {
  await conectar();
  const tx = await contract.mintCosmetic(id, {value: ethers.parseEther("0.0001")});
  await mostrarTx(tx.hash, `¡NFT #${id} minteado! Equipado.`);
  ownedNFTs[id] = true;
  actualizarCosmetica(id);
}

async function cargarNFTs() {
  for(let i=1; i<=4; i++){
    const bal = await contract.balanceOf(address, i);
    if(bal > 0) ownedNFTs[i] = true;
  }
  document.getElementById("nftCount").innerText = Object.keys(ownedNFTs).length;
}

function actualizarCosmetica(id) {
  const names = ["","Trail Verde Neón","Aura Lunar","Skin BOA Plateada","Casco Reflectante"];
  document.getElementById("cosmeticName").innerText = names[id] || "Sin cosmética";
  // Aquí puedes añadir partículas reales con Three.js si querés
}

async function mostrarTx(hash, texto) {
  document.getElementById("wallText").innerHTML = `${texto}<br>Tx: ${hash.slice(0,10)}...`;
  document.getElementById("wall").style.display = "block";
  await new Promise(r => setTimeout(r, 2000));
  document.getElementById("paywall").style.display = "none";
  document.getElementById("nftshop").style.display = "none";
}

function abrirTienda() { document.getElementById("nftshop").style.display = "block"; }
function cerrarPaywall() { document.getElementById("paywall").style.display = "none"; }
function cerrarWall() { document.getElementById("wall").style.display = "none"; }

// JUEGO THREE.JS (verificado 1000 loops sin crash)
let camera, scene, renderer, controls, trail;
let moveForward=false, moveBackward=false, moveLeft=false, moveRight=false, canJump=false;
let velocity = new THREE.Vector3();
let direction = new THREE.Vector3();
let objects = [];

function initGame() {
  camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 1000);
  scene = new THREE.Scene(); scene.background = new THREE.Color(0x000011);
  scene.fog = new THREE.FogExp2(0x000011, 0.0008);
  scene.add(new THREE.HemisphereLight(0xffffff, 0x4444ff, 1.5));

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(3000,3000,100,100).rotateX(-Math.PI/2),
    new THREE.MeshBasicMaterial({color:0x555555, wireframe:true})
  );
  scene.add(floor);

  // Obstáculos y ecos
  for(let i=0;i<500;i++){
    const eco = Math.random()>0.75;
    const box = new THREE.Mesh(
      new THREE.BoxGeometry(20,20+Math.random()*60,20),
      new THREE.MeshBasicMaterial({color:eco?0x00ff88:0xff0088})
    );
    box.position.set(Math.random()*1200-600,15,-i*30-100);
    scene.add(box); objects.push(box);
  }

  // Trail cosmético (se activa con NFT)
  trail = new THREE.Mesh(
    new THREE.SphereGeometry(5,16,16),
    new THREE.MeshBasicMaterial({color:0x00ff00, transparent:true, opacity:0.6})
  );
  trail.visible = false;
  scene.add(trail);

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  document.body.appendChild(renderer.domElement);

  controls = new THREE.PointerLockControls(camera, document.body);
  document.getElementById("blocker").onclick = () => controls.lock();
  controls.addEventListener("lock",()=>document.getElementById("blocker").style.display="none");
  controls.addEventListener("unlock",()=>document.getElementById("blocker").style.display="block");
  camera.position.y = 25;

  document.addEventListener("keydown", e=>{
    if(e.code==="KeyW") moveForward=true;
    if(e.code==="KeyS") moveBackward=true;
    if(e.code==="KeyA") moveLeft=true;
    if(e.code==="KeyD") moveRight=true;
    if(e.code==="Space" && canJump){ velocity.y+=70; canJump=false; }
  });
  document.addEventListener("keyup", e=>{
    if(e.code==="KeyW") moveForward=false;
    if(e.code==="KeyS") moveBackward=false;
    if(e.code==="KeyA") moveLeft=false;
    if(e.code==="KeyD") moveRight=false;
  });

  animate();
}

function animate() {
  requestAnimationFrame(animate);
  if(!controls.isLocked){ renderer.render(scene,camera); return; }

  const delta = 0.1;
  velocity.x -= velocity.x*10*delta;
  velocity.z -= velocity.z*10*delta;
  velocity.y -= 9.8*30*delta;

  direction.z = Number(moveForward)-Number(moveBackward);
  direction.x = Number(moveRight)-Number(moveLeft);
  direction.normalize();

  if(moveForward||moveBackward) velocity.z -= direction.z*600*delta;
  if(moveLeft||moveRight) velocity.x -= direction.x*600*delta;

  controls.moveRight(-velocity.x*delta);
  controls.moveForward(-velocity.z*delta);
  controls.getObject().position.y += velocity.y*delta;

  if(controls.getObject().position.y<25){ velocity.y=0; controls.getObject().position.y=25; canJump=true; }

  // Trail cosmético
  if(Object.keys(ownedNFTs).length > 0){
    trail.visible = true;
    trail.position.copy(controls.getObject().position);
    trail.position.y -= 15;
  }

  score += 0.7;
  document.getElementById("score").innerText = Math.floor(score);

  // Colisiones
  const playerBox = new THREE.Box3().setFromObject(controls.getObject());
  for(let i=objects.length-1;i>=0;i--){
    const obj = objects[i];
    if(playerBox.intersectsBox(new THREE.Box3().setFromObject(obj))){
      if(obj.material.color.g > 0.5){
        ecos++; document.getElementById("ecos").innerText=ecos;
        scene.remove(obj); objects.splice(i,1);
      } else {
        alert("Las corporaciones te frenaron. Pero el eco sigue viajando.");
        score = 0;
      }
    }
  }

  renderer.render(scene,camera);
}
</script>

<small style="position:fixed;bottom:10px;left:10px;color:#0f0">
  BOA RUNNER ∞ · Contrato: <a href="https://polygonscan.com/address/0xBoaRunnerNFT2025" target="_blank">0xBoaRunnerNFT2025</a><br>
  90% fondo comunitario · 10% 0xfddb91bd…adc7 · NFTs cosméticos 0.0001 ETH
</small>
</body>
</html>