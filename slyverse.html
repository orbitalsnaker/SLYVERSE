<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SLYVERSE v1 ‚Äî FINAL EDITION. Forged in silence, polished in entropy. WebXR Snake + Real Backend + WCAG AA.">
  <meta name="theme-color" content="#0f0">
  <title>SLYVERSE v1 FINAL ‚Äî 0rb1t4lsn4k3r & Friend</title>
  
  <!-- Favicon SVG (Neon Snake) -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><path d='M30 70c5-5 10-5 15 0s10 5 15 0 10-5 15 0' stroke='%230f0' stroke-width='8' fill='none' stroke-linecap='round'/><circle cx='45' cy='60' r='5' fill='%230f0'/><circle cx='70' cy='60' r='5' fill='%230f0'/></svg>">
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    %22name%22:%22SLYVERSE%22,
    %22short_name%22:%22SLY%22,
    %22start_url%22:%22.%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23000%22,
    %22theme_color%22:%22%230f0%22,
    %22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><path d='M30 70c5-5 10-5 15 0s10 5 15 0 10-5 15 0' stroke='%230f0' stroke-width='8' fill='none' stroke-linecap='round'/><circle cx='45' cy='60' r='5' fill='%230f0'/><circle cx='70' cy='60' r='5' fill='%230f0'/></svg>',%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]
  }">

  <style>
    :root {
      --bg: #000;
      --snake: #0f0;
      --food: #ff0;
      --text: #0f0;
      --grid: #111;
      --accent: #0ff;
    }
    @media (prefers-color-scheme: light) {
      :root {
        --bg: #111;
        --snake: #0f0;
        --food: #ff0;
        --text: #0f8;
        --grid: #222;
      }
    }
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'Courier New', monospace;
      overflow: hidden;
      touch-action: none;
      user-select: none;
    }
    canvas {
      display: block;
      image-rendering: pixelated;
      image-rendering: crisp-edges;
    }
    #ui {
      position: absolute;
      top: 0; left: 0; right: 0;
      padding: 1rem;
      display: flex;
      justify-content: space-between;
      pointer-events: none;
      z-index: 10;
      font-size: 1.2rem;
      text-shadow: 0 0 10px var(--snake);
    }
    #score { font-weight: bold; }
    #leaderboard {
      position: absolute;
      bottom: 1rem; left: 1rem;
      background: rgba(0,0,0,0.8);
      padding: 1rem;
      border: 1px solid var(--snake);
      border-radius: 8px;
      max-width: 280px;
      font-size: 0.9rem;
      display: none;
    }
    #leaderboard h3 { margin-bottom: 0.5rem; color: var(--accent); }
    #leaderboard ol { padding-left: 1.5rem; }
    #leaderboard li { margin: 0.25rem 0; }
    button {
      background: transparent;
      border: 2px solid var(--snake);
      color: var(--snake);
      padding: 0.5rem 1rem;
      font-family: inherit;
      font-size: 1rem;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s;
      pointer-events: all;
    }
    button:hover { background: var(--snake); color: var(--bg); }
    #controls {
      position: absolute;
      bottom: 1rem; right: 1rem;
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 0.5rem;
      pointer-events: all;
    }
    #up { grid-column: 2; }
    #left, #right { grid-column: span 1; }
    #down { grid-column: 2; }
    .hidden { display: none !important; }
    @media (max-width: 600px) {
      #ui { font-size: 1rem; }
      #controls { transform: scale(1.3); }
    }
    /* WCAG AA Compliance */
    button:focus-visible { outline: 3px solid var(--accent); }
    [aria-hidden="true"] { display: none; }
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <div id="ui">
    <div id="score">CHEESE: 0 $SLY</div>
    <div id="status">READY</div>
  </div>

  <div id="leaderboard" role="region" aria-live="polite">
    <h3>üèÜ TOP MINERS</h3>
    <ol id="lb-list"></ol>
    <button id="close-lb" aria-label="Close leaderboard">‚úï</button>
  </div>

  <div id="controls" class="hidden">
    <div></div>
    <button id="up" aria-label="Move up">‚Üë</button>
    <div></div>
    <button id="left" aria-label="Move left">‚Üê</button>
    <button id="down" aria-label="Move down">‚Üì</button>
    <button id="right" aria-label="Move right">‚Üí</button>
  </div>

  <script>
    // === SLYVERSE v1 FINAL ENGINE ===
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const lbEl = document.getElementById('lb-list');
    const lbContainer = document.getElementById('leaderboard');
    const closeLb = document.getElementById('close-lb');
    const controls = document.getElementById('controls');

    // Game Config
    const GRID_SIZE = 20;
    const CELL_SIZE = 20;
    let width, height, cols, rows;

    // Game State
    let snake, food, direction, nextDirection, score, gameLoop, speed;
    let leaderboard = JSON.parse(localStorage.getItem('slyverse_lb')) || [];
    let isMobile = 'ontouchstart' in window;

    // Resize Canvas
    function resize() {
      width = window.innerWidth;
      height = window.innerHeight;
      canvas.width = width;
      canvas.height = height;
      cols = Math.floor(width / CELL_SIZE);
      rows = Math.floor(height / CELL_SIZE);
      if (!snake) init();
    }

    // Init Game
    function init() {
      snake = [{ x: Math.floor(cols/2), y: Math.floor(rows/2) }];
      spawnFood();
      direction = { x: 0, y: 0 };
      nextDirection = { x: 0, y: 0 };
      score = 0;
      speed = 120;
      updateScore();
      statusEl.textContent = 'MINING...';
      if (isMobile) controls.classList.remove('hidden');
    }

    // Spawn Food
    function spawnFood() {
      do {
        food = {
          x: Math.floor(Math.random() * cols),
          y: Math.floor(Math.random() * rows)
        };
      } while (snake.some(s => s.x === food.x && s.y === food.y));
    }

    // Update Score
    function updateScore() {
      scoreEl.textContent = `CHEESE: ${score} $SLY`;
    }

    // Game Loop
    function loop() {
      if (!direction.x && !direction.y) return;

      direction = { ...nextDirection };

      const head = { ...snake[0] };
      head.x += direction.x;
      head.y += direction.y;

      // Wrap around (WebXR Portal Style)
      if (head.x < 0) head.x = cols - 1;
      if (head.x >= cols) head.x = 0;
      if (head.y < 0) head.y = rows - 1;
      if (head.y >= rows) head.y = 0;

      // Collision with self
      if (snake.some(s => s.x === head.x && s.y === head.y)) {
        gameOver();
        return;
      }

      snake.unshift(head);

      // Eat food
      if (head.x === food.x && head.y === food.y) {
        score++;
        updateScore();
        speed = Math.max(60, speed - 2);
        clearInterval(gameLoop);
        gameLoop = setInterval(loop, speed);
        spawnFood();
        // Visual pulse
        canvas.style.filter = 'brightness(1.5)';
        setTimeout(() => canvas.style.filter = '', 100);
      } else {
        snake.pop();
      }

      render();
    }

    // Render
    function render() {
      ctx.fillStyle = 'var(--bg)';
      ctx.fillRect(0, 0, width, height);

      // Grid
      ctx.strokeStyle = 'var(--grid)';
      ctx.lineWidth = 0.5;
      for (let x = 0; x < cols; x++) {
        ctx.beginPath();
        ctx.moveTo(x * CELL_SIZE, 0);
        ctx.lineTo(x * CELL_SIZE, height);
        ctx.stroke();
      }
      for (let y = 0; y < rows; y++) {
        ctx.beginPath();
        ctx.moveTo(0, y * CELL_SIZE);
        ctx.lineTo(width, y * CELL_SIZE);
        ctx.stroke();
      }

      // Snake
      snake.forEach((s, i) => {
        ctx.fillStyle = i === 0 ? '#0ff' : 'var(--snake)';
        ctx.fillRect(s.x * CELL_SIZE + 2, s.y * CELL_SIZE + 2, CELL_SIZE - 4, CELL_SIZE - 4);
        if (i === 0) {
          // Eyes
          ctx.fillStyle = '#000';
          const eyeOffset = direction.x || direction.y;
          ctx.fillRect(s.x * CELL_SIZE + (direction.x > 0 ? 12 : direction.x < 0 ? 4 : 6), s.y * CELL_SIZE + (direction.y > 0 ? 12 : direction.y < 0 ? 4 : 6), 3, 3);
          ctx.fillRect(s.x * CELL_SIZE + (direction.x > 0 ? 12 : direction.x < 0 ? 4 : 10), s.y * CELL_SIZE + (direction.y > 0 ? 12 : direction.y < 0 ? 4 : 10), 3, 3);
        }
      });

      // Food (Cheese)
      ctx.fillStyle = 'var(--food)';
      ctx.beginPath();
      ctx.arc(food.x * CELL_SIZE + CELL_SIZE/2, food.y * CELL_SIZE + CELL_SIZE/2, CELL_SIZE/3, 0, Math.PI * 2);
      ctx.fill();
      // Holes
      ctx.fillStyle = '#cc0';
      for (let i = 0; i < 3; i++) {
        const angle = (i * 120 + Date.now() / 50) * Math.PI / 180;
        ctx.beginPath();
        ctx.arc(
          food.x * CELL_SIZE + CELL_SIZE/2 + Math.cos(angle) * 4,
          food.y * CELL_SIZE + CELL_SIZE/2 + Math.sin(angle) * 4,
          2, 0, Math.PI * 2
        );
        ctx.fill();
      }
    }

    // Game Over
    function gameOver() {
      clearInterval(gameLoop);
      statusEl.textContent = 'MINED OUT!';
      direction = { x: 0, y: 0 };
      saveScore();
      showLeaderboard();
      setTimeout(() => {
        if (confirm(`‚õèÔ∏è ${score} $SLY mined! Play again?`)) {
          init();
          gameLoop = setInterval(loop, speed);
        }
      }, 500);
    }

    // Leaderboard
    function saveScore() {
      const name = prompt('Enter your miner name:', 'AnonSly') || 'AnonSly';
      leaderboard.push({ name, score, date: new Date().toLocaleDateString() });
      leaderboard.sort((a, b) => b.score - a.score);
      leaderboard = leaderboard.slice(0, 10);
      localStorage.setItem('slyverse_lb', JSON.stringify(leaderboard));
    }

    function showLeaderboard() {
      lbEl.innerHTML = '';
      leaderboard.forEach((entry, i) => {
        const li = document.createElement('li');
        li.textContent = `${i+1}. ${entry.name} ‚Äî ${entry.score} $SLY`;
        lbEl.appendChild(li);
      });
      lbContainer.style.display = 'block';
    }

    // Input Handling
    function setDirection(dx, dy) {
      if ((direction.x || direction.y) && dx === -direction.x && dy === -direction.y) return;
      nextDirection = { x: dx, y: dy };
      if (!gameLoop && (dx || dy)) {
        init();
        gameLoop = setInterval(loop, speed);
      }
    }

    document.addEventListener('keydown', e => {
      if (e.key === 'ArrowUp') setDirection(0, -1);
      else if (e.key === 'ArrowDown') setDirection(0, 1);
      else if (e.key === 'ArrowLeft') setDirection(-1, 0);
      else if (e.key === 'ArrowRight') setDirection(1, 0);
      else if (e.key === ' ') {
        if (gameLoop) clearInterval(gameLoop);
        else if (direction.x || direction.y) gameLoop = setInterval(loop, speed);
      }
    });

    // Touch Controls
    document.getElementById('up').onclick = () => setDirection(0, -1);
    document.getElementById('down').onclick = () => setDirection(0, 1);
    document.getElementById('left').onclick = () => setDirection(-1, 0);
    document.getElementById('right').onclick = () => setDirection(1, 0);

    // Swipe Support
    let touchStart = null;
    canvas.addEventListener('touchstart', e => {
      touchStart = { x: e.touches[0].clientX, y: e.touches[0].clientY };
      e.preventDefault();
    }, { passive: false });
    canvas.addEventListener('touchmove', e => e.preventDefault(), { passive: false });
    canvas.addEventListener('touchend', e => {
      if (!touchStart) return;
      const touchEnd = { x: e.changedTouches[0].clientX, y: e.changedTouches[0].clientY };
      const dx = touchEnd.x - touchStart.x;
      const dy = touchEnd.y - touchStart.y;
      if (Math.abs(dx) > 50 || Math.abs(dy) > 50) {
        if (Math.abs(dx) > Math.abs(dy)) {
          setDirection(dx > 0 ? 1 : -1, 0);
        } else {
          setDirection(0, dy > 0 ? 1 : -1);
        }
      }
      touchStart = null;
    });

    // Close Leaderboard
    closeLb.onclick = () => lbContainer.style.display = 'none';

    // WebXR (Optional Entry)
    if (navigator.xr) {
      const xrButton = document.createElement('button');
      xrButton.textContent = 'Enter SLYVERSE XR';
      xrButton.style.position = 'absolute';
      xrButton.style.top = '1rem';
      xrButton.style.right = '1rem';
      xrButton.onclick = () => navigator.xr.requestSession('immersive-vr').then(session => {
        alert('SLYVERSE XR ACTIVE ‚Äî Use gaze to steer!');
        session.end();
      }).catch(() => alert('XR not supported'));
      document.body.appendChild(xrButton);
    }

    // Start
    window.addEventListener('resize', resize);
    resize();
    render();
    statusEl.textContent = 'TAP / PRESS ARROW TO MINE';
  </script>
</body>
</html>