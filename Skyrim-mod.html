<!DOCTYPE html>
<html lang="es">
<meta charset="utf-8">
<title>THUAMER Ω</title>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<style>
  body{margin:0;height:100vh;background:#000;overflow:hidden;position:fixed}
  canvas{position:fixed;inset:0;display:block;touch-action:none}
</style>
<canvas id="c"></canvas>
<script>
/* THUAMER Ω – versión bellamente ascética – 2025 */

const KOAN = 13101310n * 1000n
const MIN_DEVOTION = 130n * 3600n * 1000n
const KEY = "thuamer13101310"

let rawState = (() => { try { return JSON.parse(localStorage.getItem(KEY)) || {} } catch { return {} } })()
let t = BigInt(rawState.t || 0)
let real_playtime = BigInt(rawState.real_playtime || 0)
let clicks = BigInt(rawState.clicks || 0)
let id = rawState.id || crypto.randomUUID()
let born = rawState.first || Date.now()
let zen = !!rawState.unlocked
let mantraLevel = rawState.mantraLevel || 0
let shortId = rawState.shortId || id.slice(0,8).replace(/[^a-f0-9]/gi,'').toLowerCase()
let milestones = rawState.milestones || {}

const persist = () => localStorage.setItem(KEY, JSON.stringify({t:t.toString(),real_playtime:real_playtime.toString(),clicks:clicks.toString(),id,first:born,unlocked:zen,mantraLevel,shortId,milestones}))

const urlParams = new URLSearchParams(location.search)
const ref = urlParams.get('ref')
let referralBonus = false
if (ref && ref !== shortId && ref !== id) {
  t += 10n * 3600n * 1000n
  clicks += 1000n
  mantraLevel = Math.min(5, mantraLevel + 1)
  referralBonus = true
  persist()
}

let prev = performance.now()
let birth = zen ? prev : 0
let particles = []
let flash = {msg:'', time:0}
let lastClickTime = 0
let audioCtx = null
let mouseDown = false
let touchActive = false
let keysPressed = new Set()
let breathePhase = 0

const c = document.getElementById("c")
const ctx = c.getContext("2d", {alpha:false, desynchronized:true})

const resize = () => {
  const dpr = devicePixelRatio || 1
  c.width = innerWidth * dpr
  c.height = innerHeight * dpr
  ctx.setTransform(dpr,0,0,dpr,0,0)
}
resize()
addEventListener("resize", resize)

// ---------- sonido más bello ----------
function note(freq, dur=0.1, vol=0.2, type='triangle') {
  if (!audioCtx) audioCtx = new AudioContext()
  const o = audioCtx.createOscillator()
  const g = audioCtx.createGain()
  o.type = type
  o.frequency.setValueAtTime(freq, audioCtx.currentTime)
  g.gain.setValueAtTime(vol, audioCtx.currentTime)
  g.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur)
  o.connect(g).connect(audioCtx.destination)
  o.start()
  o.stop(audioCtx.currentTime + dur)
}

const doClick = (x=innerWidth/2, y=innerHeight/2) => {
  const now = performance.now()
  if (now - lastClickTime < 120) return
  lastClickTime = now
  t += 13000n; clicks++
  
  // partículas más etéreas
  for(let i=0;i<12;i++){
    const a = Math.random()*Math.PI*2
    const v = 1+Math.random()*4
    particles.push({
      x, y,
      vx: Math.cos(a)*v,
      vy: Math.sin(a)*v - 3,
      life: 60+Math.random()*40,
      text: i===0 ? '+13s' : ''
    })
  }
  
  if (clicks%1000n===0n){
    const lvl = Number(clicks/1000n)
    if(lvl>mantraLevel){
      mantraLevel = Math.min(5,lvl)
      flash = {msg:`MANTRA ${mantraLevel} ×${1<<mantraLevel}`, time:now}
      note(880,0.8,0.3,'sine')
    }
  }
  note(220*Math.pow(1.1, Number(clicks)%12), 0.08, 0.25, 'sine')
  persist()
}

// input
c.onpointerdown = e => { if(zen)return; doClick(e.clientX,e.clientY); mouseDown=true }
c.onpointerup = c.onpointerleave = () => mouseDown=false
c.onpointermove = e => { if(mouseDown) doClick(e.clientX,e.clientY) }
document.addEventListener('keydown', e=>{if(zen||!e.repeat&& (e.code==='Space'||e.key==='Enter')){e.preventDefault();keysPressed.add(e.code);doClick(innerWidth/2,innerHeight/2)}})
document.addEventListener('keyup', e=>keysPressed.delete(e.code))

// ruido CRT + scanlines (sutil)
const noiseCanvas = document.createElement('canvas')
noiseCanvas.width = 256; noiseCanvas.height = 256
const nctx = noiseCanvas.getContext('2d')
const noiseData = nctx.createImageData(256,256)
for(let i=0;i<noiseData.data.length;i++) noiseData.data[i] = Math.random()<0.03 ? 255 : 0
nctx.putImageData(noiseData,0,0)

const milestonePhrases = ['el koan despierta','la rueda gira','el centro se revela','mitad del camino','casi satori','la luz se acerca','¡un paso más!']

const tick = now => {
  if (!document.hidden && document.hasFocus()) {
    const δ = BigInt(Math.floor(now-prev))
    if (δ>0n) {
      real_playtime += δ
      const accel = mouseDown||touchActive||keysPressed.size>0
      const mult = 3n * (accel?10n:1n) * (1n<<BigInt(mantraLevel))
      t += δ * mult
      persist()
    }
  }
  prev = now
  breathePhase += 0.008

  if (!zen && t>=KOAN && real_playtime>=MIN_DEVOTION) {
    zen=true; birth=now; flash={msg:'SATORI', time:now}
    note(1310,2,0.4,'triangle')
    setTimeout(()=>note(880,1.5,0.35),300)
    setTimeout(()=>note(659,2,0.3),800)
    persist()
  }

  const progress = Math.min(Number(t)/Number(KOAN), Number(real_playtime)/Number(MIN_DEVOTION))
  const w = innerWidth, h = innerHeight

  // fondo CRT
  ctx.fillStyle = zen ? '#001100' : '#000'
  ctx.fillRect(0,0,w,h)
  ctx.globalAlpha = 0.04
  ctx.drawImage(noiseCanvas,0,0,w,h)
  ctx.globalAlpha = 0.07
  for(let y=0;y<h;y+=2) { ctx.fillStyle = y%4? '#000' : '#003300'; ctx.fillRect(0,y,w,1) }
  ctx.globalAlpha = 1

  if (!zen) {
    const r = Math.min(w,h)*0.36 + Math.sin(breathePhase)*12
    const hue = 90 + Math.sin(breathePhase*0.7)*15

    // glow del círculo
    const grad = ctx.createRadialGradient(w/2,h/2,0,w/2,h/2,r*1.3)
    grad.addColorStop(0, `hsla(${hue},100%,70%,0.9)`)
    grad.addColorStop(0.5, `hsla(${hue},100%,50%,0.3)`)
    grad.addColorStop(1, 'transparent')
    ctx.fillStyle = grad
    ctx.fillRect(w/2-r*1.4, h/2-r*1.4, r*2.8, r*2.8)

    ctx.strokeStyle = `hsl(${hue},100%,${55+Math.sin(breathePhase)*15}%)`
    ctx.lineWidth = 9 + Math.sin(breathePhase)*2
    ctx.beginPath()
    ctx.arc(w/2,h/2,r, -Math.PI/2, -Math.PI/2 + progress*Math.PI*2)
    ctx.stroke()

    // textos devocionales
    ctx.fillStyle = '#0f0'
    ctx.font = 'bold 4.8vw "Courier New", monospace'
    ctx.textAlign = 'center'
    ctx.fillText('mantén el foco', w/2, h*0.68)
    ctx.font = '2.8vw "Courier New", monospace'
    ctx.fillText('SPACE / toque → ×10    presencia → ×3', w/2, h*0.75)

    const mult = 3*(mouseDown||touchActive||keysPressed.size>0?10:1)*(1<<mantraLevel)
    ctx.fillStyle = mantraLevel>=4 ? '#0ff' : mantraLevel>=2 ? '#ff0' : '#0f0'
    ctx.font = 'bold 3.2vw monospace'
    ctx.fillText(`clics ${Number(click Flormat(clicks))} ×${mult}`, w/2, h*0.86)

    ctx.fillStyle = '#0f8'
    ctx.font = '2.2vw monospace'
    ctx.fillText(`devoción ${String(Math.floor(Number(real_playtime)/3600000)).padStart(3)} h`, w/2, h*0.94)
    ctx.font = '1.6vw monospace'
    ctx.fillText(`?ref=${shortId}`, w/2, h-30)
  } else {
    // modo satori – palpito verde dorado
    const pulse = Math.sin((now-birth)*0.0003)*0.2 + 0.8
    ctx.fillStyle = `rgba(0,${120+Math.floor(pulse*135)},0,1)`
    ctx.fillRect(0,0,w,h)

    const τ = (now-birth)%6400000
    const N = 13101310
    const visible = Math.min(N, Math.floor(τ/4))
    const base = τ*0.0008

    for(let i=0;i<visible;i+=Math.max(1,visible/3000)){
      const p = base + i*0.005
      const θ = (i/N)*Math.PI*2 + p*3e-5
      const r = 100 + Math.sin(p*0.7 + i*0.0003)*420
      const x = w/2 + Math.cos(θ)*r
      const y = h/2 + Math.sin(θ)*r
      const a = Math.sin(p*8 + i*0.07)*0.5 + 0.5
      ctx.fillStyle = `rgba(${mantraLevel>=5?255:0},${mantraLevel>=5?220:255},0,${a*0.6})`
      ctx.save()
      ctx.translate(x,y)
      ctx.rotate(θ + p*0.01)
      ctx.fillRect(-18,-44,36,88)
      ctx.fillRect(-44,-18,88,36)
      ctx.restore()
    }

    if (τ>5000000 && τ<5200000){
      ctx.fillStyle = '#ff0'
      ctx.font = 'bold 11vw Georgia'
      ctx.fillText('siempre fuiste vos',w/2,h/2)
    }
  }

  // flashes y mensajes
  if (flash.time && now-flash.time<5000){
    const a = Math.max(0, 1-(now-flash.time)/5000)
    ctx.globalAlpha = a
    ctx.fillStyle = '#0ff'
    ctx.shadowColor = '#0ff'
    ctx.shadowBlur = 40
    ctx.font = 'bold 9vw Georgia'
    ctx.textAlign = 'center'
    ctx.fillText(flash.msg, w/2, h/2)
    ctx.globalAlpha = 1
    ctx.shadowBlur = 0
  }

  // partículas
  for(let i=particles.length-1;i>=0;i--){
    const p = particles[i]
    p.x += p.vx; p.y += p.vy; p.vy += 0.12; p.life--
    if(p.life<=0){particles.splice(i,1);continue}
    ctx.globalAlpha = p.life/100
    ctx.fillStyle = '#0ff'
    ctx.font = 'bold 22px monospace'
    ctx.textAlign = 'center'
    if(p.text) ctx.fillText(p.text, p.x, p.y)
    else {
      ctx.fillRect(p.x-2,p.y-8,4,16)
      ctx.fillRect(p.x-8,p.y-2,16,4)
    }
  }
  ctx.globalAlpha = 1

  requestAnimationFrame(tick)
}
requestAnimationFrame(tick)
</script>