<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>BOAVERSE ‚àû v1.5 ‚Äî Biomas infinitos + Multijugador P2P real</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
:root{--text:#0ff;--bg:#000;--btn:#0ff;--btn-text:#000}
body.dyslexia{font-family:'OpenDyslexic',sans-serif;letter-spacing:0.15em;line-height:1.8}
body.deuteranopia{--text:#0ff;--btn:#00ffff}
body.protanopia{--text:#00f0ff;--btn:#00f0ff}
body.tritanopia{--text:#ff0;--btn:#ffff00}
body.contrast-high{--text:#ff0;--btn:#ff0}
body.contrast-ultra{--text:#fff;--btn:#fff}
body{margin:0;background:var(--bg);color:var(--text);overflow:hidden;height:100dvh;display:flex;flex-direction:column;transition:all .5s;font-family:system-ui}
canvas{flex:1;background:var(--bg)}
#ui{position:fixed;top:0;left:0;right:0;padding:10px;background:rgba(0,0,0,0.8);display:flex;justify-content:space-between;align-items:center;z-index:1000;border-bottom:3px solid var(--text)}
#acc,#multi,#shop{position:fixed;background:rgba(0,0,0,0.9);padding:12px;border:3px solid var(--text);border-radius:12px;z-index:999;max-height:70vh;overflow:auto}
#acc{top:70px;left:10px;display:grid;grid-template-columns:repeat(auto-fit,minmax(110px,1fr));gap:8px}
#multi{top:70px;right:10px;width:350px;display:none}
#multi.show{display:block}
#shop{bottom:150px;right:10px;width:280px}
#chat{bottom:0;left:0;right:0;padding:15px;background:rgba(0,0,0,0.9);display:flex;gap:10px;align-items:center;border-top:3px solid var(--text)}
button,input{font-size:18px;padding:12px;border-radius:10px;border:2px solid var(--text);background:#000;color:var(--text);cursor:pointer}
button{background:var(--btn);color:var(--btn-text)}
.big{font-size:32px !important;padding:20px !important}
.braille{font-family:monospace;font-size:32px;letter-spacing:8px;background:#000;color:#0ff;padding:15px;border:4px solid #0ff;border-radius:12px;position:fixed;bottom:170px;left:50%;transform:translateX(-50%);z-index:999;display:none;white-space:pre}
.braille.show{display:block}
.sign{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:280px;height:280px;z-index:1001;display:none;border:4px solid #0ff;border-radius:20px;background:#000}
textarea{width:100%;height:80px;background:#000;color:var(--text);border:2px solid #0ff;border-radius:8px;padding:10px;font-size:16px;box-sizing:border-box}
@font-face{font-family:'OpenDyslexic';src:url('https://cdn.jsdelivr.net/gh/antijob/OpenDyslexic@latest/opendyslexic3-regular.woff2') format('woff2');}
@media (prefers-reduced-motion:reduce){*{animation:none !important;transition:none !important}}
</style>
</head>
<body aria-live="polite">

<canvas id="c" tabindex="0" aria-label="Mundo infinito BOAVERSE con biomas y jugadores"></canvas>

<div id="ui" role="banner">
  <div>Jugadores: <b id="count" aria-live="polite">1</b> | <span id="biome" aria-live="polite">Abrazo Eterno</span></div>
  <div>
    <button onclick="toggleMulti()" style="font-size:16px;padding:8px 12px">Multi</button>
    BOAVERSE ‚àû v1.5
  </div>
</div>

<div id="acc" role="region" aria-label="Accesibilidad">
  <button onclick="toggleContrast()">Contraste</button>
  <button onclick="toggleDyslexia()">Dislexia</button>
  <button onclick="cycleColorBlind()">Dalt√≥nico</button>
  <button onclick="toggleBig()">Grande</button>
  <button onclick="toggleSign()">Signos</button>
  <button onclick="toggleBraille()">Braille</button>
  <button onclick="toggleVoice()">Voz</button>
  <button onclick="toggleSimple()">Simple</button>
</div>

<div id="multi">
  <h3>üîó Multijugador P2P Real</h3>
  <p><small>1. Host crea oferta, copia SDP</small></p>
  <button onclick="hostRoom()">Crear Sala (Host)</button>
  <textarea id="offerSdp" placeholder="SDP Oferta (copia para joiner)"></textarea>
  <button onclick="copyOffer()">üìã Copiar Oferta</button>
  <p><small>2. Joiner pega oferta, crea answer, copia</small></p>
  <button onclick="joinRoom()">Unirme (Joiner)</button>
  <textarea id="answerSdp" placeholder="SDP Answer (copia para host)"></textarea>
  <button onclick="copyAnswer()">üìã Copiar Answer</button>
  <p><small>3. Host pega answer</small></p>
  <button onclick="setRemoteAnswer()">Pegar Answer (Host)</button>
</div>

<div id="shop" role="region" aria-label="Tienda cosm√©tica opcional">
  <h3>TIENDA ABRAZO</h3>
  <button onclick="buy('dragon')">üêâ Drag√≥n 0,10‚Ç¨</button>
  <button onclick="buy('abismo')">üè† Abismo 0,20‚Ç¨</button>
  <button onclick="buy('boa')">üêç Boa 0,05‚Ç¨</button>
  <button onclick="buy('aura')">‚ú® Aura 0,15‚Ç¨</button>
  <small>50% IA accesibilidad ¬∑ 50% creador</small>
</div>

<div id="chat">
  <input id="chatInput" placeholder="Chat local..." maxlength="80">
  <button onclick="sendChat()">Enviar</button>
</div>

<img id="signImg" class="sign" alt="Lengua de signos">
<div id="brailleDiv" class="braille" aria-live="assertive"></div>

<script>
const canvas = document.getElementById('c');
const ctx = canvas.getContext('2d');
canvas.width = innerWidth; canvas.height = innerHeight;
window.onresize = () => {canvas.width = innerWidth; canvas.height = innerHeight;};

const lang = navigator.language.slice(0,2);
const texts = {
  es: {
    biomes: ['Abrazo Eterno','Bosque Drag√≥n','Abismo Arm√≥nico','Perreo Fantasma','Ciudad Boa']
  },
  en: {
    biomes: ['Eternal Hug','Dragon Forest','Harmonic Abyss','Ghost Perreo','Boa City']
  }
};
const t = texts[lang] || texts.es;

// BIOMAS
const biomes = [
  {name: t.biomes[0], bg: '#ff1493', particle: '#ffc0cb', freq: 220, particles: true},
  {name: t.biomes[1], bg: '#228b22', particle: '#90ee90', freq: 330, trees: true},
  {name: t.biomes[2], bg: '#00008b', particle: '#add8e6', freq: 165, waves: true},
  {name: t.biomes[3], bg: '#ff69b4', particle: '#ffff00', freq: 440, disco: true},
  {name: t.biomes[4], bg: '#ffd700', particle: '#ff8c00', freq: 523, buildings: true}
];

function getBiome(wx, wy) {
  const hash = (Math.sin(wx * 0.0008) * 43758.5453 + Math.sin(wy * 0.0008) * 12345.6789) % 5;
  return Math.floor(Math.abs(hash));
}

// JUGADOR
const player = {
  id: 'p' + Math.random().toString(36).slice(2,7),
  worldX: 0, worldY: 0, color: `hsl(${Math.random()*360},100%,60%)`, item: '', name: 'Pibe'
};
const otherPlayers = {};
let camX = 0, camY = 0;
let lastBiome = -1;
const particles = [];

// KEYS
const keys = {};
window.onkeydown = e => keys[e.key.toLowerCase()] = true;
window.onkeyup = e => keys[e.key.toLowerCase()] = false;

// CLICK TELEPORT (touch friendly)
canvas.onclick = canvas.ontouchstart = e => {
  const rect = canvas.getBoundingClientRect();
  const x = (e.clientX || e.touches[0].clientX) - rect.left + camX - canvas.width/2;
  const y = (e.clientY || e.touches[0].clientY) - rect.top + camY - canvas.height/2;
  player.worldX = x;
  player.worldY = y;
  speak('Teleportado');
};

// MULTIJUGADOR P2P WEBRTC
let pc = null, dc = null;
function copyText(text) {
  navigator.clipboard.writeText(text).then(() => speak('Copiado'));
}
async function hostRoom() {
  pc = new RTCPeerConnection({
    iceServers: [
      {urls: 'stun:stun.l.google.com:19302'},
      {urls: 'stun:stun1.l.google.com:19302'}
    ]
  });
  dc = pc.createDataChannel('boaverse');
  dc.onopen = () => { speak('Conectado P2P'); document.getElementById('count').textContent = '2'; };
  dc.onmessage = e => {
    const data = JSON.parse(e.data);
    otherPlayers[data.id] = data;
    document.getElementById('count').textContent = Object.keys(otherPlayers).length + 1;
  };
  const offer = await pc.createOffer();
  await pc.setLocalDescription(offer);
  document.getElementById('offerSdp').value = JSON.stringify(pc.localDescription);
  speak('Sala creada, copia oferta');
}
async function joinRoom() {
  const offerStr = document.getElementById('offerSdp').value;
  if(!offerStr) return speak('Pega oferta primero');
  const offer = JSON.parse(offerStr);
  pc = new RTCPeerConnection({iceServers: [{urls: 'stun:stun.l.google.com:19302'}]});
  pc.ondatachannel = e => {
    dc = e.channel;
    dc.onopen = () => speak('Conectado P2P');
    dc.onmessage = e => {
      const data = JSON.parse(e.data);
      otherPlayers[data.id] = data;
      document.getElementById('count').textContent = Object.keys(otherPlayers).length + 1;
    };
  };
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  document.getElementById('answerSdp').value = JSON.stringify(pc.localDescription);
  speak('Answer listo, copia');
}
async function setRemoteAnswer() {
  const answerStr = document.getElementById('answerSdp').value;
  if(!answerStr) return speak('Pega answer primero');
  const answer = JSON.parse(answerStr);
  await pc.setRemoteDescription(answer);
  speak('¬°Jugando juntos!');
}
function copyOffer() { copyText(document.getElementById('offerSdp').value); }
function copyAnswer() { copyText(document.getElementById('answerSdp').value); }
function sendState() {
  if(dc && dc.readyState === 'open') {
    dc.send(JSON.stringify({
      id: player.id,
      worldX: player.worldX,
      worldY: player.worldY,
      color: player.color,
      item: player.item,
      name: player.name
    }));
  }
}
setInterval(sendState, 50);

// COMPRA
function buy(item) {
  player.item = item;
  speak(`Cosm√©tico ${item} comprado`);
  window.open(`https://www.paypal.com/cgi-bin/webscr?cmd=_xclick&business=ferry420oficial@gmail.com&item_name=BOAVERSE_${item}&amount=0.10¬§cy_code=EUR&custom=50pct_IA_accesibilidad`,'_blank');
}

// ACCESIBILIDAD (mismo que antes)
let contrast=0, dyslexia=false, cb=0, big=false, brailleOn=false, voice=false, simple=false;
function toggleContrast(){contrast=(contrast+1)%3;document.body.className=['','contrast-high','contrast-ultra'][contrast];}
function toggleDyslexia(){dyslexia=!dyslexia;document.body.classList.toggle('dyslexia',dyslexia);}
function cycleColorBlind(){cb=(cb+1)%4;document.body.className=['','deuteranopia','protanopia','tritanopia'][cb];}
function toggleBig(){big=!big;document.querySelectorAll('button,input,#ui').forEach(el=>el.classList.toggle('big',big));}
function toggleSign(){document.getElementById('signImg').style.display='block';setTimeout(()=>document.getElementById('signImg').style.display='none',3000);}
function toggleBraille(){brailleOn=!brailleOn;document.getElementById('brailleDiv').classList.toggle('show',brailleOn);}
function toggleVoice(){voice=!voice;speak(voice?'Voz on':'Voz off');}
function toggleSimple(){simple=!simple;document.getElementById('multi').style.display='none';document.getElementById('shop').style.display=simple?'none':'block';}
function speak(msg){if(voice){const u=new SpeechSynthesisUtterance(msg);u.lang=lang+'-ES';speechSynthesis.speak(u);}updateBraille(msg);}
function updateBraille(msg){if(brailleOn)document.getElementById('brailleDiv').textContent=toBraille(msg);}
const brailleMap = {'a':'‚†Å','b':'‚†É','c':'‚†â','d':'‚†ô','e':'‚†ë','f':'‚†ã','g':'‚†õ','h':'‚†ì','i':'‚†ä','j':'‚†ö','k':'‚†Ö','l':'‚†á','m':'‚†ç','n':'‚†ù','o':'‚†ï','p':'‚†è','q':'‚†ü','r':'‚†ó','s':'‚†é','t':'‚†û','u':'‚†•','v':'‚†ß','w':'‚†∫','x':'‚†≠','y':'‚†Ω','z':'‚†µ',' ':'‚†Ä','.':'‚†≤',',':'‚†Ç','!':'‚†ñ','?':'‚†¶','0':'‚†¥','1':'‚†Ç','2':'‚†Ü','3':'‚†í','4':'‚†≤','5':'‚†¢','6':'‚†ñ','7':'‚†∂','8':'‚†¶','9':'‚†î'};
function toBraille(str){return str.toLowerCase().split('').map(c=>brailleMap[c]||c).join('');}

// CHAT LOCAL
function sendChat(){const msg=document.getElementById('chatInput').value.trim();if(msg){speak('Chat: '+msg);document.getElementById('chatInput').value='';}}

// UI TOGGLES
function toggleMulti(){document.getElementById('multi').classList.toggle('show');}

// LOOP PRINCIPAL
function loop(){
  // Movimiento
  let vx = 0, vy = 0;
  if(keys['a']||keys['arrowleft']) vx -= 4;
  if(keys['d']||keys['arrowright']) vx += 4;
  if(keys['w']||keys['arrowup']) vy -= 4;
  if(keys['s']||keys['arrowdown']) vy += 4;
  player.worldX += vx;
  player.worldY += vy;

  // Camara
  camX = player.worldX - canvas.width / 2;
  camY = player.worldY - canvas.height / 2;

  // Bioma
  const biomeId = getBiome(player.worldX, player.worldY);
  if(biomeId !== lastBiome){
    lastBiome = biomeId;
    const b = biomes[biomeId];
    document.getElementById('biome').textContent = b.name;
    speak(b.name);
    updateBraille(b.name);
    // Vibracion
    if('vibrate' in navigator) navigator.vibrate(150);
    // Reset particles
    particles.length = 0;
  }
  const currentBiome = biomes[biomeId];

  // Clear
  ctx.fillStyle = currentBiome.bg + '20';
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  ctx.translate(-camX, -camY);

  // Terreno procedural
  const tileSize = 80;
  for(let tx = Math.floor(camX / tileSize); tx < Math.ceil((camX + canvas.width) / tileSize); tx++){
    for(let ty = Math.floor(camY / tileSize); ty < Math.ceil((camY + canvas.height) / tileSize); ty++){
      const wx = tx * tileSize, wy = ty * tileSize;
      const bId = getBiome(wx, wy);
      const b = biomes[bId];
      const height = Math.sin(wx * 0.01 + wy * 0.01) * 30 + Math.sin(wx * 0.005 + wy * 0.005 + Date.now() * 0.001) * 10;
      ctx.fillStyle = b.bg + (height > 0 ? '88' : '44');
      ctx.fillRect(wx, wy + height, tileSize, tileSize - height);
    }
  }

  // Particulas biome-specific
  for(let i = particles.length - 1; i >= 0; i--){
    const p = particles[i];
    p.x += p.vx + Math.sin(Date.now() * 0.001 + p.id) * 0.5;
    p.y += p.vy + Math.cos(Date.now() * 0.0015 + p.id) * 0.5;
    if(p.life-- < 0){
      particles.splice(i, 1);
      continue;
    }
    ctx.save();
    ctx.globalAlpha = p.life / 100;
    ctx.fillStyle = currentBiome.particle;
    ctx.fillRect(p.x, p.y, 4, 4);
    ctx.restore();
  }
  if(particles.length < 800 + biomeId * 200){
    for(let i = 0; i < 5; i++){
      particles.push({
        x: player.worldX + (Math.random() - 0.5) * 1000,
        y: player.worldY + (Math.random() - 0.5) * 1000,
        vx: (Math.random() - 0.5) * 2,
        vy: (Math.random() - 0.5) * 2,
        life: 100 + Math.random() * 50,
        id: Math.random()
      });
    }
  }

  // Jugadores
  // Yo
  ctx.fillStyle = player.color;
  ctx.beginPath();
  ctx.arc(player.worldX, player.worldY, 25, 0, Math.PI * 2);
  ctx.fill();
  if(player.item){
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 24px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(player.item === 'boa' ? 'üêç' : player.item === 'dragon' ? 'üêâ' : '‚ú®', player.worldX, player.worldY - 35);
  }

  // Otros
  for(const id in otherPlayers){
    const op = otherPlayers[id];
    ctx.fillStyle = op.color;
    ctx.beginPath();
    ctx.arc(op.worldX, op.worldY, 25, 0, Math.PI * 2);
    ctx.fill();
    ctx.fillStyle = '#fff';
    ctx.font = '20px Arial';
    ctx.textAlign = 'center';
    ctx.fillText(id.slice(0,4), op.worldX, op.worldY - 40);
    if(op.item){
      ctx.fillText(op.item === 'boa' ? 'üêç' : '‚ú®', op.worldX, op.worldY - 10);
    }
  }

  ctx.restore();

  requestAnimationFrame(loop);
}
loop();

// Init
speak('Bienvenido a BOAVERSE ‚àû con biomas infinitos y multijugador real');
document.getElementById('signImg').src = 'https://media.giphy.com/media/26ufnwz3wDUlj5gxC/giphy.gif'; // abrazo sign
toggleSign();
</script>

<small style="position:fixed;bottom:5px;left:5px;opacity:0.7;color:#0ff;font-size:12px">
  v1.5 Biomas ‚àû + P2P real ¬∑ 100% inclusivo ¬∑ C√≥digo libre ¬∑ 50% IA diversidad funcional
</small>
</body>
</html>