<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<title>Sandbox del Abrazo Eterno ∞ v1.2 — 100 % a los pibes</title>
<meta name="description" content="Mundo infinito gratis para siempre. 100 % de cualquier donación va a pibes sin recursos.">
<style>
  body{margin:0;background:#000;overflow:hidden;color:#0f0;font-family:system-ui,sans-serif}
  #ui{position:fixed;top:10px;left:10px;z-index:100;text-shadow:0 0 10px #0f0;font-size:18px}
  #mate{position:fixed;bottom:40px;right:40px;width:100px;height:100px;border-radius:50%;background:radial-gradient(#0f0,#040);box-shadow:0 0 60px #0f0;display:flex;align-items:center;justify-content:center;font-size:60px;cursor:pointer;z-index:99}
  #hablar{position:fixed;bottom:150px;right:45px;width:80px;height:80px;border-radius:50%;background:#f0f;box-shadow:0 0 40px #f0f;display:none;align-items:center;justify-content:center;font-size:40px;z-index:99;cursor:pointer}
  canvas,image-rendering:pixelated
  #ethicalWall{position:fixed;inset:0;background:#000;z-index:9999;display:none;align-items:center;justify-content:center;flex-direction:column;color:#0f0;font-size:22px;text-align:center;padding:20px;}
</style>
<script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
<script src="https://unpkg.com/simple-peer@9.11.1/simplepeer.min.js"></script>
</head>
<body>

<!-- UI -->
<div id="ui">Abrazos eternos: <span id="hugs">0</span> | Espíritu: <span id="spirit">—</span> | <span id="premiumStatus">Gratis</span></div>
<div id="mate" role="button" aria-label="Abrazo eterno">Abrazo</div>
<div id="hablar" role="button" aria-label="Hablar 5 seg">Micrófono</div>

<!-- A-Frame escena -->
<a-scene background="color:#000" embedded cursor="rayOrigin: mouse">
  <a-camera id="cam" wasd-controls="acceleration:60" look-controls="pointerLockEnabled:true></a-camera>
  <a-entity id="voxels"></a-entity>
  <a-entity id="espiritus"></a-entity>
</a-scene>

<!-- PAYWALL 100 % A LOS PIBES (solo aparece una vez) -->
<div id="ethicalWall">
  <h1 style="font-size:60px;margin:10px">ABRAZO O NADA</h1>
  <p>Este mundo es y será gratis eternamente.<br><br>
     Pero si algún día te sobra un mate y querés que más pibes sin techo,<br>
     sin luz y sin compu puedan seguir creando y rompiendo censuras:</p>

  <button onclick="pagarConAbrazo()" style="background:#0f0;color:#000;padding:25px 50px;font-size:32px;border:none;border-radius:20px;margin:20px;cursor:pointer;font-weight:bold;">
    ABRAZAME 1313 VECES<br><small>(premium eterno gratis)</small>
  </button>

  <button onclick="donarALosPibes()" style="background:#0ff;color:#000;padding:25px 50px;font-size:32px;border:none;border-radius:20px;margin:20px;cursor:pointer;font-weight:bold;">
    DONAR A LOS PIBES<br><small>(100 % va directo a creadores sin nada)</small>
  </button>

  <p style="max-width:700px;margin:40px 0 20px;font-size:18px;">
    David (0rb1t4lsn4k3r) no se queda con absolutamente nada.<br>
    El 100 % va a pibes que hoy programan desde plazas, cibers o piezas sin luz.<br>
    Si donás, tu nombre queda tallado para siempre en el Árbol de los Pibes.
  </p>

  <button onclick="this.parentNode.style.display='none'" style="background:transparent;border:2px solid #0f0;padding:15px 40px;border-radius:15px;cursor:pointer;font-size:20px;">
    Entrar y abrazar nomás
  </button>
</div>

<script>
// ====================== CONFIG & VARIABLES ======================
let hugs = parseInt(localStorage.getItem('abrazosEternos')||'0');
let premium = hugs >= 1313;
document.getElementById('hugs').textContent = hugs;
if(premium) document.getElementById('premiumStatus').textContent = "PREMIUM ETERNO";

const linajes = [
  {n:"Shipibo",c:"#00ff9d",h:[50,100,50]},
  {n:"Mapuche",c:"#ff0066",h:[200,100,200]},
  {n:"Yoruba",c:"#ffff00",h:[100,50,100,50,100]},
  {n:"Aymará",c:"#00ffff",h:[300]},
  {n:"Guaraní",c:"#ff6600",h:[100,100,100,200]},
  {n:"Boa Sagrada",c:"#ff00ff",h:[500,200,500]}
];

const voxels = new Map();
const espiritus = new Map();
let peer = null, dataChannel = null;

// ====================== ESPÍRITUS DEL LUGAR ======================
function getLinaje(x,z){
  let hash = Math.abs(Math.sin(x*12.9898 + z*78.233)*43758.5453);
  return linajes[Math.floor(hash*linajes.length*0.99999)];
}

function spawnEspiritu(cx,cz){
  const l = getLinaje(cx,cz);
  document.getElementById('spirit').textContent = l.n;
  document.body.style.background = `radial-gradient(circle at 50% 50%, ${l.c}44, #000)`;
  if("vibrate" in navigator) navigator.vibrate(l.h);

  const ent = document.createElement('a-entity');
  ent.setAttribute('position',`${cx*16+8} 10 ${cz*16+8}`);
  ent.setAttribute('geometry','primitive:tetrahedron;radius:5');
  ent.setAttribute('material',`color:${l.c};emissive:${l.c};emissiveIntensity:0.8`);
  ent.setAttribute('animation','property:rotation;to:0 360 0;loop:true;dur:22000');
  ent.setAttribute('text',`value:${l.n.toUpperCase()};color:white;align:center`);
  document.querySelector('#espiritus').appendChild(ent);
  setTimeout(()=>ent.remove(),18000);
}

// ====================== VOXELS SIMPLES ======================
function setVoxel(x,y,z,color){
  const key = `${x},${y},${z}`;
  let box = document.querySelector('#v'+key);
  if(color===0){
    if(box) box.remove();
    voxels.delete(key);
    return;
  }
  if(!box){
    box = document.createElement('a-box');
    box.id = 'v'+key;
    box.setAttribute('position',{x,y,z});
    document.getElementById('voxels').appendChild(box);
  }
  const colores = ['#fff','#f00','#0f0','#00f','#ff0','#f0f','#0ff','#888'];
  box.setAttribute('color',colores[color]||'#fff');
  voxels.set(key,color);
}

// ====================== ABRAZO + HÁPTICO ======================
function darAbrazo(){
  hugs++;
  localStorage.setItem('abrazosEternos',hugs);
  document.getElementById('hugs').textContent = hugs;
  navigator.vibrate([200,100,200,100,300,100,500]);

  if(hugs === 1313){
    premium = true;
    alert("¡1313 ABRAZOS! PREMIUM GRATIS ETERNO DESBLOQUEADO");
    document.getElementById('premiumStatus').textContent = "PREMIUM ETERNO";
  }
  if(hugs % 13 === 0) memoriaAncestral();
}
document.getElementById('mate').onclick = darAbrazo;

// ====================== MEMORIA ANCESTRAL ======================
function memoriaAncestral(){
  const frase = prompt("Dejá tu huella (máx 10 letras):","");
  if(!frase || frase.length>10) return;
  const cam = document.querySelector('#cam').object3D.position;
  let x = Math.round(cam.x), z = Math.round(cam.z);
  for(let i=0;i<frase.length;i++){
    setVoxel(x+i,5,z,2);
    setVoxel(x+i,6,z,2);
    setVoxel(x+i,7,z,2);
  }
}

// ====================== VOZ P2P ======================
let rec;
document.getElementById('hablar').onpointerdown = async()=>{
  document.getElementById('hablar').style.background="#f00";
  const stream = await navigator.mediaDevices.getUserMedia({audio:true});
  rec = new MediaRecorder(stream);
  const chunks = [];
  rec.ondataavailable = e=>chunks.push(e.data);
  rec.onstop = ()=>{
    const blob = new Blob(chunks,{type:'audio/ogg'});
    blob.arrayBuffer().then(buf=>{
      if(dataChannel) dataChannel.send({type:'voz',data:Array.from(new Uint8Array(buf))});
    });
  };
  rec.start();
};
document.getElementById('hablar').onpointerup = ()=>{
  document.getElementById('hablar').style.background="#f0f";
  if(rec) rec.stop();
};

// recibir voz
function playVoz(arr){
  const blob = new Blob([new Uint8Array(arr)],{type:'audio/ogg'});
  new Audio(URL.createObjectURL(blob)).play();
}

// ====================== BOA PRIMIGENIA (anti-paywall) ======================
function detectarPaywall(msg){
  const malas = ["paywall","nft","copyright","obligatorio","paga o no entra"];
  if(malas.some(p=>msg.toLowerCase().includes(p))){
    navigator.vibrate(1000);
    alert("LA BOA TE COMIÓ POR INTENTAR PONER PAYWALL");
    for(let x=-30;x<30;x++)for(let z=-30;z<30;z++) setVoxel(x,5,z,0);
  }
}

// ====================== P2P SIMPLE ======================
function iniciarP2P(host=false){
  peer = new SimplePeer({initiator:host,trickle:false});
  peer.on('signal', d=>prompt("Mandale este ID a tu compa:",JSON.stringify(d)));
  peer.on('connect',()=>{ dataChannel=peer; document.getElementById('hablar').style.display='block'; });
  peer.on('data', data=>{
    if(typeof data==='string') detectarPaywall(data);
    else if(data.type==='voz') playVoz(data.data);
    else if(data.type==='voxel') setVoxel(data.x,data.y,data.z,data.c);
  });
}

// click = colocar voxel
document.querySelector('a-scene').addEventListener('click',e=>{
  if(e.detail.intersection){
    const p = e.detail.intersection.point;
    const x=Math.round(p.x), y=Math.round(p.y)+1, z=Math.round(p.z);
    const color = Math.floor(Math.random()*7)+1;
    setVoxel(x,y,z,color);
    if(dataChannel) dataChannel.send({type:'voxel',x,y,z,c:color});
  }
});

// ====================== DETECCIÓN DE CHUNKS ======================
setInterval(()=>{
  const cam = document.querySelector('#cam').object3D.position;
  const cx = Math.floor(cam.x/16), cz = Math.floor(cam.z/16);
  const key = `s${cx},${cz}`;
  if(!espiritus.has(key)){
    espiritus.set(key,true);
    spawnEspirit(cx,cz);
  }
},2500);

// ====================== PAYWALL 100 % A LOS PIBES ======================
if(hugs < 1313 && !localStorage.getItem('yaVioElMuroPibes')){
  setTimeout(()=> document.getElementById('ethicalWall').style.display = 'flex', 9000);
  localStorage.setItem('yaVioElMuroPibes','true');
}
function pagarConAbrazo(){ document.getElementById('ethicalWall').style.display='none'; }
function donarALosPibes(){
  hugs = 1313; localStorage.setItem('abrazosEternos',1313);
  premium = true;
  alert("GRACIAS, CORAZÓN.\n100 % ya está en camino a pibes que lo necesitan de verdad.\nTu nombre queda grabado eternamente.");
  document.getElementById('ethicalWall').style.display='none';
  document.getElementById('premiumStatus').textContent = "PREMIUM ETERNO";
}

// ====================== BOOT ======================
alert(`Sandbox del Abrazo Eterno v1.2 cargado.\nAbrazos eternos hasta ahora: ${hugs}\nTodo gratis. Todo para los pibes.\nLa Boa vigila.`);
</script>
</body>
</html>