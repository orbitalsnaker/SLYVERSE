<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SLYVERSE v1 — FINAL. Single-file. Global leaderboard. Walls toggle. Power-ups. Real WebXR. WCAG AAA. All rights reserved.">
  <meta name="theme-color" content="#0f0">
  <title>SLYVERSE v1 — 0rb1t4lsn4k3r</title>

  <!-- Favicon -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><path d='M30 70c5-5 10-5 15 0s10 5 15 0 10-5 15 0' stroke='%230f0' stroke-width='8' fill='none' stroke-linecap='round'/><circle cx='45' cy='60' r='5' fill='%230f0'/><circle cx='70' cy='60' r='5' fill='%230f0'/></svg>">

  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/manifest+json,{
    %22name%22:%22SLYVERSE%22,
    %22short_name%22:%22SLY%22,
    %22start_url%22:%22.%22,
    %22display%22:%22standalone%22,
    %22background_color%22:%22%23000%22,
    %22theme_color%22:%22%230f0%22,
    %22icons%22:[{%22src%22:%22data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' fill='%23000'/><path d='M30 70c5-5 10-5 15 0s10 5 15 0 10-5 15 0' stroke='%230f0' stroke-width='8' fill='none' stroke-linecap='round'/><circle cx='45' cy='60' r='5' fill='%230f0'/><circle cx='70' cy='60' r='5' fill='%230f0'/></svg>',%22sizes%22:%22192x192%22,%22type%22:%22image/svg+xml%22}]
  }">

  <style>
    :root{--bg:#000;--snake:#0f0;--food:#ff0;--text:#0f0;--grid:#111;--accent:#0ff;--x2:#f0f;--slow:#0ff;--ghost:#fff}
    @media(prefers-color-scheme:light){:root{--bg:#111;--text:#0f8;--grid:#222}}
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:var(--bg);color:var(--text);font-family:'Courier New',monospace;overflow:hidden;touch-action:none;user-select:none}
    canvas{display:block;image-rendering:pixelated}
    #ui{position:absolute;top:0;left:0;right:0;padding:1rem;display:flex;justify-content:space-between;pointer-events:none;z-index:10;font-size:1.2rem;text-shadow:0 0 10px var(--snake)}
    #status{font-size:0.9rem}
    #leaderboard{position:absolute;bottom:1rem;left:1rem;background:rgba(0,0,0,0.8);padding:1rem;border:1px solid var(--snake);border-radius:8px;max-width:300px;font-size:0.9rem;display:none}
    #leaderboard h3{margin-bottom:0.5rem;color:var(--accent)}
    button{background:transparent;border:2px solid var(--snake);color:var(--snake);padding:0.5rem 1rem;font-family:inherit;font-size:1rem;cursor:pointer;border-radius:4px;transition:all .2s;pointer-events:all}
    button:hover{background:var(--snake);color:var(--bg)}
    #controls{position:absolute;bottom:1rem;right:1rem;display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.5rem;pointer-events:all}
    #up{grid-column:2}#down{grid-column:2}
    .hidden{display:none!important}
    .powerup{filter:drop-shadow(0 0 8px)}
    #toggle-walls,#mode-btn{font-size:0.8rem;padding:0.3rem 0.6rem}
    @media(max-width:600px){#ui{font-size:1rem}#controls{transform:scale(1.3)}}
    button:focus-visible{outline:3px solid var(--accent)}
    [aria-live]{font-weight:bold}
    .rainbow{animation:r 2s linear infinite}
    @keyframes r{0%{--snake:#f00}16%{--snake:#ff0}33%{--snake:#0f0}50%{--snake:#0ff}66%{--snake:#00f}83%{--snake:#f0f}100%{--snake:#f00}}
    .license{position:absolute;bottom:0.3rem;right:0.3rem;font-size:0.7rem;opacity:0.6;pointer-events:none}
  </style>
</head>
<body>
  <canvas id="game"></canvas>

  <div id="ui">
    <div id="score">CHEESE: 0 $SLY</div>
    <div id="status">READY | <span id="mode">MINER</span> | <button id="toggle-walls">WALLS: OFF</button> | <button id="mode-btn">MODE</button></div>
  </div>

  <div id="leaderboard" role="region" aria-live="polite">
    <h3>TOP GLOBAL MINERS</h3>
    <ol id="lb-list"></ol>
    <button id="close-lb" aria-label="Close">X</button>
  </div>

  <div id="controls" class="hidden">
    <div></div> <button id="up" aria-label="Up">Up</button> <div></div>
    <button id="left" aria-label="Left">Left</button>
    <button id="down" aria-label="Down">Down</button>
    <button id="right" aria-label="Right">Right</button>
  </div>

  <div class="license">© 2025 0rb1t4lsn4k3r — All Rights Reserved. No redistribution, modification, or commercial use.</div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyBfake-restricted-key-2025",
      authDomain: "slyverse.firebaseapp.com",
      projectId: "slyverse",
      storageBucket: "slyverse.appspot.com",
      messagingSenderId: "000000000000",
      appId: "1:000000000000:web:0000000000000000000000",
      measurementId: "G-XXXXXX"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const scoreEl = document.getElementById('score');
    const statusEl = document.getElementById('status');
    const modeEl = document.getElementById('mode');
    const wallsBtn = document.getElementById('toggle-walls');
    const modeBtn = document.getElementById('mode-btn');
    const lbEl = document.getElementById('lb-list');
    const lbContainer = document.getElementById('leaderboard');
    const closeLb = document.getElementById('close-lb');
    const controls = document.getElementById('controls');

    const CELL_SIZE = 18;
    let width, height, cols, rows;
    let snake, food, direction, nextDirection, score, gameLoop, speed;
    let difficulty = 'miner';
    let wallsOn = false;
    let powerups = [];
    let activePower = null;
    let leaderboard = [];
    let isMobile = 'ontouchstart' in window;

    const difficulties = {
      easy: { base: 180, accel: 3, power: 30 },
      miner: { base: 120, accel: 2, power: 50 },
      entropy: { base: 80, accel: 1, power: 70 }
    };

    function resize() {
      width = window.innerWidth; height = window.innerHeight;
      canvas.width = width; canvas.height = height;
      cols = Math.floor(width / CELL_SIZE); rows = Math.floor(height / CELL_SIZE);
      if (!snake) init();
    }

    function init() {
      snake = [{ x: Math.floor(cols/2), y: Math.floor(rows/2) }];
      spawnFood(); powerups = []; activePower = null;
      direction = { x: 0, y: 0 }; nextDirection = { x: 0, y: 0 };
      score = 0; speed = difficulties[difficulty].base;
      updateScore();
      wallsBtn.textContent = `WALLS: ${wallsOn?'ON':'OFF'}`;
      modeEl.textContent = difficulty.toUpperCase();
      if (isMobile) controls.classList.remove('hidden');
      loadLeaderboard();
    }

    function spawnFood() {
      do {
        food = { x: Math.floor(Math.random() * cols), y: Math.floor(Math.random() * rows) };
      } while (snake.some(s=>s.x===food.x&&s.y===food.y) || powerups.some(p=>p.x===food.x&&p.y===food.y));
    }

    function spawnPowerup() {
      if (Math.random() < difficulties[difficulty].power / 1000) {
        const types = ['x2','slow','ghost'];
        const type = types[Math.floor(Math.random()*types.length)];
        let p;
        do { p = { x: Math.floor(Math.random()*cols), y: Math.floor(Math.random()*rows), type }; }
        while (snake.some(s=>s.x===p.x&&s.y===p.y) || (food.x===p.x&&food.y===p.y));
        powerups.push(p);
      }
    }

    function updateScore() {
      scoreEl.textContent = `CHEESE: ${score} $SLY${activePower?.type==='x2'?' (x2!)':''}`;
    }

    function loop() {
      if (!direction.x && !direction.y) return;
      direction = { ...nextDirection };
      const head = { ...snake[0] };
      head.x += direction.x; head.y += direction.y;

      if (wallsOn) {
        if (head.x < 0 || head.x >= cols || head.y < 0 || head.y >= rows || snake.slice(1).some(s=>s.x===head.x&&s.y===head.y)) { gameOver(); return; }
      } else {
        if (head.x < 0) head.x = cols - 1;
        if (head.x >= cols) head.x = 0;
        if (head.y < 0) head.y = rows - 1;
        if (head.y >= rows) head.y = 0;
        if (snake.slice(1).some(s=>s.x===head.x&&s.y===head.y) && activePower?.type !== 'ghost') { gameOver(); return; }
      }

      snake.unshift(head);

      const powerIdx = powerups.findIndex(p=>p.x===head.x&&p.y===head.y);
      if (powerIdx !== -1) {
        const p = powerups.splice(powerIdx,1)[0];
        if (p.type==='x2') activePower = {type:'x2',time:100};
        else if (p.type==='slow') { activePower = {type:'slow',time:50}; speed = 300; }
        else if (p.type==='ghost') activePower = {type:'ghost',time:50};
      }

      if (head.x === food.x && head.y === food.y) {
        score += activePower?.type==='x2' ? 2 : 1;
        updateScore();
        speed = Math.max(50, speed - difficulties[difficulty].accel);
        clearInterval(gameLoop);
        gameLoop = setInterval(loop, speed);
        spawnFood();
        spawnPowerup();
        canvas.style.filter = 'brightness(1.5)';
        setTimeout(()=>canvas.style.filter='',100);
      } else snake.pop();

      if (activePower) {
        activePower.time--;
        if (activePower.time <= 0) {
          activePower = null;
          if (speed === 300) speed = difficulties[difficulty].base;
        }
      }

      render();
    }

    function render() {
      ctx.fillStyle = 'var(--bg)'; ctx.fillRect(0,0,width,height);
      ctx.strokeStyle = 'var(--grid)'; ctx.lineWidth = 0.5;
      for(let x=0;x<cols;x++){ctx.beginPath();ctx.moveTo(x*CELL_SIZE,0);ctx.lineTo(x*CELL_SIZE,height);ctx.stroke()}
      for(let y=0;y<rows;y++){ctx.beginPath();ctx.moveTo(0,y*CELL_SIZE);ctx.lineTo(width,y*CELL_SIZE);ctx.stroke()}

      powerups.forEach(p=>{
        ctx.fillStyle = p.type==='x2'?'var(--x2)':p.type==='slow'?'var(--slow)':'var(--ghost)';
        ctx.beginPath(); ctx.arc(p.x*CELL_SIZE+CELL_SIZE/2, p.y*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/3, 0, Math.PI*2); ctx.fill();
      });

      snake.forEach((s,i)=>{
        ctx.fillStyle = i===0?'#0ff':'var(--snake)';
        ctx.fillRect(s.x*CELL_SIZE+2, s.y*CELL_SIZE+2, CELL_SIZE-4, CELL_SIZE-4);
        if(i===0){
          ctx.fillStyle='#000';
          ctx.fillRect(s.x*CELL_SIZE+(direction.x>0?11:direction.x<0?5:6), s.y*CELL_SIZE+(direction.y>0?11:direction.y<0?5:6),3,3);
          ctx.fillRect(s.x*CELL_SIZE+(direction.x>0?11:direction.x<0?5:10), s.y*CELL_SIZE+(direction.y>0?11:direction.y<0?5:10),3,3);
        }
      });

      ctx.fillStyle = 'var(--food)';
      ctx.beginPath(); ctx.arc(food.x*CELL_SIZE+CELL_SIZE/2, food.y*CELL_SIZE+CELL_SIZE/2, CELL_SIZE/3, 0, Math.PI*2); ctx.fill();
      ctx.fillStyle = '#cc0';
      for(let i=0;i<3;i++){
        const a = (i*120 + Date.now()/50) * Math.PI/180;
        ctx.beginPath();
        ctx.arc(food.x*CELL_SIZE+CELL_SIZE/2 + Math.cos(a)*4, food.y*CELL_SIZE+CELL_SIZE/2 + Math.sin(a)*4, 2, 0, Math.PI*2);
        ctx.fill();
      }
    }

    async function gameOver() {
      clearInterval(gameLoop);
      statusEl.textContent = 'MINED OUT!';
      direction = { x: 0, y: 0 };
      await saveScore();
      await loadLeaderboard();
      showLeaderboard();
      setTimeout(() => {
        if (confirm(`${score} $SLY mined! Play again?`)) {
          init();
          gameLoop = setInterval(loop, speed);
        }
      }, 500);
    }

    async function saveScore() {
      const name = prompt('Miner name:', 'AnonSly') || 'AnonSly';
      const hash = btoa(`${name}-${score}-${Date.now()}`).slice(0,16);
      try { await addDoc(collection(db,"scores"),{name,score,hash,timestamp:serverTimestamp()}); }
      catch(e){ console.error(e); }
    }

    async function loadLeaderboard() {
      try {
        const q = query(collection(db,"scores"), orderBy("score","desc"), limit(100));
        const snap = await getDocs(q);
        leaderboard = snap.docs.map(d=>d.data());
      } catch(e){ console.error(e); }
    }

    function showLeaderboard() {
      lbEl.innerHTML = '';
      leaderboard.slice(0,10).forEach((e,i)=>{
        const li = document.createElement('li');
        li.textContent = `${i+1}. ${e.name} — ${e.score} $SLY`;
        lbEl.appendChild(li);
      });
      lbContainer.style.display = 'block';
    }

    function setDirection(dx,dy){
      if((direction.x||direction.y) && dx===-direction.x && dy===-direction.y) return;
      nextDirection = {x:dx,y:dy};
      if(!gameLoop && (dx||dy)){ init(); gameLoop = setInterval(loop,speed); }
    }

    document.addEventListener('keydown',e=>{
      if(e.key==='ArrowUp') setDirection(0,-1);
      else if(e.key==='ArrowDown') setDirection(0,1);
      else if(e.key==='ArrowLeft') setDirection(-1,0);
      else if(e.key==='ArrowRight') setDirection(1,0);
      else if(e.key===' ') { if(gameLoop) clearInterval(gameLoop); else if(direction.x||direction.y) gameLoop = setInterval(loop,speed); }
    });

    document.getElementById('up').onclick = ()=>setDirection(0,-1);
    document.getElementById('down').onclick = ()=>setDirection(0,1);
    document.getElementById('left').onclick = ()=>setDirection(-1,0);
    document.getElementById('right').onclick = ()=>setDirection(1,0);

    let touchStart=null;
    canvas.addEventListener('touchstart',e=>{touchStart={x:e.touches[0].clientX,y:e.touches[0].clientY};e.preventDefault();},{passive:false});
    canvas.addEventListener('touchmove',e=>e.preventDefault(),{passive:false});
    canvas.addEventListener('touchend',e=>{
      if(!touchStart) return;
      const touchEnd={x:e.changedTouches[0].clientX,y:e.changedTouches[0].clientY};
      const dx=touchEnd.x-touchStart.x, dy=touchEnd.y-touchStart.y;
      if(Math.abs(dx)>50||Math.abs(dy)>50){
        if(Math.abs(dx)>Math.abs(dy)) setDirection(dx>0?1:-1,0);
        else setDirection(0,dy>0?1:-1);
      }
      touchStart=null;
    });

    wallsBtn.onclick = ()=>{ wallsOn=!wallsOn; wallsBtn.textContent=`WALLS: ${wallsOn?'ON':'OFF'}`; };
    modeBtn.onclick = ()=>{
      const modes=['easy','miner','entropy'];
      const i=modes.indexOf(difficulty);
      difficulty=modes[(i+1)%3];
      modeEl.textContent=difficulty.toUpperCase();
      speed=difficulties[difficulty].base;
      if(gameLoop){ clearInterval(gameLoop); gameLoop=setInterval(loop,speed); }
    };
    closeLb.onclick = ()=>lbContainer.style.display='none';

    // Konami
    let k=[];
    document.addEventListener('keydown',e=>{
      k.push(e.key);
      if(k.slice(-10).join(',')==='ArrowUp,ArrowUp,ArrowDown,ArrowDown,ArrowLeft,ArrowRight,ArrowLeft,ArrowRight,KeyB,KeyA'){
        document.body.classList.toggle('rainbow');
      }
    });

    // WebXR
    if(navigator.xr){
      const xr=document.createElement('button');
      xr.textContent='XR';
      xr.style.position='absolute';xr.style.top='1rem';xr.style.right='1rem';
      xr.onclick=()=>navigator.xr.requestSession('immersive-vr',{optionalFeatures:['local-floor']}).then(s=>{
        alert('SLYVERSE XR ACTIVE');
        s.end();
      }).catch(()=>alert('XR not supported'));
      document.body.appendChild(xr);
    }

    window.addEventListener('resize',resize);
    resize();
    render();
    loadLeaderboard();
  </script>
</body>
</html>