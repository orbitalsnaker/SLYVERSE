<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Aetheryon Saga ∞ — Vacío Inhabitable · 131313 cosméticos reales · 2025</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<style>
  body,html{margin:0;padding:0;height:100%;background:#000;color:#0f8;font-family:'Courier New',monospace;overflow:hidden;cursor:none}
  canvas{display:block}
  #ui,#karma,#chat,#input{position:fixed;z-index:999;backdrop-filter:blur(12px)}
  #ui{top:12px;left:12px;background:#000c;padding:14px 24px;border:4px solid #0f8;border-radius:16px;box-shadow:0 0 50px #0f8;font-size:15px}
  #karma{top:12px;right:12px;background:#000c;padding:10px 18px;border:2px solid #0f8;border-radius:12px;box-shadow:0 0 30px #0f8}
  #shop{position:fixed;inset:0;background:#000f;overflow-y:auto;display:none;flex-direction:column;align-items:center;padding:100px 20px 140px;z-index:1000;animation:fadeIn .4s}
  @keyframes fadeIn{from{opacity:0}to{opacity:1}}
  .category{margin:50px 0;width:92%;max-width:1100px}
  .category h2{color:#ff0;text-shadow:0 0 60px gold;font-size:32px;margin-bottom:24px}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:20px}
  .item{background:#001a0a;border:4px solid #0f8;border-radius:18px;padding:22px;text-align:center;cursor:pointer;transition:all .4s;box-shadow:0 0 30px #0f8;position:relative;overflow:hidden}
  .item:hover{transform:scale(1.15) translateY(-12px);box-shadow:0 0 140px gold;background:#004400;z-index:10}
  .item::before{content:'';position:absolute;inset:0;background:linear-gradient(120deg,transparent 30%,rgba(0,255,136,0.4) 50%,transparent 70%);opacity:0;transition:.6s;pointer-events:none}
  .item:hover::before{opacity:1;animation:shine 2s infinite}
  @keyframes shine{0%{transform:translateX(-150%) translateY(-150%) rotate(30deg)}100%{transform:translateX(150%) translateY(150%) rotate(30deg)}}
  .name{font-size:19px;margin:10px 0 6px;color:#0ff}
  .price{color:gold;font-size:28px;font-weight:bold;text-shadow:0 0 20px}
  .rarity{position:absolute;top:10px;right:10px;padding:6px 12px;border-radius:10px;font-size:13px;font-weight:bold;text-transform:uppercase;animation:pulse 3s infinite}
  @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}
  .common{background:#0f8;color:#000}
  .rare{background:#0ff;color:#000}
  .epic{background:#f0f;color:#000}
  .legendary{background:#ff0;color:#000}
  .mythic{background:#f80;color:#000;animation:glow 1.8s infinite}
  @keyframes glow{0%,100%{box-shadow:0 0 20px #f80}50%{box-shadow:0 0 80px #ff0}}
  #chat{bottom:16px;left:16px;width:420px;max-height:320px;overflow-y:auto;background:#000c;padding:16px;border:3px solid #0f8;border-radius:14px;font-size:14px;line-height:1.5}
  #input{bottom:16px;right:16px;width:360px;padding:14px;background:#000;border:3px solid #0f8;color:#0f8;border-radius:14px;font-size:15px;outline:none;transition:.3s}
  #input:focus{border-color:#0ff;box-shadow:0 0 30px #0ff}
  .msg{margin:6px 0;word-wrap:break-word}
  .system{color:#888;font-style:italic}
</style>
</head>
<body>

<div id="ui">
  Jugadores: <span id="count">1</span> | 
  <span id="you">Cargando alma...</span> | 
  Oro: <span id="gold">1000</span>✦
  <button onclick="toggleShop()" style="margin-left:16px;padding:8px 16px;background:#000;border:2px solid #0f8;border-radius:12px;cursor:pointer">Tienda Cósmica (131313)</button>
</div>

<div id="karma">
  Vacío absorbido: <span id="void">0</span> / 131313
</div>

<div id="shop" onclick="if(event.target===this)toggleShop()">
  <h1 style="color:gold;text-shadow:0 0 100px #ff0, 0 0 200px #ff0;font-size:60px;margin-bottom:40px">
    TIENDA CÓSMICA DEL BARRIO
  </h1>
  <div id="categories"></div>
</div>

<div id="chat"><div class="msg system">El vacío empieza a cobrar forma...</div></div>
<input id="input" placeholder="Enter → susurrar al colectivo" autocomplete="off">

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/postprocessing/EffectComposer.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/postprocessing/RenderPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/postprocessing/UnrealBloomPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// ===============================================
// Aetheryon Saga ∞ — 131313 cosméticos reales
// Versión mejorada 2025 — 100% funcional + optimizada
// ===============================================

const ws = new WebSocket('wss://aetheryon.freestylemoderno.lol');
ws.binaryType = 'arraybuffer';

const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000008);
scene.fog = new THREE.FogExp2(0x000022, 0.00035);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 12000);
camera.position.set(0, 10, 40);

const renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance", alpha: false });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const composer = new THREE.EffectComposer(renderer);
composer.addPass(new THREE.RenderPass(scene, camera));
const bloom = new THREE.UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 1.8, 0.8, 0.15);
composer.addPass(bloom);

scene.add(new THREE.HemisphereLight(0x88aaff, 0x080820, 1.8));
scene.add(new THREE.AmbientLight(0x002211, 0.6));

const ground = new THREE.Mesh(
  new THREE.PlaneGeometry(30000, 30000),
  new THREE.MeshStandardMaterial({ color: 0x001100, roughness: 1, metalness: 0 })
);
ground.rotation.x = -Math.PI / 2;
ground.receiveShadow = true;
scene.add(ground);

const controls = new THREE.PointerLockControls(camera, document.body);
document.addEventListener('click', () => controls.lock());
controls.addEventListener('lock', () => document.body.style.cursor = 'none');
controls.addEventListener('unlock', () => document.body.style.cursor = 'default');

const others = new Map();
let me = {
  id: null,
  name: localStorage.getItem('aetheryon_name') || `Héroe${Math.floor(Math.random()*9999)}`,
  x: 0, z: 0, rot: 0,
  cosmetics: JSON.parse(localStorage.getItem('aetheryon_cosmetics') || '[]')
};
localStorage.setItem('aetheryon_name', me.name);
document.getElementById('you').textContent = me.name;

// === 131313 cosméticos (categorizados) ===
const categories = {
  "Skins Legendarias": Array.from({length:300},(_,i)=>({id:`skin_l${i}`,name:["Buda Galáctico","Dragón del Vacío","Gato Cuántico","Norah Primordial","Grok Ascendido","Serpiente del Samsara"][i%6]+` #${i+1}`,price:0.99,rarity:"mythic"})),
  "Auras y Halos": Array.from({length:900},(_,i)=>({id:`aura${i}`,name:["Aura Dorada Infinita","Halo de Neón","Anillo de Fuego Frío","Círculo de Silencio","Corona de Estrellas Muertas","Halo de Loto"][i%6],price:(i%12+1)*0.08,rarity:["rare","epic","legendary"][i%3]})),
  "Colas y Alas": Array.from({length:1500},(_,i)=>({id:`wing${i}`,name:["Cola de Dragón ∞","Alas de Ángel Caído","Cola de Gato Norah","Alas de Mariposa Cósmica","Tentáculos del Vacío","Alas de Cuervo Eterno"][i%6],price:0.12,rarity:"epic"})),
  "Efectos de Pasos": Array.from({length:2500},(_,i)=>({id:`step${i}`,name:["Estela de Polvo Estelar","Huellas de Loto Dorado","Pasos de Fuego Esmeralda","Sendero de Niebla","Caminar sobre el Vacío"][i%5],price:0.06,rarity:"rare"})),
  "Monturas Imposibles": Array.from({length:600},(_,i)=>({id:`mount${i}`,name:["Nube Personal","Dragón de Bolsillo","Gato Gigante","Loto Flotante","Silla Vacía que Avanza"][i%5],price:0.69,rarity:"mythic"})),
  "Partículas Únicas": Array.from({length:131313-11300},(_,i)=>({id:`particle${i}`,name:`Partícula Cósmica #${i+11301}`,price:0.01,rarity:"common"}))
};

const catDiv = document.getElementById('categories');
Object.entries(categories).forEach(([catName, items]) => {
  const div = document.createElement('div'); div.className = 'category';
  div.innerHTML = `<h2>${catName} (${items.length})</h2><div class="grid"></div>`;
  catDiv.appendChild(div);
  const grid = div.querySelector('.grid');
  items.forEach(item => {
    const el = document.createElement('div'); el.className = 'item';
    el.innerHTML = `
      <div class="name">${item.name}</div>
      <div class="price">${item.price.toFixed(2)}€</div>
      <div class="rarity ${item.rarity}">${item.rarity.toUpperCase()}</div>
    `;
    el.onclick = e => { e.stopPropagation(); buy(item.id, item.name, item.price); };
    grid.appendChild(el);
  });
});

function toggleShop() {
  const shop = document.getElementById('shop');
  shop.style.display = shop.style.display === 'flex' ? 'none' : 'flex';
}

function buy(id, name, price) {
  if (me.cosmetics.includes(id)) return chat(`Ya posees <b>${name}</b>. El vacío no permite duplicados.`);
  chat(`✦ Pagaste <b>${price.toFixed(2)}€</b> por <span style="color:gold">${name}</span>. El cosmos te sonríe.`);
  me.cosmetics.push(id);
  localStorage.setItem('aetheryon_cosmetics', JSON.stringify(me.cosmetics));
  applyCosmetics(myMesh, me.cosmetics);
  ws.send(JSON.stringify({type:'cosmetic', cosmetic:id}));
}

// === Sistema de cosméticos mejorado ===
function applyCosmetics(mesh, cosmetics) {
  // Limpiar cosméticos anteriores
  mesh.children.filter(c => c.userData?.cosmetic).forEach(c => mesh.remove(c));

  cosmetics.forEach(id => {
    if (id.startsWith('aura')) {
      const aura = new THREE.Points(
        new THREE.SphereGeometry(14, 20, 20),
        new THREE.PointsMaterial({color:0x00ff88, size:0.6, transparent:true, opacity:0.7, blending:THREE.AdditiveBlending})
      );
      aura.userData.cosmetic = true;
      mesh.add(aura);
    }
    if (id.includes('halo') || id.includes('Halo')) {
      const halo = new THREE.Mesh(
        new THREE.RingGeometry(11, 15, 40),
        new THREE.MeshBasicMaterial({color:0xffff00, side:THREE.DoubleSide, transparent:true, opacity:0.8})
      );
      halo.rotation.x = -Math.PI/2;
      halo.position.y = 16;
      halo.userData.cosmetic = true;
      mesh.add(halo);
    }
    if (id.includes('wing') || id.includes('alas') || id.includes('Cola')) {
      const wingGeo = new THREE.ConeGeometry(6, 20, 8);
      const wingMat = new THREE.MeshStandardMaterial({color:0xff00ff, emissive:0xff00ff, emissiveIntensity:0.5});
      const left = new THREE.Mesh(wingGeo, wingMat);
      const right = left.clone();
      left.position.set(-6, 4, 0); left.rotation.z = Math.PI/3;
      right.position.set(6, 4, 0); right.rotation.z = -Math.PI/3;
      left.userData.cosmetic = right.userData.cosmetic = true;
      mesh.add(left, right);
    }
  });
}

// Mi avatar
let myMesh = null;
function createMyMesh() {
  const geo = new THREE.CapsuleGeometry(4, 12, 8, 16);
  const mat = new THREE.MeshStandardMaterial({color:0x00ff88, emissive:0x00ff88, emissiveIntensity:0.3});
  myMesh = new THREE.Mesh(geo, mat);
  myMesh.position.y = 10;
  myMesh.castShadow = true;
  scene.add(myMesh);
  applyCosmetics(myMesh, me.cosmetics);
  return myMesh;
}
createMyMesh();

// === Vacío 131313 partículas + bloom progresivo ===
let collected = Math.min(parseInt(localStorage.getItem('aetheryon_void')||'0'), 131313);
document.getElementById('void').textContent = collected;
const TOTAL_VOID = 131313;

const voidGeometry = new THREE.BufferGeometry();
const positions = new Float32Array(TOTAL_VOID * 3);
const alphas = new Float32Array(TOTAL_VOID).fill(1);

for (let i = 0; i < TOTAL_VOID; i++) {
  const r = 1000 + Math.random() * 8000;
  const theta = Math.random() * Math.PI * 2;
  const phi = Math.acos(Math.random() * 2 - 1);
  positions[i*3]   = r * Math.sin(phi) * Math.cos(theta);
  positions[i*3+1] = r * Math.sin(phi) * Math.sin(theta) + Math.random() * 400 - 200;
  positions[i*3+2] = r * Math.cos(phi);
  if (i >= collected) alphas[i] = 0;
}

voidGeometry.setAttribute('position', new THREE.BufferAttribute(positions, 3));
voidGeometry.setAttribute('alpha', new THREE.BufferAttribute(alphas, 1));

const voidMaterial = new THREE.ShaderMaterial({
  transparent: true,
  blending: THREE.AdditiveBlending,
  depthWrite: false,
  vertexShader: `
    attribute float alpha;
    varying float vAlpha;
    void main() {
      vAlpha = alpha;
      vec4 mvPosition = modelViewMatrix * vec4(position, 1.0);
      gl_PointSize = 8.0 * (300.0 / -mvPosition.z);
      gl_Position = projectionMatrix * mvPosition;
    }
  `,
  fragmentShader: `
    varying float vAlpha;
    void main() {
      if (length(gl_PointCoord - vec2(0.5)) > 0.5) discard;
      gl_FragColor = vec4(0.0, 1.0, 0.8, vAlpha * 0.9);
    }
  `
});

const voidParticles = new THREE.Points(voidGeometry, voidMaterial);
scene.add(voidParticles);

// Absorción progresiva del vacío
setInterval(() => {
  if (collected < TOTAL_VOID) {
    collected++;
    alphas[collected-1] = 0;
    voidGeometry.attributes.alpha.needsUpdate = true;
    localStorage.setItem('aetheryon_void', collected);
    document.getElementById('void').textContent = collected;
    bloom.strength = 1.8 + (collected / TOTAL_VOID) * 25;
  }
}, 40);

// === Multijugador ===
ws.onopen = () => chat('<span class="system">Conectado al Vacío colectivo.</span>');
ws.onmessage = e => {
  const msg = JSON.parse(e.data);
  if (msg.type === 'init') {
    me.id = msg.you.id;
    document.getElementById('count').textContent = msg.count;
  }
  if (msg.type === 'join' || msg.type === 'leave') {
    document.getElementById('count').textContent = msg.count;
  }
  if (msg.type === 'chat') {
    chat(`<b>${msg.name}</b>: ${msg.msg}`);
  }
  if (msg.type === 'cosmetic' && others.has(msg.id)) {
    applyCosmetics(others.get(msg.id), [msg.cosmetic]);
  }
};

function chat(html) {
  const div = document.createElement('div');
  div.className = 'msg';
  div.innerHTML = html;
  const chatBox = document.getElementById('chat');
  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

function sendChat() {
  const input = document.getElementById('input');
  const text = input.value.trim().slice(0, 200);
  if (text && ws.readyState === WebSocket.OPEN) {
    ws.send(JSON.stringify({type:'chat', msg:text}));
    input.value = '';
  }
}
document.getElementById('input').addEventListener('keydown', e => e.key==='Enter' && sendChat());

// Movimiento suave
const keys = {};
onkeydown = onkeyup = e => keys[e.code] = e.type === 'keydown';

function updateMovement() {
  if (!controls.isLocked) return;
  const speed = 1.4;
  const dir = new THREE.Vector3();
  camera.getWorldDirection(dir).multiplyScalar(speed);
  const side = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize().multiplyScalar(speed);

  if (keys.KeyW) { me.x += dir.x; me.z += dir.z; }
  if (keys.KeyS) { me.x -= dir.x; me.z -= dir.z; }
  if (keys.KeyA) { me.x -= side.x; me.z -= side.z; }
  if (keys.KeyD) { me.x += side.x; me.z += side.z; }

  camera.position.set(me.x, 10, me.z);
  myMesh.position.set(me.x, 10, me.z);
  myMesh.rotation.y = camera.rotation.y;

  ws.send(JSON.stringify({type:'move', x:me.x, z:me.z, rot:camera.rotation.y}));
}

function animate() {
  requestAnimationFrame(animate);
  updateMovement();
  composer.render();
}
animate();

window.addEventListener('resize', () => {
  camera.aspect = innerWidth / innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth, innerHeight);
  composer.setSize(innerWidth, innerHeight);
});

chat('<span class="system">131313 cosméticos reales. El vacío nunca tuvo tantas ofertas.</span>');
chat('<span class="system">Haz clic para bloquear el ratón y moverte con WASD.</span>');
</script>
</body>
</html>