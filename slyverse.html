<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="SLYVERSE v1 — WebXR Snake Grid. Real-time multiplayer snake in pure HTML. Play on desktop, mobile, VR. Export SVG NFT.">
  <meta name="theme-color" content="#0f0">
  <title>SLYVERSE v1 — 0rb1t4lsn4k3r</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 10 Q70 30 90 50 Q70 70 50 90 Q30 70 10 50 Q30 30 50 10' fill='none' stroke='%230f0' stroke-width='4'/></svg>">
  <link rel="manifest" href="data:application/manifest+json,{'name':'SLYVERSE','short_name':'SLYVERSE','start_url':'.','display':'standalone','background_color':'#000','theme_color':'#0f0','icons':[{'src':'data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22%3E%3Cpath d=%22M50 10 Q70 30 90 50 Q70 70 50 90 Q30 70 10 50 Q30 30 50 10%22 fill=%22none%22 stroke=%22%230f0%22 stroke-width=%224%22/%3E%3C/svg%3E','sizes':'192x192','type':'image/svg+xml'}]}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.1/firebase-auth-compat.js"></script>
  <style>
    :root { --void: #000; --glitch: #0f0; --serpent: #f00; --memory: #0ff; --eclipse: #300; --pulse: 1.5s; --glitch-speed: 0.3s; }
    * { margin:0; padding:0; box-sizing:border-box; }
    body { background:var(--void); color:var(--glitch); font-family:"Courier New",monospace; min-height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; image-rendering:pixelated; overflow:hidden; }
    canvas { border:2px solid #f0f; background:#111; max-width:100%; display:block; filter:contrast(1.6) brightness(1.2); }
    #ui { position:absolute; top:4px; left:4px; font-size:13px; text-shadow:0 0 6px var(--glitch); z-index:999; animation:glitch 3s infinite; }
    @keyframes glitch { 0%,100% { text-shadow:0 0 6px var(--glitch), 0 0 12px var(--glitch); } 50% { text-shadow:-2px 0 #f00, 2px 0 #0ff; } }
    #journal { position:absolute; top:4px; right:4px; width:320px; background:rgba(0,0,0,.92); padding:12px; border:1px solid var(--glitch); max-height:calc(100vh - 80px); overflow-y:auto; font-size:11px; line-height:1.3; backdrop-filter:blur(1px); }
    #journal h3 { margin:3px 0; color:var(--memory); font-style:italic; animation:glitch 2.5s infinite; }
    #journal p { margin:2px 0; color:#0a0; opacity:0; transform:translateX(-10px); transition:all .4s; }
    #journal p.show { opacity:1; transform:translateX(0); }
    #chat-input { position:absolute; bottom:4px; right:4px; width:300px; background:transparent; color:var(--glitch); border:1px solid var(--glitch); padding:4px; font-family:monospace; }
    #export { position:absolute; bottom:4px; left:4px; background:transparent; color:var(--glitch); border:1px dashed var(--glitch); padding:4px 8px; font-family:monospace; cursor:pointer; animation:pulse var(--pulse) infinite; }
    @keyframes pulse { 0%,100% { border-color:var(--glitch); } 50% { border-color:var(--serpent); } }
    .eclipse-overlay { position:absolute; inset:0; background:radial-gradient(circle at center, transparent 25%, var(--eclipse) 75%); pointer-events:none; opacity:0; transition:opacity 1.8s; mix-blend-mode:screen; }
    .eclipse-overlay.active { opacity:1; }
    .trail { position:absolute; width:2px; height:2px; background:var(--glitch); border-radius:50%; pointer-events:none; opacity:0; animation:fade 1s forwards; }
    @keyframes fade { to { opacity:0; transform:scale(0); } }
    .soul-hash { position:absolute; bottom:10px; left:50%; transform:translateX(-50%); font-size:8px; color:#333; opacity:0; transition:opacity 1s; }
    .soul-hash.show { opacity:1; }
    .power-up { position:absolute; font-size:10px; color:#ff0; text-shadow:0 0 4px #ff0; animation:blink 1s infinite; }
    @keyframes blink { 0%,50% { opacity:1; } 51%,100% { opacity:0; } }
    #alias-prompt { position:fixed; inset:0; background:rgba(0,0,0,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; color:var(--glitch); }
    #alias-prompt input { background:transparent; border:1px solid var(--glitch); color:var(--glitch); padding:10px; margin:10px; font-family:monospace; }
    @media (max-width:600px) { canvas { width:300px; height:300px; } #journal { width:200px; font-size:10px; } }
  </style>
</head>
<body>
  <div id="alias-prompt">
    <h2>Enter Alias (1-20 chars)</h2>
    <input type="text" id="alias" maxlength="20" pattern="[a-zA-Z0-9_]+" placeholder="e.g. SnakeMaster">
    <button onclick="startGame()">Join Entropy</button>
  </div>
  <canvas id="game" width="600" height="600"></canvas>
  <div id="ui">
    <span id="score">Score: 0</span> | 
    <span id="fragments">F: 0/9</span> | 
    <span id="cycle">C: 1</span> | 
    <span id="player"></span>
  </div>
  <div id="journal">
    <h3>// ENTROPY CHAT //</h3>
    <div id="chat-messages"></div>
  </div>
  <input type="text" id="chat-input" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendChat()">
  <button id="export" onclick="exportSVG()">Export SVG NFT</button>
  <div class="eclipse-overlay" id="eclipse"></div>
  <div class="soul-hash" id="soulHash"></div>

  <script>
    // Firebase Config (replace with your config)
    const firebaseConfig = {
      apiKey: "your-api-key",
      authDomain: "your-project.firebaseapp.com",
      projectId: "your-project",
      storageBucket: "your-project.appspot.com",
      messagingSenderId: "123",
      appId: "your-app-id"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
    const journal = document.getElementById('journal'), chatMessages = document.getElementById('chat-messages');
    const exportBtn = document.getElementById('export'), eclipseOverlay = document.getElementById('eclipse'), soulHashDiv = document.getElementById('soulHash');
    const grid = 30, size = canvas.width / grid;
    let snake, food, dx, dy, score, mode, interval, portalA, portalB, leaderboard = [], state = {
      cycle: 1, fragments: 0, entropy: 0, eclipsePhase: 0, timeDilation: 1, serpentAwake: false,
      actionHistory: [], soulHash: '', cooldowns: { teleport: 0, cloak: 0 }, class: '???', player: '', powerUps: [], milestones: 0
    }, powerUps = [], chatInterval;

    // PWA Service Worker
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('data:text/javascript;base64,' + btoa('self.addEventListener("fetch",e=>e.respondWith(fetch(e.request)));'));
    }

    // Alias
    function startGame() {
      state.player = document.getElementById('alias').value.trim();
      if (!state.player || !/^[a-zA-Z0-9_]+$/.test(state.player) || state.player.length < 1 || state.player.length > 20) return;
      document.getElementById('alias-prompt').style.display = 'none';
      document.getElementById('player').textContent = state.player;
      reset();
      loadLeaderboard();
      startChat();
    }

    // Leaderboard Firebase
    async function loadLeaderboard() {
      try {
        const snapshot = await db.collection('scores').orderBy('score', 'desc').limit(10).get();
        leaderboard = snapshot.docs.map(doc => doc.data());
        updateLB();
      } catch (e) { console.log('Local fallback'); }
    }
    async function addScore() {
      try {
        await db.collection('scores').add({
          score, player: state.player, timestamp: firebase.firestore.Timestamp.now()
        });
        loadLeaderboard();
      } catch (e) { /* Local fallback */ }
    }

    // Chat
    function startChat() {
      chatInterval = setInterval(async () => {
        try {
          const snapshot = await db.collection('chat').orderBy('time', 'desc').limit(50).get();
          chatMessages.innerHTML = snapshot.docs.reverse().map(doc => `<p><strong>${doc.data().player}:</strong> ${doc.data().msg}</p>`).join('');
        } catch (e) { }
      }, 2000);
    }
    function sendChat() {
      const msg = document.getElementById('chat-input').value.trim();
      if (msg && msg.length <= 100) {
        db.collection('chat').add({ msg, player: state.player, time: firebase.firestore.Timestamp.now() });
        document.getElementById('chat-input').value = '';
      }
    }

    // Power-ups
    function spawnPowerUp() {
      const types = ['speed', 'ghost', 'shrink', 'multi', 'invuln'];
      const type = types[Math.floor(Math.random() * types.length)];
      const pu = { x: Math.floor(Math.random() * grid), y: Math.floor(Math.random() * grid), type };
      powerUps.push(pu);
      const el = document.createElement('div');
      el.className = 'power-up';
      el.textContent = type[0].toUpperCase();
      el.style.left = (pu.x * size + size / 2) + 'px';
      el.style.top = (pu.y * size + size / 2) + 'px';
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 10000);
    }

    function activatePowerUp(type) {
      switch (type) {
        case 'speed': interval = setInterval(loop, 50); setTimeout(() => interval = setInterval(loop, 100), 5000); break;
        case 'ghost': state.class = 'GHOST'; setTimeout(() => state.class = '???', 5000); break;
        case 'shrink': if (snake.length > 5) snake.splice(5); break;
        case 'multi': spawnFood(); break;
        case 'invuln': state.serpentAwake = false; setTimeout(() => {}, 3000); break;
      }
      addJournal(`// POWER-UP: ${type.toUpperCase()} ACTIVATED //`);
    }

    // SVG Export
    function exportSVG() {
      if (score < 300) return alert('Reach 300 coils for SVG NFT');
      let svg = `<svg viewBox="0 0 ${grid} ${grid}" xmlns="http://www.w3.org/2000/svg"><path d="`;
      snake.forEach((s, i) => {
        if (i) svg += `L${s.x} ${s.y}`;
        else svg += `M${s.x} ${s.y}`;
      });
      svg += `" stroke="#0f0" fill="none" stroke-width="0.1"/></svg>`;
      const blob = new Blob([svg], { type: 'image/svg+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${state.player}_snake_${score}.svg`;
      a.click();
    }

    // Milestones
    function checkMilestone() {
      const ms = [10, 50, 100, 150, 200, 250, 300];
      if (ms.includes(score) && state.milestones < ms.length) {
        state.milestones++;
        addJournal(`<span style="color:#0ff;">// LORE MILESTONE ${state.milestones}: "The Grid Breathes" //</span>`);
      }
    }

    // Rest of the code from previous version...
    function reset() {
      clearInterval(interval); interval = null;
      snake = [{ x: 15, y: 15 }]; spawnFood(); dx = dy = 0; score = 0; state.fragments = 0; state.entropy = 0; state.cycle = 1; state.eclipsePhase = 0;
      state.timeDilation = 1; state.serpentAwake = false; powerUps = []; updateScore();
      if (mode === 'portal') spawnPortals();
      updateLB(); addJournal(`// ${state.player} JOINS ENTROPY //`);
      setInterval(spawnPowerUp, 15000);
    }

    // Input with WASD
    document.addEventListener('keydown', e => {
      if (e.key === 'w' || e.key === 'ArrowUp') { dy = -1; dx = 0; }
      if (e.key === 's' || e.key === 'ArrowDown') { dy = 1; dx = 0; }
      if (e.key === 'a' || e.key === 'ArrowLeft') { dx = -1; dy = 0; }
      if (e.key === 'd' || e.key === 'ArrowRight') { dx = 1; dy = 0; }
      // ... other keys
    });

    // Loop enhancements
    function loop() {
      // ... existing logic
      if (head.x === food.x && head.y === food.y) {
        // ... eat
        checkMilestone();
      }
      powerUps.forEach(pu => {
        if (head.x === pu.x && head.y === pu.y) {
          activatePowerUp(pu.type);
          powerUps = powerUps.filter(p => p !== pu);
        }
      });
      // ... rest
    }

    // Draw power-ups
    function draw() {
      // ... existing
      powerUps.forEach(pu => {
        ctx.fillStyle = '#ff0';
        ctx.fillRect(pu.x * size + 2, pu.y * size + 2, size - 4, size - 4);
      });
      // ...
    }

    // Init
    updateLB(); setMode('classic');
    addJournal(`<i style="color:#0ff;">// SLYVERSE v1 — BUILT IN ONE NIGHT BY 0rb1t4lsn4k3r //</i>`);
  </script>
</body>
</html>