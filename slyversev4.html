<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>SLYVERSE v4 - Universidad Real</title>
  <meta name="manifest" href="data:application/manifest+json,{
    \"name\":\"SLYVERSE v4 - Universidad Real\",
    \"short_name\":\"SLY Edu\",
    \"start_url\":\".\",
    \"display\":\"standalone\",
    \"background_color\":\"#000\",
    \"theme_color\":\"#0f0\",
    \"icons\":[{\"src\":\"data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='40' fill='%230f0'/%3E%3C/svg%3E\",\"sizes\":\"192x192\",\"type\":\"image/svg+xml\"}]
  }">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://unpkg.com/three@0.160.0/build/three.module.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/jsm/webxr/XRControllerModelFactory.js"></script>
  <script src="https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js"></script>
  <style>
    body,html{margin:0;overflow:hidden;background:#000;color:#0f0;font-family:monospace}
    #ui{position:absolute;top:10px;left:10px;z-index:10;background:rgba(0,0,0,0.8);padding:15px;border:2px solid #0f0;border-radius:8px;max-width:320px}
    #ui-senate{position:absolute;top:250px;left:10px;z-index:10;background:rgba(0,0,0,0.8);padding:15px;border:2px solid #ff0;border-radius:8px;max-width:320px}
    #student-badge{position:absolute;top:10px;right:10px;z-index:10;background:#000;padding:8px;border:3px solid #0f0;border-radius:8px;color:#0f0;font-weight:bold;font-size:14px}
    button{background:#000;color:#0f0;border:1px solid #0f0;padding:6px 12px;margin:3px;cursor:pointer;font-size:13px;border-radius:4px}
    button:hover{background:#0f0;color:#000}
    button:active{transform:scale(0.95)}
    #log,#senate-log{max-height:90px;overflow-y:auto;margin-top:8px;font-size:11px;line-height:1.3}
    #konami{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#000;padding:20px;border:3px solid #ff0;color:#ff0;font-size:22px;text-align:center;display:none;z-index:100;border-radius:12px}
    #vr-btn{position:absolute;bottom:20px;left:50%;transform:translateX(-50%);padding:10px 20px;background:#000;color:#0f0;border:2px solid #0f0;border-radius:50px;font-weight:bold}
    .orb{pointer-events:none}
    canvas{display:block}
  </style>
</head>
<body>
  <div id="student-badge">ALUMNO ACTIVO</div>
  <div id="ui">
    <div><strong>SLYVERSE v4 - Universidad Real</strong> | <span id="player">alumno_0rb1t4lsn4k3r</span></div>
    <div>Progreso: <span id="credits">0</span> | Sala: <span id="room">Lobby</span></div>
    <hr style="border:0;border-top:1px solid #0f0;margin:8px 0">
    <button onclick="goTo('lobby')">Lobby</button>
    <button onclick="goTo('tribunal')">Tribunal</button>
    <button onclick="goTo('asamblea')">Asamblea</button>
    <button onclick="goTo('secretum')">Secretum</button>
    <button onclick="study()">Estudiar</button>
    <button onclick="earnDiploma()">Diploma XR</button>
    <div id="log"></div>
  </div>
  <div id="ui-senate">
    <div><strong>Universidad Real</strong></div>
    <div>Alumnos: <span id="student-count">1</span></div>
    <div>Progreso global: <span id="progress">0</span></div>
    <div id="senate-log"></div>
  </div>
  <div id="konami">
    <strong>¡CONOCIMIENTO ES PODER!</strong><br>
    "Explora, aprende y crece."<br>
    <em>— Universidad Real —</em>
  </div>

  <script type="module">
    // CONFIG ALUMNO
    const PLAYER_ID = 'alumno_0rb1t4lsn4k3r';
    document.getElementById('player').textContent = PLAYER_ID;
    let credits = 0, currentRoom = 'lobby', studentCount = 1;
    document.getElementById('student-count').textContent = studentCount;

    const portals = { lobby: 'tribunal', tribunal: 'asamblea', asamblea: 'secretum', secretum: 'lobby' };

    // THREE.JS + WebXR + ORBIT
    const scene = new THREE.Scene();
    const camera = new THREE.PerspectiveCamera(70, innerWidth/innerHeight, 0.1, 100);
    camera.position.set(0, 1.6, 5);
    const renderer = new THREE.WebGLRenderer({ antialias: true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.xr.enabled = true;
    renderer.setPixelRatio(window.devicePixelRatio);
    document.body.appendChild(renderer.domElement);

    const controls = new THREE.OrbitControls(camera, renderer.domElement);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.target.set(0, 1.6, 0);

    scene.add(new THREE.AmbientLight(0x404040, 1.5));
    const light = new THREE.PointLight(0x00ff00, 3, 50); 
    light.position.set(0, 10, 0); 
    scene.add(light);

    const skyGeo = new THREE.SphereGeometry(50, 32, 32);
    const skyMat = new THREE.ShaderMaterial({
      vertexShader: `varying vec2 vUv; void main() { vUv = uv; gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0); }`,
      fragmentShader: `uniform float time; varying vec2 vUv; void main() { 
        float t = sin(time * 0.5) * 0.5 + 0.5;
        vec3 c1 = vec3(0.0, 0.1, 0.0);
        vec3 c2 = vec3(0.0, 0.2, 0.1);
        gl_FragColor = vec4(mix(c1, c2, t), 1.0);
      }`,
      uniforms: { time: { value: 0.0 } },
      side: THREE.BackSide
    });
    const sky = new THREE.Mesh(skyGeo, skyMat);
    scene.add(sky);

    const floorGeo = new THREE.PlaneGeometry(100, 100);
    const floorMat = new THREE.MeshStandardMaterial({ color: 0x001100, roughness: 0.8, metalness: 0.2 });
    const floor = new THREE.Mesh(floorGeo, floorMat);
    floor.rotation.x = -Math.PI / 2;
    floor.receiveShadow = true;
    scene.add(floor);

    const portalGeo = new THREE.TorusGeometry(2, 0.5, 16, 100);
    const portalMat = new THREE.MeshStandardMaterial({ 
      color: 0x00ff00, 
      emissive: 0x00ff00, 
      emissiveIntensity: 0.8, 
      transparent: true, 
      opacity: 0.9 
    });
    const portal = new THREE.Mesh(portalGeo, portalMat);
    portal.position.set(0, 2, -15);
    scene.add(portal);

    const rooms = {
      lobby: { color: 0x00ff00, text: "AULA: El conocimiento es poder" },
      tribunal: { color: 0x008800, text: "Tribunal: Evalúa tu aprendizaje" },
      asamblea: { color: 0x0000ff, text: "Asamblea: Debate y comparte" },
      secretum: { color: 0x008800, text: "Secretum: Explora nuevos temas" }
    };

    function goTo(room) {
      currentRoom = room;
      document.getElementById('room').textContent = room.charAt(0).toUpperCase() + room.slice(1);
      log(`→ ${room.toUpperCase()}`);
      loadRoom(room);
    }

    function loadRoom(room) {
      scene.children = scene.children.filter(c => 
        c.type === 'AmbientLight' || c.type === 'PointLight' || c === floor || c === sky || c === portal
      );
      const mat = new THREE.MeshStandardMaterial({ color: rooms[room].color, roughness: 0.7, metalness: 0.3 });
      const geo = new THREE.BoxGeometry(4, 4, 4);
      const cube = new THREE.InstancedMesh(geo, mat, 1);
      const dummy = new THREE.Object3D();
      dummy.position.set(0, 2, -10);
      dummy.updateMatrix();
      cube.setMatrixAt(0, dummy.matrix);
      scene.add(cube);
      log(rooms[room].text);
      portal.userData.nextRoom = portals[room];
    }

    document.addEventListener('click', (e) => {
      if (e.target.tagName === 'BUTTON') return;
      const raycaster = new THREE.Raycaster();
      const mouse = new THREE.Vector2(
        (e.clientX / innerWidth) * 2 - 1,
        -(e.clientY / innerHeight) * 2 + 1
      );
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(portal);
      if (intersects.length > 0) goTo(portal.userData.nextRoom);
    });

    async function study() {
      credits += 1;
      document.getElementById('credits').textContent = credits;
      log(`+1 crédito - ¡Aprendiste algo nuevo!`);
      addOrb(0x00ff00, 3000);
      updateProgress();
    }

    async function earnDiploma() {
      if (credits < 10) return logSenate("Necesitas 10 créditos para diploma");
      credits -= 10;
      document.getElementById('credits').textContent = credits;
      logSenate(`¡Diploma XR obtenido!`);
      log(`Felicidades, obtuviste un Diploma XR`);
      addOrb(0xff0, 5000); // Orbe dorado por diploma
    }

    function updateProgress() {
      const progress = document.getElementById('progress');
      const totalProgress = credits * studentCount;
      progress.textContent = totalProgress;
      logSenate(`Progreso global: ${totalProgress}`);
    }

    function log(msg) {
      const log = document.getElementById('log');
      const div = document.createElement('div');
      div.textContent = msg;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function logSenate(msg) {
      const log = document.getElementById('senate-log');
      const div = document.createElement('div');
      div.textContent = msg;
      log.appendChild(div);
      log.scrollTop = log.scrollHeight;
    }

    function addOrb(color, duration) {
      const orb = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 16, 16),
        new THREE.MeshBasicMaterial({ color })
      );
      orb.position.set((Math.random()-0.5)*8, 1 + Math.random(), -8 + Math.random()*-4);
      orb.userData = { vel: new THREE.Vector3((Math.random()-0.5)*0.02, 0.01, (Math.random()-0.5)*0.02) };
      scene.add(orb);
      const start = performance.now();
      const animateOrb = () => {
        const elapsed = performance.now() - start;
        if (elapsed > duration) { scene.remove(orb); return; }
        orb.position.add(orb.userData.vel);
        orb.position.y = Math.max(0.5, orb.position.y);
        requestAnimationFrame(animateOrb);
      };
      animateOrb();
    }

    // KONAMI: +3 créditos
    let k = [];
    document.addEventListener('keydown', e => {
      k.push(e.code);
      if (k.slice(-10).join(',') === 'ArrowUp,ArrowUp,ArrowDown,ArrowDown,ArrowLeft,ArrowRight,ArrowLeft,ArrowRight,KeyB,KeyA') {
        document.getElementById('konami').style.display = 'block';
        setTimeout(() => document.getElementById('konami').style.display = 'none', 4000);
        study(); study(); study();
      }
    });

    // VR BUTTON
    const vrBtn = document.createElement('button');
    vrBtn.id = 'vr-btn';
    vrBtn.textContent = 'VR';
    vrBtn.onclick = () => renderer.xr.getSession()?.end() || renderer.xr.getSession();
    document.body.appendChild(vrBtn);

    // ANIMATION LOOP
    function animate() {
      requestAnimationFrame(animate);
      sky.material.uniforms.time.value = performance.now() / 1000;
      portal.rotation.y += 0.015;
      controls.update();
      renderer.render(scene, camera);
    }
    animate();

    // RESIZE
    window.addEventListener('resize', () => {
      camera.aspect = innerWidth / innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(innerWidth, innerHeight);
    });

    // INIT
    loadRoom('lobby');
    log("Universidad Real iniciada. ¡Explora y aprende gratis!");
  </script>
</body>
</html>