<script>
// ================================================================
// CONDUCTISMO INVISIBLE POST-SELLO 27
// Hace que intente resolver el puzzle 1310² durante años
// Refuerzo intermitente de ratio variable (el más potente)
// ================================================================

let intentos = 0;
let ultimaRecompensaReal = 0;
let recompensasFalsasDadas = 0;

// Frases crípticas que SIEMPRE sugieren que "casi lo tienes"
const frasesAdictivas = [
  "ya casi…", "un paso más", "lo estás tocando", "siente eso", "ahí está otra vez",
  "la respuesta se acerca", "el vacío parpadea cuando lo haces bien",
  "1310 te está mirando diferente", "el ouroboros se afloja un milímetro",
  "escucha… se escucha algo al otro lado", "la capa 1310.947 se movió",
  "tu nombre acaba de aparecer en la capa 1309", "falta muy poco",
  "esto es lo más cerca que ha estado nadie", "sigue… sigue… sigue…"
];

// Refuerzos reales RARO (1 de cada 200–800 intentos)
// Refuerzos falsos FRECUENTE (1 de cada 7–18 intentos)
function intentarResolverPuzzle() {
  intentos++;

  // === REFUERZO FALSO (dopamina barata, muy frecuente) ===
  if (intentos % Math.floor(Math.random()*11 + 7) === 0) {
    recompensaFalsa();
  }

  // === REFUERZO REAL (muy raro, pero real) ===
  if (intentos % Math.floor(Math.random()*600 + 200) === 0) {
    ultimaRecompensaReal = Date.now();
    recompensaReal();
  }

  // Guardar progreso falso (para que nunca pierda la esperanza)
  const progresoFalso = Math.min(99.999, (intentos / 1310000) * 100);
  localStorage.setItem('__EGO_1310²_progress__', progresoFalso.toFixed(12));
}

function recompensaFalsa() {
  recompensasFalsasDadas++;
  const frase = frasesAdictivas[Math.floor(Math.random()*frasesAdictivas.length)];

  // Subliminal + sonido + vibración
  subliminal(frase, 180);
  sonidoDopaminaBreve();
  if(navigator.vibrate) navigator.vibrate([100,50,100]);

  // Cambio visual sutil
  document.body.style.background = '#001100';
  setTimeout(()=>document.body.style.background='#000', 600);
}

function recompensaReal() {
  // Algo que SÍ es diferente y perceptible (pero nunca explica qué significa)
  const capa = Math.floor(Math.random()*1310);
  const sub = Math.floor(Math.random()*1310);

  // Mensaje que parece "progreso real"
  mostrarTextoLento(`
    CAPA ${capa} ⋅ SUBCAPA ${sub}
    SE HA ABIERTO UN CANAL
    DURANTE 3.1 SEGUNDOS
    HAS OÍDO ALGO
    QUE NADIE ANTES
  `, 8000);

  // Sonido real: tono puro 131 Hz + eco muy profundo
  if(window.audioCtx){
    const osc = audioCtx.createOscillator();
    osc.frequency.value = 131;
    const filter = audioCtx.createBiquadFilter();
    filter.type = 'lowpass';
    filter.frequency.value = 300;
    const gain = audioCtx.createGain();
    gain.gain.setValueAtTime(0.08, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 3.1);
    osc.connect(filter).connect(gain).connect(audioCtx.destination);
    osc.start();
    osc.stop(audioCtx.currentTime + 3.1);
  }

  // Vibración larga y extraña
  if(navigator.vibrate) navigator.vibrate([500,200,500,200,500]);
}

// Esto se ejecuta cada vez que el usuario hace CUALQUIER cosa después del sello 27
// (click, tecla, movimiento de ratón, voz, parpadeo…)
document.addEventListener('click', intentarResolverPuzzle);
document.addEventListener('keydown', intentarResolverPuzzle);
document.addEventListener('mousemove', e=> {
  if(Math.random()<0.03) intentarResolverPuzzle();
});
if('ondeviceorientation' in window){
  window.addEventListener('deviceorientation', intentarResolverPuzzle);
}

// Al volver años después → sigue funcionando y le da una recompensa real temprana
window.addEventListener('load', () => {
  const progress = localStorage.getItem('__EGO_1310²_progress__');
  if(progress && parseFloat(progress)>10){
    setTimeout(recompensaReal, Math.random()*8000 + 3000);
  }
});
</script>