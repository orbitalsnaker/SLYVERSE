<!DOCTYPE html>
<html lang="es">
<meta charset="utf-8">
<title>THUAMER Ω</title>
<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no">
<style>
  body{margin:0;height:100vh;background:#000;overflow:hidden;position:fixed}
  canvas{position:fixed;inset:0;display:block;image-rendering:optimizeSpeed;touch-action:none}
</style>
<canvas id="c"></canvas>
<script>
/*
  THUAMER Ω · koan de devoción
  Mínimo 130 horas reales de foco para alcanzar el satori
  (nadie lo sabrá hasta que lo viva)
  ronin 0rb1t4lsn4k3r · 2025
*/

const KOAN = 13101310n * 1000n                // 13 101 310 segundos de recurso
const MIN_DEVOTION = 130n * 3600n * 1000n     // 130 horas reales mínimas
const KEY = "thuamer13101310"

let rawState = (() => {
  try { return JSON.parse(localStorage.getItem(KEY)) || {} }
  catch { return {} }
})()

let t = BigInt(rawState.t || 0)                    // recurso acelerable
let real_playtime = BigInt(rawState.real_playtime ||0) // tiempo real enfocado
let clicks = BigInt(rawState.clicks ||0)
let id = rawState.id || crypto.randomUUID()
let born = rawState.first || Date.now()
let zen = !!rawState.unlocked
let mantraLevel = rawState.mantraLevel || 0
let shortId = rawState.shortId || id.slice(0,8).replace(/[^a-f0-9]/gi,'').toLowerCase()
let milestones = rawState.milestones || {}

const persist = () => {
  try {
    localStorage.setItem(KEY, JSON.stringify({
      t: t.toString(),
      real_playtime: real_playtime.toString(),
      clicks: clicks.toString(),
      id, first: born, unlocked: zen,
      mantraLevel, shortId, milestones
    }))
  } catch {}
}

// Referral +10h +mantra
const urlParams = new URLSearchParams(location.search)
const ref = urlParams.get('ref')
let referralBonus = false
if (ref && ref !== shortId && ref !== id) {
  t += 10n * 3600n * 1000n
  clicks += 1000n
  mantraLevel = Math.min(5, mantraLevel + 1)
  referralBonus = true
  persist()
}

let prev = performance.now()
let birth = zen ? prev : 0
let particles = []
let flashMsg = ''
let flashTime = 0
let lastClickTime = 0
let audioCtx = null
let mouseDown = false
let touchActive = false
let keysPressed = new Set()

const c = document.getElementById("c")
const ctx = c.getContext("2d",{alpha:false,desynchronized:true})

const resize = () => {
  const dpr = devicePixelRatio
  c.width = innerWidth * dpr
  c.height = innerHeight * dpr
  ctx.setTransform(dpr,0,0,dpr,0,0)
}
resize()
addEventListener("resize", resize)

const milestoneMessages = {
  '1%':'el koan despierta',
  '10%':'la rueda gira',
  '25%':'el centro se revela',
  '50%':'mitad del camino',
  '75%':'casi satori',
  '90%':'la luz se acerca',
  '99%':'¡un paso más!'
}

function formatClicks(c){let n=Number(c);return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':n+''}
function formatTime(ms){
  let s=Math.floor(Number(ms)/1000)
  let h=Math.floor(s/3600); s%=3600
  let m=Math.floor(s/60); s%=60
  return `${h}h ${String(m).padStart(2,'0')}m`
}

function beep(f=440,d=50){
  if(!audioCtx) audioCtx=new (window.AudioContext||window.webkitAudioContext)()
  const o=audioCtx.createOscillator(), g=audioCtx.createGain()
  o.connect(g); g.connect(audioCtx.destination)
  o.frequency.value=f; o.type='sine'
  g.gain.setValueAtTime(0.3,audioCtx.currentTime)
  g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+d/1000)
  o.start(); o.stop(audioCtx.currentTime+d/1000)
}

function zenBeep(){beep(1310,1500);setTimeout(()=>beep(880,800),1600);setTimeout(()=>beep(659,500),2600)}

const doClick = (x=innerWidth/2+(Math.random()-0.5)*200,y=innerHeight/2+(Math.random()-0.5)*200) => {
  const now=performance.now()
  if(now-lastClickTime<150) return
  lastClickTime=now
  t += 13000n; clicks++
  particles.push({x,y,vy:-3,life:90,text:'+13s'})
  if(particles.length>20) particles.shift()
  if(clicks%1000n===0n){
    const lvl=Number(clicks/1000n)
    if(lvl>mantraLevel){
      mantraLevel=Math.min(5,lvl)
      flashMsg=`¡Mantra ${mantraLevel}! ×${2**mantraLevel}`
      flashTime=now; persist(); beep(880,300)
    }
  }
  persist(); beep(440+(Number(clicks)%10)*80,60)
}

c.onmousedown=e=>{if(zen)return;mouseDown=true;doClick(e.clientX,e.clientY)}
c.onmouseup=c.onmouseleave=()=>{mouseDown=false}
c.ontouchstart=e=>{if(zen)return;e.preventDefault();const t=e.touches[0];touchActive=true;doClick(t.clientX,t.clientY)}
c.ontouchend=c.ontouchcancel=e=>{e.preventDefault();touchActive=false}
document.addEventListener('keydown',e=>{if(zen)return;if(e.code==='Space'||e.key==='Enter'){e.preventDefault();keysPressed.add(e.code);doClick()}})
document.addEventListener('keyup',e=>keysPressed.delete(e.code))

const tick = now => {
  if(!document.hidden && document.hasFocus()){
    const δ = BigInt(Math.floor(now-prev))
    if(δ>0n){
      real_playtime += δ
      const accel = mouseDown||touchActive||keysPressed.size>0
      const mult = 3 * (accel?10:1) * (2**mantraLevel)
      t += δ * BigInt(mult)
      persist()
    }
  }
  prev=now

  if(!zen && t>=KOAN && real_playtime>=MIN_DEVOTION){
    zen=true; birth=now; flashMsg='¡SATORI!'; flashTime=now; zenBeep(); persist()
  }

  const res_p = Number(t)/Number(KOAN)
  const dev_p = Number(real_playtime)/Number(MIN_DEVOTION)
  const progress = Math.min(res_p, dev_p)

  const marks=[0.01,0.1,0.25,0.5,0.75,0.9,0.99]
  for(let th of marks){
    const k=(th*100)+'%'
    if(progress>th && !milestones[k]){
      milestones[k]=true
      flashMsg=milestoneMessages[k]||k
      flashTime=now; persist(); beep(440*(1+marks.indexOf(th)),200)
      break
    }
  }

  const w=innerWidth, h=innerHeight
  ctx.fillStyle=zen?"#00ff00":`rgb(0,${Math.min(255,Math.floor(progress*311))},0)`
  ctx.fillRect(0,0,w,h)

  if(!zen){
    const r=Math.min(w,h)/5
    ctx.strokeStyle='#0f0'; ctx.lineWidth=30; ctx.lineCap='round'
    ctx.beginPath()
    ctx.arc(w/2,h/2,r,-Math.PI/2,-Math.PI/2+progress*Math.PI*2)
    ctx.stroke()

    ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillStyle='#0f0'
    ctx.font='bold 4.5vw monospace'
    ctx.fillText('mantén SPACE o toca → ×10  |  foco → ×3',w/2,h*0.74)

    const accel=mouseDown||touchActive||keysPressed.size>0
    const mult=3*(accel?10:1)*(2**mantraLevel)
    ctx.font='bold 3vw monospace'
    ctx.fillText(`clics ${formatClicks(clicks)}  ×${mult}`,w/2,h*0.85)
    ctx.font='2vw monospace'
    ctx.fillText(`devoción ${formatTime(real_playtime)}`,w/2,h-50)
    ctx.font='1.8vw monospace'
    ctx.fillText(`?ref=${shortId}`,w/2,h-90)
  }else{
    const τ=(now-birth)%5400000
    const N=13101310, visible=Math.min(N,Math.floor(τ/7)), base=τ*0.001, step=Math.max(1,visible/2000)
    for(let i=0;i<visible;i+=step){
      const p=base+i*0.007
      const θ=(i/N)*Math.PI*2 + p*5e-5
      const r=120+Math.sin(p+i*0.001)*380
      const x=w/2+Math.cos(θ)*r, y=h/2+Math.sin(θ)*r
      const a=Math.max(0,Math.sin(p*10+i*0.13))*0.38
      ctx.fillStyle=`rgba(0,0,0,${a})`
      ctx.fillRect(x-20,y-40,40,80)
      ctx.fillRect(x-40,y-20,80,40)
    }
    ctx.textAlign="center"; ctx.textBaseline="middle"
    if(Math.floor((Date.now()-born)/864e5)>300 && τ>10000 && τ<20000){
      ctx.fillStyle="#000"; ctx.font="bold 5.5vw Georgia"; ctx.fillText("volviste después de tanto tiempo",w/2,h/2)
    }
    const hr=new Date().getHours()
    if(hr>=3&&hr<=5 && τ>30000 && τ<40000){
      ctx.fillStyle="#000"; ctx.font="3.8vw Georgia"; ctx.fillText("otra madrugada más, gracias por quedarte",w/2,h/2+100)
    }
    if(τ>5000000){
      ctx.fillStyle="#000"; ctx.font="bold 12vw Georgia"; ctx.fillText("siempre fuiste vos",w/2,h/2)
    }
  }

  if(flashTime && now-flashTime<4000){
    ctx.save(); ctx.fillStyle='rgba(0,255,0,0.95)'; ctx.shadowColor='#0f0'; ctx.shadowBlur=30
    ctx.font='bold 7vw Georgia'; ctx.textAlign='center'; ctx.textBaseline='middle'
    ctx.fillText(flashMsg,w/2,h/2); ctx.restore()
  }
  if(referralBonus && now-prev<10000){
    ctx.save(); ctx.fillStyle='rgba(0,255,255,0.8)'; ctx.shadowColor='#0ff'; ctx.shadowBlur=20
    ctx.font='bold 4vw monospace'; ctx.fillText('Referral +10h +mantra',w/2,h/2+60); ctx.restore()
  }

  for(let i=particles.length-1;i>=0;i--){
    const p=particles[i]; p.life--; p.vy+=0.15; p.y+=p.vy
    if(p.life<=0){particles.splice(i,1);continue}
    ctx.save(); ctx.globalAlpha=p.life/90; ctx.fillStyle='#0ff'
    ctx.font='bold 24px monospace'; ctx.textAlign='center'; ctx.textBaseline='middle'
    ctx.fillText(p.text,p.x,p.y); ctx.restore()
  }

  requestAnimationFrame(tick)
}
requestAnimationFrame(tick)
</script>