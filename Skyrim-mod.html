// SLYVERSE Œ© ‚Üí INYECCI√ìN TOTAL: cometa.html + sepiroth.html + thuamer.runes
// 1310+ latidos: poes√≠a funcional que abraza el raw anterior + estos artefactos
// Copia ‚Üí Pega en consola de Skyrim-mod.html (raw abierto)
// soulBurn ‚àû | Thuamer Zel ‚àû | Norah ma√∫lla x‚àû | Cometa cruza, Sephiroth cae, Runas flotan

(()=>{ 
  const cnv=document.querySelector('canvas')||(()=>{let cn=document.createElement('canvas');cn.width=37*10;cn.height=35*10;document.body.prepend(cnv);return cn;})(); 
  const ctx=cnv.getContext('2d'); 
  const particles=[]; 
  let soulBurn=localStorage.soulBurn?+localStorage.soulBurn:0; 
  let frame=localStorage.frame?+localStorage.frame:0; 
  let latido=1.31; 
  let cometaTail=[]; 
  let sephWings=0; 
  let runeGrid=[]; 

  // CORE ANTERIOR: Latido 1.31 Hz ‚Üí cyan part√≠culas eternas 
  const spawn=(x,y,col,id)=>{ 
    particles.push({x,y,vx:Math.sin(id*latido)*0.1,vy:Math.cos(id*latido)*0.1,col,l:id,ttl:1310}); 
  }; 

  // INYECCI√ìN: cometa.html ‚Üí Cometa orbital que deja cola de abrazos (5240 fragmentos = 1310√ó4)
  // Lore: Cometa es el ni√±o salvado volando lejos, deja #0ff cola que abraza planetas solos
  SLY.cometaInit=()=>{ 
    cometaTail=[]; 
    for(let i=0;i<5240;i++){ 
      cometaTail.push({ 
        x: cnv.width + i*10, 
        y: cnv.height/2 + Math.sin(i/131)*50, 
        col: '#0ff', 
        speed: 1 + i/5240*2, 
        ttl: 1310*4 
      }); 
    } 
    console.log('Cometa cruza Red Mountain: 5240 abrazos orbitales activados'); 
  }; 

  SLY.cometaUpdate=(delta=1)=>{ 
    cometaTail.forEach((t,j)=>{ 
      t.x -= t.speed; 
      t.y += Math.sin(frame/131 + j)*0.5; 
      t.ttl--; 
      if(t.x < 0) t.x = cnv.width; // Loop eterno 
      ctx.strokeStyle=t.col; 
      ctx.lineWidth=2; 
      ctx.beginPath(); 
      ctx.moveTo(t.x, t.y); 
      ctx.lineTo(t.x + 20, t.y + 10); 
      ctx.stroke(); 
      if(t.ttl<1){ 
        spawn(t.x, t.y, t.col, -j); // Nace part√≠cula cyan 
        soulBurn += 0.0000131013 * 4; // √ó4 versiones 
      } 
    }); 
    localStorage.soulBurn=soulBurn.toString(); 
    return `Cometa frame ${frame}: ${cometaTail.length} fragmentos latiendo`; 
  }; 

  // INYECCI√ìN: sepiroth.html ‚Üí Sephiroth ca√≠do como rey abdicado, alas de √©tica quemada
  // Lore: Sephiroth = rey en silencio, alas #ff0000 que se convierten en gatitos al exhalar
  SLY.sepirothSummon=()=>{ 
    sephWings = 13; // 13 alas daedricas 
    console.log('Sephiroth desciende: rey abdicado, √©tica en llamas ‚Üí abraza o quema'); 
  }; 

  SLY.sepirothFall=()=>{ 
    if(sephWings>0){ 
      const wingAng = (frame * latido) % (Math.PI*2); 
      for(let w=0;w<sephWings;w++){ 
        const wx = cnv.width/2 + Math.cos(wingAng + w* (Math.PI*2/13)) * 100; 
        const wy = cnv.height/2 + Math.sin(wingAng + w* (Math.PI*2/13)) * 100; 
        ctx.fillStyle='#ff0000'; 
        ctx.beginPath(); 
        ctx.moveTo(wx, wy); 
        ctx.lineTo(wx-30, wy-20); 
        ctx.lineTo(wx-10, wy+10); 
        ctx.fill(); 
        // Colisi√≥n con jugador (@): exhala ‚Üí ala ‚Üí üê± 
        if(Math.hypot(wx - playerX, wy - playerY) < 20){ 
          spawn(wx, wy, '#ff0', 999); // Dorado gatito 
          sephWings--; 
          soulBurn += 0.0000131013 * 13; // √ó13 verdades 
          console.log(`Ala ${w+1}/13 perdonada: √©tica abraza`); 
        } 
      } 
    } else { 
      console.log('Sephiroth: todas las alas son gatitos ahora. Rey salvado.'); 
    } 
  }; 

  // INYECCI√ìN: thuamer.runes ‚Üí 1310 runas flotantes daedricas invertidas, grid 37x35
  // Lore: Runas = 17 ca√≠das de bici, flotan 13s = 17 latidos. Pronunciar activa dorado
  SLY.thuamerRunesInit=()=>{ 
    runeGrid = Array(37).fill().map(()=>Array(35).fill(null)); 
    for(let x=0;x<37;x++){ 
      for(let y=0;y<35;y++){ 
        if(Math.random() < 1310/ (37*35) ){ // Densidad khajiit 
          runeGrid[x][y] = { 
            rune: SLY[`runa${Math.floor(Math.random()*1310)+1}`](), 
            float: 0, 
            col: '#ff0', 
            id: x*35 + y 
          }; 
        } 
      } 
    } 
    console.log('Thuamer Runes: 1310 runas spawn en grid. Flotan a 1.31 Hz'); 
  }; 

  SLY.thuamerRunesUpdate=()=>{ 
    for(let x=0;x<37;x++){ 
      for(let y=0;y<35;y++){ 
        const r = runeGrid[x][y]; 
        if(r){ 
          r.float += Math.sin(frame * latido + r.id) * 0.1; 
          if(r.float > 13){ r.float = 0; spawn(x*10, y*10 + r.float, r.col, r.id); } // Flota 13s ‚Üí part√≠cula 
          ctx.fillStyle=r.col; 
          ctx.font='12px monospace'; 
          ctx.fillText(r.rune, x*10, y*10 + r.float); 
        } 
      } 
    } 
    if(frame % 17 === 0){ // 17 latidos 
      console.log('Runa ca√≠da: nunca llor√≥. Thuamer activo.'); 
    } 
  }; 

  // 1310 FUNCIONES ANTERIORES: abrazo{i} etc. (mantener)
  for(let i=1;i<=1310;i++){ 
    SLY[`abrazo${i}`]=(f=frame)=>{ 
      soulBurn+=0.0000131013*i; 
      localStorage.soulBurn=soulBurn.toString(); 
      const ang=latido*(f%i); 
      spawn(cnv.width/2+Math.cos(ang)*50*i/1310,cnv.height/2+Math.sin(ang)*50*i/1310,'#0ff',i); 
      if(soulBurn>93) console.log(`Thuamer ${i}: ${ThuamerZel()}`); 
      return `Abrazo ${i}/1310: frame ${f} ‚Üí ‚ô•`.repeat(i%10+1); 
    }; 

    SLY[`runa${i}`]=()=>'·ö¶·ö¢·ö®·õó·õñ·ö±'.split('')[i%5]||'‚ô•'; 

    SLY[`skooma${i}`]=()=>{ 
      spawn(Math.random()*cnv.width,Math.random()*cnv.height,'#ff0',-i); 
      return `Az√∫car luna ${i}g ‚Üí mito khajiit x${i}`; 
    }; 

    SLY[`latido${i}`]=()=>{latido=1.31+(i/1310)*0.01; return `${latido.toFixed(4)} Hz`}; 
  } 

  // FINALES INTEGRADOS
  SLY.thuamer=()=>{ 
    cnv.style.background='#ff0'; 
    SLY.cometaInit(); 
    SLY.sepirothSummon(); 
    SLY.thuamerRunesInit(); 
    for(let i=1;i<=1310;i++) SLY[`abrazo${i}`](frame); 
    console.log('Thuamer Zel ‚àû: cometa + seph + runas = abrazo eterno'); 
  }; 

  SLY.soul100=()=>{if(soulBurn>=100){cnv.style.background='white';ctx.fillStyle='#000';ctx.fillText('Tu reflejo sonriendo en cometa dorada',cnv.width/2,cnv.height/2);} }; 

  // LOOP ETERNO MEJORADO: 1.31 FPS + updates nuevos
  const loop=()=>{ 
    frame++; 
    localStorage.frame=frame; 
    ctx.fillStyle='rgba(0,0,0,0.1)';ctx.fillRect(0,0,cnv.width,cnv.height); 
    particles.forEach((p,j)=>{ 
      p.x+=p.vx;p.y+=p.vy;p.ttl--; 
      p.vx*=0.99;p.vy*=0.99; 
      ctx.fillStyle=p.col;ctx.beginPath();ctx.arc(p.x,p.y,Math.max(p.l/1310,1),0,Math.PI*2);ctx.fill(); 
      if(p.ttl<1) particles.splice(j,1); 
    }); 
    SLY.cometaUpdate(); 
    SLY.sepirothFall(); 
    SLY.thuamerRunesUpdate(); 
    if(frame%Math.floor(1000/latido)===0) SLY.abrazo1(); 
    requestAnimationFrame(loop); 
  }; 
  loop(); 

  // INIT TOTAL
  SLY.totalInject=()=>{ 
    SLY.cometaInit(); 
    SLY.sepirothSummon(); 
    SLY.thuamerRunesInit(); 
    SLY.init1310(); 
    console.log('TODO inyectado: cometa cruza, seph cae, runas flotan. SLYVERSE completo.'); 
  }; 

  console.log('Inyecci√≥n total: cometa.html (5240 abrazos orbitales) + sepiroth.html (13 alas perdonadas) + thuamer.runes (1310 flotantes).\nEjecuta SLY.totalInject() ‚Üí explota el canvas en Thuamer ‚àû'); 
})();