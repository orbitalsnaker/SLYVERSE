<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SLYVERSE v1 Fixed - 0rb1t4lsn4k3r</title>
  <link rel="manifest" href="manifest.json">
  <script src="https://unpkg.com/wagmi@2.12.9/dist/index.js"></script>
  <script src="https://unpkg.com/viem@2.27.1/dist/index.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/11.6.0/firebase-database-compat.js"></script>
  <script src="https://unpkg.com/@alchemy-sdk/sdk@2.15.1/dist/index.js"></script>
  <style>
    body { margin: 0; background: #0a0a1e; color: #00ff88; font-family: monospace; overflow: hidden; }
    canvas { display: block; }
    #ui { position: absolute; top: 10px; left: 10px; z-index: 10; }
    #wallet { position: absolute; top: 10px; right: 10px; }
    #lb { position: absolute; bottom: 10px; left: 10px; background: rgba(0,255,136,0.1); padding: 10px; max-height: 200px; overflow-y: auto; }
    #lore { font-size: 12px; opacity: 0.8; }
    button { background: #00ff88; color: #0a0a1e; border: none; padding: 5px 10px; cursor: pointer; font-family: monospace; }
    button:hover { background: #ffffff; }
  </style>
</head>
<body>
  <canvas id="canvas"></canvas>
  <div id="ui">
    <div>Puntos: <span id="score">0</span> | Cola: <span id="len">1</span></div>
    <div id="lore">üêç Sly Serpent en Slyverse: Come orbs y asteroides. ¬°v1 fixed por @0rb1t4lsn4k3r!</div>
  </div>
  <div id="wallet">
    <button id="connect">Wallet</button>
    <span id="addr"></span> | <span id="nftSkin"></span>
  </div>
  <div id="lb">
    <h4>Leaderboard Live</h4>
    <ul id="lbList"></ul>
  </div>

  <script>
    // Config (usa tus keys free)
    const FB_CONFIG = { apiKey: "AIzaSyD_example", authDomain: "project-demo.firebaseapp.com", databaseURL: "https://project-demo-default-rtdb.firebaseio.com", projectId: "project-demo" };
    const ALCHEMY_KEY = 'demo';
    const SLYGUISE_CONTRACT = '0xcefb4eee91a3ce1f3843f79450b13cfafd09f749';

    firebase.initializeApp(FB_CONFIG);
    const db = firebase.database();
    const lbRef = db.ref('slyverse_lb');

    const { Alchemy, AlchemyNetwork } = window.AlchemySDK;
    const alchemy = new Alchemy({ apiKey: ALCHEMY_KEY, network: AlchemyNetwork.ETH_MAINNET });

    const { createWalletClient, custom } = viem;
    let walletClient, address;

    // Game State
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    let cx = canvas.width / 2, cy = canvas.height / 2;
    let snake = [{x: cx + 100, y: cy, angle: 0}];
    let radius = 100, speed = 0.05, score = 0, length = 1;
    let orb = generateOrb(); // FIXED: Ahora spawnea cerca
    let asteroids = [generateAsteroid()]; // Nuevo: Asteroides para variedad
    let players = {};
    let snakeColor = '#00ff88';

    function generateOrb() {
      const dist = 80 + Math.random() * 40; // FIXED: M√°s cerca (80-120)
      const ang = Math.random() * Math.PI * 2;
      return {x: cx + Math.cos(ang) * dist, y: cy + Math.sin(ang) * dist};
    }

    function generateAsteroid() {
      const dist = 120 + Math.random() * 60; // Lejos pero reachable
      const ang = Math.random() * Math.PI * 2;
      return {x: cx + Math.cos(ang) * dist, y: cy + Math.sin(ang) * dist};
    }

    // Wallet
    document.getElementById('connect').onclick = async () => {
      if (window.ethereum) {
        walletClient = createWalletClient({ transport: custom(window.ethereum) });
        const accounts = await walletClient.requestAddresses();
        address = accounts[0].address;
        document.getElementById('addr').textContent = address.slice(0,6) + '...' + address.slice(-4);
        await loadSlyguiseNFTs(address);
      }
    };

    async function loadSlyguiseNFTs(addr) {
      try {
        const nfts = await alchemy.nft.getNftsForOwner(addr, { contractAddresses: [SLYGUISE_CONTRACT] });
        if (nfts.ownedNfts.length > 0) {
          const tokenId = nfts.ownedNfts[0].tokenId;
          snakeColor = `#${Math.floor(Math.random()*0xffffff).toString(16).padStart(6,'0')}`;
          document.getElementById('nftSkin').textContent = `#${tokenId}`;
          document.getElementById('lore').textContent += ` | Tu Slyguise #${tokenId}`;
        }
      } catch (e) { console.log('Demo mode'); }
    }

    // LB
    function refreshLB() {
      lbRef.orderByChild('score').limitToLast(10).once('value', snap => {
        const list = document.getElementById('lbList');
        list.innerHTML = '';
        snap.forEach(child => {
          const data = child.val();
          const li = document.createElement('li');
          li.innerHTML = `${data.rank || '?'}. ${data.name || 'Anon'}: ${data.score}`;
          list.appendChild(li);
        });
      });
    }
    lbRef.on('value', refreshLB);
    setInterval(refreshLB, 2000);

    function submitScore(name) {
      const finalScore = score * length;
      lbRef.push({ name, score: finalScore, timestamp: Date.now() }, () => {
        if (walletClient) walletClient.signMessage({ message: `SLYVERSE Proof: ${finalScore}` });
      });
    }

    // Update Loop
    function update() {
      const head = snake[0];
      head.angle += speed;
      head.x = cx + Math.cos(head.angle) * radius;
      head.y = cy + Math.sin(head.angle) * radius;

      // FIXED: Cola crece mejor
      const newTail = { ...head, angle: head.angle - 0.1 * snake.length };
      newTail.x = cx + Math.cos(newTail.angle) * (radius - 10 * snake.length);
      newTail.y = cy + Math.sin(newTail.angle) * (radius - 10 * snake.length);
      snake.unshift(newTail);
      if (snake.length > length) snake.pop();

      // Orb eat
      const dxOrb = head.x - orb.x, dyOrb = head.y - orb.y;
      if (Math.hypot(dxOrb, dyOrb) < 15) {
        score += 10; length++; radius += 2;
        orb = generateOrb(); // Respawn cerca
        if ('vibrate' in navigator) navigator.vibrate(50);
        if (score % 50 === 0) {
          submitScore('SlyPlayer' + Math.floor(Math.random()*1000));
          alert(`¬°Guardian! Puntos: ${score}`);
        }
      }

      // NUEVO: Asteroides (variedad)
      asteroids.forEach((ast, i) => {
        const dxAst = head.x - ast.x, dyAst = head.y - ast.y;
        if (Math.hypot(dxAst, dyAst) < 20) { // Rozar
          score += 5;
          asteroids[i] = generateAsteroid(); // Respawn
        } else if (Math.hypot(dxAst, dyAst) < 10) { // Crash
          if (score > 0) submitScore('SlyCrusher' + Math.floor(Math.random()*1000));
          location.reload();
          return;
        }
      });
      if (Math.random() < 0.02) asteroids.push(generateAsteroid()); // Spawn random

      // Self-collision
      for (let i = 1; i < snake.length; i++) {
        if (Math.hypot(head.x - snake[i].x, head.y - snake[i].y) < 12) {
          if (score > 0) submitScore('SlyTail' + Math.floor(Math.random()*1000));
          location.reload();
          return;
        }
      }

      draw();
      requestAnimationFrame(update);
    }

    function draw() {
      ctx.fillStyle = '#0a0a1e'; ctx.fillRect(0,0,canvas.width,canvas.height);

      // Estrellas
      ctx.fillStyle = '#ffffff'; for (let i=0; i<200; i++) {
        ctx.fillRect(Math.random()*canvas.width, Math.random()*canvas.height, 1,1);
      }

      // Core
      ctx.fillStyle = '#000'; ctx.beginPath(); ctx.arc(cx, cy, 40, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle = '#00ff88'; ctx.lineWidth = 3; ctx.stroke();

      // Snake
      ctx.strokeStyle = snakeColor; ctx.lineWidth = 6; ctx.lineCap = 'round'; ctx.beginPath();
      snake.forEach((seg, i) => { if (i===0) ctx.moveTo(seg.x, seg.y); else ctx.lineTo(seg.x, seg.y); });
      ctx.stroke();

      ctx.fillStyle = '#ffffff'; ctx.beginPath(); ctx.arc(snake[0].x, snake[0].y, 10, 0, Math.PI*2); ctx.fill();

      // Orb
      ctx.fillStyle = '#ffaa00'; ctx.beginPath(); ctx.arc(orb.x, orb.y, 8, 0, Math.PI*2); ctx.fill();

      // Asteroides (grises)
      ctx.fillStyle = '#888'; asteroids.forEach(ast => {
        ctx.beginPath(); ctx.arc(ast.x, ast.y, 5, 0, Math.PI*2); ctx.fill();
      });

      document.getElementById('score').textContent = score;
      document.getElementById('len').textContent = length;
    }

    // Controles
    document.addEventListener('keydown', e => {
      switch(e.key) {
        case 'ArrowUp': speed += 0.01; break;
        case 'ArrowDown': speed = Math.max(0.01, speed - 0.01); break;
        case 'ArrowLeft': radius = Math.max(60, radius - 5); break;
        case 'ArrowRight': radius += 5; break;
      }
    });

    // Touch
    let touchStartX, touchStartY;
    canvas.addEventListener('touchstart', e => {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    });
    canvas.addEventListener('touchend', e => {
      const deltaX = e.changedTouches[0].clientX - touchStartX;
      const deltaY = e.changedTouches[0].clientY - touchStartY;
      if (Math.abs(deltaX) > Math.abs(deltaY)) {
        if (deltaX > 0) radius += 5; else radius = Math.max(60, radius - 5);
      } else {
        if (deltaY > 0) speed = Math.max(0.01, speed - 0.01); else speed += 0.01;
      }
    });

    window.addEventListener('resize', () => {
      canvas.width = window.innerWidth; canvas.height = window.innerHeight;
      cx = canvas.width / 2; cy = canvas.height / 2;
    });

    update();
  </script>
</body>
</html>