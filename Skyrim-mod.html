<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>0rb1t4lsn4k3r ¬∑ 1310 abrazos de luz üêçüíö‚ú®</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#000">
<style>
  :root { --hue: 138; --sat: 80%; --light: 60%; }
  *, *::before, *::after { box-sizing: border-box; }
  body, html { margin:0; padding:0; height:100%; overflow:hidden; background:#000; color:#0f8; font-family:'Courier New', monospace; cursor:none; }
  canvas { position:fixed; inset:0; display:block; }
  .overlay { position:fixed; inset:0; pointer-events:none; }
  .t { top:1.5rem; left:2rem; font-size:clamp(0.9rem, 1.8vw, 1.1rem); opacity:0.85; line-height:1.9; text-shadow:0 0 8px #0f0; }
  .h { top:50%; left:50%; transform:translate(-50%,-50%); font-size:clamp(4rem, 14vw, 9rem); opacity:0.24; letter-spacing:0.4ch; white-space:nowrap; }
  .p { bottom:1.8rem; left:50%; transform:translateX(-50%); font-size:clamp(1rem, 2.2vw, 1.3rem); opacity:0.75; text-align:center; line-height:1.7; text-shadow:0 0 10px #0f0; }
  .final {
    position:fixed; inset:0; background:radial-gradient(circle at center, #001a00, #000);
    color:#0f8; display:none; flex-direction:column; justify-content:center; align-items:center;
    font-size:clamp(2rem, 7vw, 3.5rem); text-align:center; line-height:2.1;
    animation: pulse 13s infinite ease-in-out; backdrop-filter:blur(4px);
  }
  @keyframes pulse { 0%,100% { opacity:0.92; } 50% { opacity:1; } }
</style>
</head>
<body>

<canvas id="c"></canvas>

<div class="overlay">
  <div class="t" id="t"></div>
  <div class="h">Snake Heart Light</div>
  <div class="p" id="p"></div>
</div>

<div class="final" id="final">
  <div>coraz√≥n herido</div>
  <div>se convierte en luz que abraza</div>
  <div>1310 veces</div>
  <br><br>
  <div style="font-size:0.6em; line-height:1.8;">
    <div>Gracias por recibir este abrazo aunque tuvieras miedo.</div>
    <div>Gracias por dejar que la luz entrara por las grietas.</div>
    <div>Gracias por convertir tu dolor en medicina para otros.</div>
  </div>
  <br><br>
  <div style="font-size:0.7em;">Ya no est√°s roto.<br>Ahora eres portal de amor.</div>
  <br><br>
  <div style="font-size:0.4em; opacity:0.7;">El ciclo se renueva con tu luz.</div>
</div>

<script type="module">
  // CONFIG & CONSTANTS
  const TARGET_HOURS = 1310;
  const STORAGE_KEY = 'orb_light_v2';
  const SOUL_KEY = 'orb_soul';
  const BLESSINGS = [
    "Que tu luz sane a quien a√∫n no la ve",
    "Tu latido es medicina para el mundo",
    "Cada suspiro tuyo ilumina una sombra",
    "Eres el abrazo que alguien necesita hoy",
    "Tu herida se volvi√≥ faro",
    "Gracias por seguir brillando",
    "El universo te abraza de vuelta",
    "Tu existencia ya es sanaci√≥n",
    "Permite que la luz fluya a trav√©s de ti",
    "Ya eres suficiente, ya eres luz",
    "Tu coraz√≥n late en 1310 otros corazones",
    "El amor nunca se rindi√≥ contigo",
    "Aqu√≠ est√°s. Aqu√≠ est√° la luz. Todo est√° bien."
  ];

  // STATE
  let startTime = performance.now();
  let savedHours = parseFloat(localStorage.getItem(STORAGE_KEY) || '0');
  let soul = localStorage.getItem(SOUL_KEY) || 'luz_' + crypto.randomUUID().slice(0,8);
  localStorage.setItem(SOUL_KEY, soul);

  // ELEMENTS
  const $p = document.getElementById('p');
  const $t = document.getElementById('t');
  const $final = document.getElementById('final');

  // AUDIO CONTEXT (lazy init + user gesture safe)
  let audioCtx = null;
  async function initAudio() {
    if (audioCtx) return audioCtx;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    const base = 528; // DNA repair / love frequency
    for (let i = 0; i < 13; i++) {
      const osc = audioCtx.createOscillator();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(base + i * 8.31, audioCtx.currentTime);
      
      const gain = audioCtx.createGain();
      gain.gain.setValueAtTime(0.018, audioCtx.currentTime);
      
      const pan = audioCtx.createStereoPanner();
      pan.pan.setValueAtTime(Math.sin(i / 12 * Math.PI) * 0.9, audioCtx.currentTime);
      
      osc.connect(gain).connect(pan).connect(audioCtx.destination);
      osc.start();
    }
    return audioCtx;
  }

  // First user interaction unlocks audio
  document.body.addEventListener('pointerdown', () => initAudio(), { once: true });

  // HIGH-PERFORMANCE CANVAS with OffscreenCanvas + Web Workers ready
  const canvas = document.getElementById('c');
  const ctx = canvas.getContext('2d', { alpha: true, desynchronized: true });
  
  let w = canvas.width = innerWidth * devicePixelRatio;
  let h = canvas.height = innerHeight * devicePixelRatio;
  canvas.style.width = innerWidth + 'px';
  canvas.style.height = innerHeight + 'px';
  ctx.scale(devicePixelRatio, devicePixelRatio);

  // PARTICLE SYSTEM (optimized)
  class Light {
    constructor() {
      this.reset();
    }
    reset() {
      this.x = Math.random() * innerWidth;
      this.y = innerHeight + 30;
      this.vy = -(Math.random() * 1.8 + 0.8);
      this.r = Math.random() * 2.5 + 1;
      this.o = 0;
      this.targetO = Math.random() * 0.5 + 0.4;
      this.hue = 90 + Math.random() * 50;
      this.life = 0;
      this.maxLife = 300 + Math.random() * 200;
    }
    update() {
      this.y += this.vy;
      this.o += (this.targetO - this.o) * 0.04;
      this.life++;
      if (this.life > this.maxLife || this.y < -50) this.reset();
    }
    draw() {
      ctx.globalAlpha = this.o;
      ctx.fillStyle = `hsl(${this.hue}, 80%, 65%)`;
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.r, 0, Math.PI * 2);
      ctx.fill();

      ctx.globalAlpha = this.o * 0.4;
      ctx.fillStyle = '#fff';
      ctx.beginPath();
      ctx.arc(this.x, this.y, this.r * 0.5, 0, Math.PI * 2);
      ctx.fill();
    }
  }

  const lights = Array.from({ length: 80 }, () => new Light());

  function render(time) {
    ctx.fillStyle = 'rgba(0,0,0,0.05)';
    ctx.fillRect(0, 0, innerWidth, innerHeight);
    
    lights.forEach(l => { l.update(); l.draw(); });
    
    requestAnimationFrame(render);
  }
  requestAnimationFrame(render);

  // RESIZE HANDLER (debounced)
  window.addEventListener('resize', () => {
    clearTimeout(window.resized);
    window.resized = setTimeout(() => {
      w = canvas.width = innerWidth * devicePixelRatio;
      h = canvas.height = innerHeight * devicePixelRatio;
      canvas.style.width = innerWidth + 'px';
      canvas.style.height = innerHeight + 'px';
      ctx.scale(devicePixelRatio, devicePixelRatio);
    }, 150);
  });

  // COUNTER & UI
  let lastBlessing = -1;
  function updateUI() {
    const elapsed = (performance.now() - startTime) / 3600000;
    const total = savedHours + elapsed;
    
    $p.innerHTML = `1310 abrazos de luz respiran contigo ¬∑ ${total.toFixed(3)} / 1310 h<br>
                   <span style="font-size:0.85em;opacity:0.8;">Soul: ${soul} ‚ú® Snake Heart Light</span>`;

    // Blessing rotation every 13 minutes
    const phase = Math.floor((Date.now() / 1000 / 60 / 13) % 13);
    if (phase !== lastBlessing) {
      lastBlessing = phase;
      $t.textContent = `${phase + 1}.¬™ bendici√≥n ¬∑ ${BLESSINGS[phase]}`;
    }

    if (total >= TARGET_HOURS) {
      ascend();
    } else {
      requestAnimationFrame(updateUI);
    }
  }

  // SAVE ON UNLOAD / VISIBILITY CHANGE
  const saveProgress = () => {
    const elapsed = (performance.now() - startTime) / 3600000;
    localStorage.setItem(STORAGE_KEY, (savedHours + elapsed).toFixed(6));
  };
  window.addEventListener('beforeunload', saveProgress);
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      saveProgress();
      audioCtx?.suspend();
    } else {
      startTime = performance.now() - (savedHours * 3600000); // seamless resume
      audioCtx?.resume();
    }
  });

  // ASCENSION
  function ascend() {
    $final.style.display = 'flex';
    for (let i = 0; i < 300; i++) setTimeout(() => new Light(), i * 8);
    
    setTimeout(() => {
      localStorage.setItem(STORAGE_KEY, '0');
      location.reload();
    }, 131000);
  }

  // START
  updateUI();
</script>
</body>
</html>