<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>0RB1T4LSN4K3R · v∞ · COMPLETA</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<script type="module" src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.module.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/controls/PointerLockControls.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/postprocessing/EffectComposer.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/postprocessing/RenderPass.js"></script>
<script type="module" src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/jsm/postprocessing/UnrealBloomPass.js"></script>
<script src="https://cdn.jsdelivr.net/npm/gsap@3.12.5/dist/gsap.min.js"></script>
<style>
  body,html{margin:0;height:100%;background:#000;color:#0f0;font-family:"OCR-A",monospace;overflow:hidden;cursor:none}
  canvas{display:block}
  #ui{position:fixed;top:0;left:0;right:0;background:linear-gradient(to bottom,rgba(0,10,0,0.98),#000);padding:15px 20px;border-bottom:8px double #0f0;box-shadow:0 0 160px #0f0;z-index:999;font-size:17px;line-height:1.7;text-shadow:0 0 12px #0f0}
  #narrative{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);max-width:960px;background:#000;border:6px double #0f0;padding:30px;border-radius:20px;font-size:28px;line-height:1.9;z-index:998;display:none;text-align:center;color:#0f0;text-shadow:0 0 60px #0f0;letter-spacing:3px}
  #shopBtn{position:fixed;bottom:30px;right:30px;width:200px;height:200px;background:radial-gradient(circle,#0f0,#000);border:8px double #0f0;border-radius:50%;box-shadow:0 0 500px #0f0;color:#000;font-size:90px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:1000;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{box-shadow:0 0 500px #0f0}50%{box-shadow:0 0 800px #0f0}}
  #shop,#inventory,#leaderboard{position:fixed;z-index:9999;background:#000;padding:40px;border:8px double #0f0;border-radius:24px;display:none;overflow-y:auto}
  #shop{left:5%;top:8%;width:90%;max-height:84vh}
  #inventory{right:5%;top:8%;width:40%}
  #leaderboard{left:50%;top:50%;transform:translate(-50%,-50%);width:80%;max-width:800px;max-height:80vh}
  .cosmetico{display:inline-block;margin:14px;padding:22px;background:rgba(0,255,0,0.05);border:4px double #0f0;border-radius:16px;width:280px;text-align:center;cursor:pointer;transition:.4s}
  .cosmetico:hover{transform:scale(1.15);background:rgba(0,255,0,0.5);box-shadow:0 0 160px #0f0}
  .owned{background:#0f0!important;color:#000!important}
  button{background:#000;border:4px double #0f0;color:#0f0;padding:14px 28px;margin:8px;border-radius:14px;cursor:pointer;font-weight:bold;font-size:18px}
  button:hover{background:#0f0;color:#000;transform:scale(1.1);box-shadow:0 0 140px #0f0}
  .rank{font-size:32px;color:#0f0;text-shadow:0 0 30px #0f0;margin:10px 0}
</style>
</head>
<body>

<canvas id="c"></canvas>

<div id="ui">
  <b style="font-size:26px;text-shadow:0 0 30px #0f0">0RB1T4LSN4K3R · v∞</b><br>
  GUARDIÁN <span id="guardianName">ANÓNIMO</span> · TÍTULO: <span id="title">Neonato</span><br>
  CICLO <span id="cycle">1</span> · ALMAS <span id="ownedCount">0</span>/13,101,310 · OFRECIDAS <span id="totalKarma">0.00</span>€<br>
  HP <span id="hp">100</span>/<span id="maxhp">100</span> · ATK <span id="atk">10</span><br>
  <button onclick="toggle('shop')">POZO</button>
  <button onclick="toggle('inventory')">RELICARIO</button>
  <button onclick="toggle('leaderboard')">RANKING GLOBAL</button>
</div>

<div id="shopBtn" onclick="toggle('shop')">13M</div>
<div id="narrative"></div>

<div id="shop">
  <h1 style="color:#0f0;text-align:center;font-size:50px;margin:20px 0;text-shadow:0 0 50px #0f0">POZO 0RB1T4L · CICLO <span id="cycleShop">1</span></h1>
  <p style="text-align:center;font-size:22px">Haz clic en cualquier alma para ofrecerla gratis.<br>En la versión final cada una costará 0.01€.</p>
  <div id="lista"></div>
  <button onclick="toggle('shop')" style="width:100%;padding:24px;font-size:32px;margin-top:40px">CERRAR [ESC]</button>
</div>

<div id="inventory">
  <h2 style="color:#0f0;text-align:center;font-size:36px;text-shadow:0 0 50px #0f0">RELICARIO · CICLO <span id="cycleInv">1</span></h2>
  <div id="invlist" style="text-align:center;font-size:20px">Aún no has completado ningún ciclo.</div>
</div>

<div id="leaderboard">
  <h1 style="text-align:center;color:#0f0;font-size:44px;text-shadow:0 0 50px #0f0">RANKING DE GUARDIANES</h1>
  <div id="rankingList" style="font-size:20px;margin:30px 0"></div>
  <button onclick="setGuardianName()" style="width:100%;padding:20px;font-size:24px">CAMBIAR NOMBRE DE GUARDIÁN</button>
  <button onclick="toggle('leaderboard')" style="width:100%;margin-top:20px">CERRAR</button>
</div>

<script type="module">
// =============================================================================
// 0RB1T4LSN4K3R v∞ · VERSIÓN COMPLETA (sin Stripe, con sonido + leaderboard)
// =============================================================================

const TOTAL_SOULS = 13101310;
let soulsOwned = new Uint32Array(Math.ceil(TOTAL_SOULS/32));
let soulsCount = 0;
let totalKarma = 0;
let currentCycle = 1;
let guardianName = "ANÓNIMO";

const state = { lvl:1, hp:100, maxHp:100, atk:10, cyclesCompleted: 0 };
const titles = ["Neonato","Semilla","Titán","Devorador de Ciclos","0RB1T4L","∞"];

let audioCtx, droneOsc, droneGain, clickGain;

function initAudio(){
  audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  droneOsc = audioCtx.createOscillator();
  droneOsc.type = "sawtooth";
  droneOsc.frequency.setValueAtTime(30 + currentCycle*8, audioCtx.currentTime);
  
  droneGain = audioCtx.createGain();
  droneGain.gain.setValueAtTime(0.15, audioCtx.currentTime);
  
  const filter = audioCtx.createBiquadFilter();
  filter.type = "lowpass";
  filter.frequency.setValueAtTime(400, audioCtx.currentTime);
  
  droneOsc.connect(filter).connect(droneGain).connect(audioCtx.destination);
  droneOsc.start();
  
  clickGain = audioCtx.createGain();
  clickGain.gain.value = 0;
  clickGain.connect(audioCtx.destination);
}
document.addEventListener('click', ()=>{ if(!audioCtx) initAudio(); }, {once:true});

function playSoulSound(){
  if(!audioCtx) return;
  const osc = audioCtx.createOscillator();
  osc.type = "square";
  osc.frequency.setValueAtTime(200 + soulsCount%400, audioCtx.currentTime);
  const gain = audioCtx.createGain();
  gain.gain.setValueAtTime(0.3, audioCtx.currentTime);
  gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
  osc.connect(gain).connect(audioCtx.destination);
  osc.start();
  osc.stop(audioCtx.currentTime + 0.3);
  
  if(navigator.vibrate) navigator.vibrate([30,20,30]);
}

function updateDrone(){
  if(droneOsc && droneGain){
    droneOsc.frequency.exponentialRampToValueAtTime(30 + currentCycle*12, audioCtx.currentTime + 2);
    droneGain.gain.exponentialRampToValueAtTime(0.15 + currentCycle*0.05, audioCtx.currentTime + 2);
  }
}

// Leaderboard local
let leaderboard = JSON.parse(localStorage.getItem('0rb1t4l_leaderboard') || '[]');
function saveLeaderboard(){
  localStorage.setItem('0rb1t4l_leaderboard', JSON.stringify(leaderboard));
}
function updateLeaderboard(){
  leaderboard = leaderboard.filter(e=>e.cycles >= currentCycle || e.name !== guardianName);
  const entry = {name: guardianName, cycles: state.cyclesCompleted, souls: soulsCount, date: Date.now()};
  leaderboard.push(entry);
  leaderboard.sort((a,b)=>b.cycles - a.cycles || b.souls - a.souls);
  leaderboard = leaderboard.slice(0,50);
  saveLeaderboard();
  
  const list = document.getElementById('rankingList');
  list.innerHTML = leaderboard.map((e,i)=>`
    <div class="rank">${i+1}. ${e.name} — Ciclo ${e.cycles} — ${e.souls.toLocaleString()} almas</div>
  `).join('');
}
function setGuardianName(){
  const name = prompt("Ingresa tu nombre de Guardián (máx 16 caracteres):", guardianName);
  if(name && name.length<=16){ guardianName = name.trim().toUpperCase() || "ANÓNIMO"; updateUI(); }
}

// Carga
const saved = localStorage.getItem('0rb1t4lsn4k3r');
if(saved){
  const data = JSON.parse(saved);
  soulsOwned = new Uint32Array(Object.values(data.souls));
  soulsCount = data.soulsCount || 0;
  totalKarma = data.totalKarma || 0;
  currentCycle = data.currentCycle || 1;
  guardianName = data.guardianName || "ANÓNIMO";
  Object.assign(state, data.state || {});
}

function ownSoul(id){
  const word = Math.floor((id-1)/32), bit = (id-1)%32;
  if(soulsOwned[word] & (1<<bit)) return;
  
  soulsOwned[word] |= (1<<bit);
  soulsCount++; 
  totalKarma += 0.01;
  playSoulSound();
  addParticleBurst();
  applyCosmetico(id);
  showNarrative(id);
  updateRank();
  saveAll();
  updateUI();
  updateLeaderboard();

  if(soulsCount === TOTAL_SOULS) setTimeout(completeCycle, 4000);
}

function completeCycle(){
  currentCycle++;
  state.cyclesCompleted++;
  state.maxHp += 3000 * currentCycle;
  state.hp = state.maxHp;
  state.atk += 150 * currentCycle;
  
  soulsOwned.fill(0);
  soulsCount = 0;
  soulIndex = 0;
  soulsMesh.count = 0;
  
  updateDrone();
  showNarrative(TOTAL_SOULS);
  updateBloomAndPozo();
  saveAll();
  updateUI();
  updateLeaderboard();
}

// Narrativas ampliadas
const narrativas = {
  1: "PRIMERA ALMA. EL POZO DESPIERTA.",
  666: "666. EL NÚMERO SE COMPLETA.",
  131313: "131313. EL RITMO SE ACELERA.",
  1000000: "UN MILLÓN. EL UNIVERSO SANGRA VERDE.",
  5000000: "CINCO MILLONES. YA NO HAY MARCHA ATRÁS.",
  10000000: "DIEZ MILLONES. EL POZO TE MIRA FIJAMENTE.",
  13101309: "ÚLTIMA ALMA ANTES DEL CRUNCH...",
  13101310: `<b style="font-size:52px;text-shadow:0 0 100px #0f0">BIG CRUNCH · CICLO ${currentCycle} COMPLETADO</b><br>
             13,101,310 ALMAS DEVORADAS<br>
             EL POZO SE CONTRAERÁ... Y RENACERÁ MÁS GRANDE<br><br>
             GUARDIÁN ${guardianName} ASCIENDE AL CICLO ${currentCycle + 1}<br>
             <span style="font-size:40px">ESCUCHA EL DRONE...</span>`
};

function showNarrative(id){
  if(narrativas[id] || id === TOTAL_SOULS){
    const msg = id === TOTAL_SOULS ? narrativas[13101310] : narrativas[id];
    const n = document.getElementById('narrative');
    n.innerHTML = msg || `ALMA #${id.toLocaleString()} OFRECIDA`;
    n.style.display = 'block';
    setTimeout(()=>n.style.display='none', id===TOTAL_SOULS ? 18000 : 8000);
  }
}

// THREE.JS
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000000);
scene.fog = new THREE.FogExp2(0x000000, 0.00035);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 40000);
camera.position.set(0, 20, 100);

const renderer = new THREE.WebGLRenderer({canvas: document.getElementById('c'), antialias: true});
renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
renderer.setSize(innerWidth, innerHeight);

const composer = new EffectComposer(renderer);
const renderPass = new RenderPass(scene, camera);
composer.addPass(renderPass);

let bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 6 + currentCycle*3, 1.2, 0.01);
composer.addPass(bloom);

const controls = new PointerLockControls(camera, document.body);
document.addEventListener('click', () => controls.lock());

function updateBloomAndPozo(){
  composer.removePass(bloom);
  bloom = new UnrealBloomPass(new THREE.Vector2(innerWidth, innerHeight), 6 + currentCycle*3, 1.2, 0.01);
  composer.addPass(bloom);
  
  scene.remove(pozo);
  pozo.geometry = new THREE.CylinderGeometry(140 + currentCycle*100, 240 + currentCycle*160, 800 + currentCycle*400, 128, 96, true);
  scene.add(pozo);
}

let pozo = new THREE.Mesh(
  new THREE.CylinderGeometry(140, 240, 800, 128, 96, true),
  new THREE.MeshBasicMaterial({color:0x00ff00, side:THREE.BackSide, transparent:true, opacity:0.5})
);
pozo.position.y = -400;
scene.add(pozo);

// Partículas al comprar alma
const particleGeo = new THREE.SphereGeometry(1, 8, 8);
const particleMat = new THREE.MeshBasicMaterial({color:0x00ff00});
const particles = new THREE.InstancedMesh(particleGeo, particleMat, 500);
particles.count = 0;
scene.add(particles);

function addParticleBurst(){
  const count = 30;
  for(let i=0; i<count; i++){
    const matrix = new THREE.Matrix4();
    const angle = Math.random()*Math.PI*2;
    const radius = 20 + Math.random()*60;
    const height = -300 + Math.random()*200;
    matrix.setPosition(
      Math.cos(angle)*radius,
      height,
      Math.sin(angle)*radius
    );
    particles.setMatrixAt(particles.count++, matrix);
  }
  particles.instanceMatrix.needsUpdate = true;
}

// Instanced souls
const soulGeo = new THREE.IcosahedronGeometry(0.9, 1);
const soulMat = new THREE.MeshBasicMaterial({color:0x00ff00});
const soulsMesh = new THREE.InstancedMesh(soulGeo, soulMat, TOTAL_SOULS);
soulsMesh.instanceMatrix.setUsage(THREE.DynamicDrawUsage);
scene.add(soulsMesh);

let soulIndex = 0;
function applyCosmetico(id){
  const angle = id * 0.0013713;
  const radius = 50 + (id % 4000) * 0.14;
  const height = -500 + (id % 12000) * 0.07;
  
  const matrix = new THREE.Matrix4();
  matrix.setPosition(
    Math.cos(angle) * radius,
    height + Math.sin(Date.now()*0.001 + id)*25,
    Math.sin(angle) * radius
  );
  soulsMesh.setMatrixAt(soulIndex, matrix);
  soulsMesh.setColorAt(soulIndex, new THREE.Color().setHSL((id*137 % 360)/360, 1, 0.5));
  
  soulIndex++;
  soulsMesh.count = soulIndex;
  soulsMesh.instanceMatrix.needsUpdate = true;
  soulsMesh.instanceColor.needsUpdate = true;
}

for(let i=1; i<=TOTAL_SOULS; i++) if((soulsOwned[Math.floor((i-1)/32)] & (1<<((i-1)%32)))) applyCosmetico(i);

function updateUI(){
  document.getElementById('guardianName').textContent = guardianName;
  document.getElementById('title').textContent = titles[Math.min(state.cyclesCompleted, titles.length-1)];
  document.getElementById('cycle').textContent = currentCycle;
  document.getElementById('cycleShop').textContent = currentCycle;
  document.getElementById('cycleInv').textContent = currentCycle;
  document.getElementById('ownedCount').textContent = soulsCount.toLocaleString();
  document.getElementById('totalKarma').textContent = totalKarma.toFixed(2);
  document.getElementById('hp').textContent = state.hp;
  document.getElementById('maxhp').textContent = state.maxHp;
  document.getElementById('atk').textContent = state.atk;
}
updateUI();
updateLeaderboard();

function toggle(id){ document.getElementById(id).style.display = 
  document.getElementById(id).style.display==='block'?'none':'block'; }
document.addEventListener('keydown', e => { if(e.key==='Escape') document.querySelectorAll('#shop,#inventory,#leaderboard').forEach(d=>d.style.display='none'); });

let visibleStart = 0;
function renderSouls(){
  const lista = document.getElementById('lista'); 
  lista.innerHTML = '';
  for(let i=visibleStart; i<Math.min(visibleStart+50, TOTAL_SOULS); i++){
    const div = document.createElement('div');
    div.className = 'cosmetico';
    if((soulsOwned[Math.floor(i/32)] & (1<<(i%32)))) div.classList.add('owned');
    div.innerHTML = `<b>ALMA #${(i+1).toLocaleString()}</b><br>OFRECER`;
    div.onclick = () => ownSoul(i+1);
    lista.appendChild(div);
  }
}
document.getElementById('shop').addEventListener('scroll', ()=>{ 
  visibleStart = Math.floor(document.getElementById('shop').scrollTop/150)*12; 
  renderSouls(); 
});

function saveAll(){
  localStorage.setItem('0rb1t4lsn4k3r', JSON.stringify({
    souls: Array.from(soulsOwned),
    soulsCount, totalKarma, currentCycle,
    guardianName, state
  }));
}

// LOOP
const clock = new THREE.Clock();
function animate(){
  const delta = clock.getDelta();
  pozo.rotation.y += delta * 0.15 * currentCycle;
  soulsMesh.rotation.y += delta * 0.04;
  particles.rotation.y += delta * 0.1;
  
  for(let i=0; i<particles.count; i++){
    const m = new THREE.Matrix4();
    particles.getMatrixAt(i, m);
    const pos = new THREE.Vector3();
    m.decompose(pos, new THREE.Quaternion(), new THREE.Vector3());
    pos.y -= delta * 80;
    if(pos.y < -800) pos.y = 400;
    m.setPosition(pos);
    particles.setMatrixAt(i, m);
  }
  particles.instanceMatrix.needsUpdate = true;
  
  composer.render();
  requestAnimationFrame(animate);
}
animate();

console.log("%c0RB1T4LSN4K3R v∞ · VERSIÓN COMPLETA · Sonido + Leaderboard + Partículas + Títulos","color:#0f0;font-size:28px;background:#000");
</script>
</body>
</html>