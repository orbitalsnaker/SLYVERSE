/*
  THUAMER ULTRA V1.1 DEFINITIVA
  Autor: 0rb1t4lsn4k3r + xAI Grok Ultra
  Descripción: MMORPG épico online con persistencia, eventos globales, misiones, PvP y chat.
  Controles y guía en el readme integrado.
  Idioma detectado automáticamente según navegador.
*/

// ==================== BACKEND ====================
const http = require('http');
const fs = require('fs');
const WebSocket = require('ws');

const PORT = 3000;
const clients = new Set();
let worldState = {
  players: {},
  mobs: [],
  npcs: [],
  events: [],
  leaderboard: []
};

// Servir cliente
const server = http.createServer((req, res) => {
  if (req.url === '/') {
    res.writeHead(200, {'Content-Type': 'text/html'});
    res.end(fs.readFileSync('./client.html'));
  }
});
server.listen(PORT, () => console.log(`Servidor HTTP corriendo en http://localhost:${PORT}`));

// WebSocket
const wss = new WebSocket.Server({ server });
wss.on('connection', ws => {
  clients.add(ws);
  ws.send(JSON.stringify({type:'init', state:worldState}));

  ws.on('message', msg => {
    try {
      const data = JSON.parse(msg);
      handleMessage(ws, data);
    } catch(e){console.error(e);}
  });

  ws.on('close', ()=>clients.delete(ws));
});

function broadcast(data){
  const msg = JSON.stringify(data);
  clients.forEach(c=>{if(c.readyState===WebSocket.OPEN)c.send(msg);});
}

// Manejo de mensajes
function handleMessage(ws, data){
  if(data.type==='updatePlayer'){
    worldState.players[data.id] = data.state;
    broadcast({type:'playerUpdate', id:data.id, state:data.state});
  }
  if(data.type==='chat'){
    broadcast({type:'chat', from:data.from, message:data.message});
  }
}

// Inicialización de mobs y NPCs
for(let i=0;i<500;i++){
  worldState.mobs.push({
    id:'mob'+i,
    x:Math.random()*4096*24,
    y:Math.random()*4096*24,
    hp:100+Math.random()*200,
    lvl:Math.random()*50|0
  });
}
for(let i=0;i<50;i++){
  worldState.npcs.push({
    id:'npc'+i,
    x:Math.random()*4096*24,
    y:Math.random()*4096*24,
    quests:[{id:i,desc:'Mata 50 mobs',goal:50,progress:0}]
  });
}

// ==================== CLIENTE ====================
const clientHTML = `
<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>THUAMER ULTRA V1.1 ONLINE</title>
<style>
body{margin:0;overflow:hidden;background:#000;font-family:monospace;color:#0f0;font-size:12px}
canvas{display:block;image-rendering:pixelated}
#ui{position:fixed;top:4px;left:4px;background:rgba(0,15,0,.98);padding:8px;border:1px solid #0f0;z-index:20;max-width:450px;font-size:11px}
#chat{position:fixed;bottom:4px;left:4px;width:580px;height:190px;background:rgba(0,0,0,.95);border:1px solid #0f0;padding:8px;overflow:auto;font-size:10px;line-height:1.3}
#lb{position:fixed;top:188px;right:4px;width:180px;height:260px;background:rgba(0,15,0,.95);border:1px solid #0f0;overflow:auto;font-size:9px;padding:6px}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="ui">Cargando THUAMER ULTRA V1.1...</div>
<div id="chat"></div>
<div id="lb">TOP LVL GLOBAL<br><span id="leaderboard"></span></div>
<script>
const socket = new WebSocket('ws://'+location.host);
let playerID = 'player'+Math.random().toString(36).substring(2,8);
let world = {players:{},mobs:[],npcs:[],events:[],leaderboard:[]};
let LANG = (navigator.language||'es').slice(0,2);
LANG = ['es','en'].includes(LANG)?LANG:'es';
const I18N = {es:{welcome:'¡Bienvenido a THUAMER ULTRA V1.1!',help:'WASD/Mouse: Mover | CLICK Izq: Ataque | E:Interact NPC/Portal | I:Inv | C:Craft | Q:Quests | H:Ayuda | S:Save'},en:{welcome:'Welcome to THUAMER ULTRA V1.1!',help:'WASD/Mouse: Move | Left Click: Attack | E:Interact NPC/Portal | I:Inventory | C:Craft | Q:Quests | H:Help | S:Save'}};

socket.onmessage = e => {
  const msg = JSON.parse(e.data);
  if(msg.type==='init'){world = msg.state;addChat(I18N[LANG].welcome);}
  if(msg.type==='playerUpdate'){world.players[msg.id] = msg.state;}
  if(msg.type==='chat'){addChat(msg.from+': '+msg.message);}
};

// Canvas
const C=document.getElementById('c'),ctx=C.getContext('2d');
let W,H;
function resize(){W=C.width=innerWidth;H=C.height=innerHeight;}resize();
addEventListener('resize',resize);

const Input={keys:{},mouse:{x:0,y:0,btns:0}};
document.addEventListener('keydown',e=>Input.keys[e.key.toLowerCase()]=1);
document.addEventListener('keyup',e=>Input.keys[e.key.toLowerCase()]=0);
C.addEventListener('mousemove',e=>Input.mouse.x=e.clientX;Input.mouse.y=e.clientY);
C.addEventListener('mousedown',e=>Input.mouse.btns|=1<<e.button);
C.addEventListener('mouseup',e=>Input.mouse.btns&=~(1<<e.button));

let pos={x:2048*24,y:2048*24},lvl=1,hp=300,mhp=300,inv=[],quests=[],str=25,agi=25,int=25;

function addChat(msg){
  const chat=document.getElementById('chat');
  chat.innerHTML+='» '+msg+'<br>';
  chat.scrollTop=chat.scrollHeight;
}

// Leaderboard
function drawLeaderboard(){
  const lb=document.getElementById('leaderboard');
  const top = Object.values(world.players).sort((a,b)=>b.lvl-a.lvl).slice(0,10);
  lb.innerHTML = top.map((p,i)=>i+1+'. '+(p.name||'Anon')+' '+p.lvl).join('<br>');
}

// Main loop
function update(dt){
  const speed=(250+agi*1.5)*dt;
  if(Input.keys['w'])pos.y-=speed;
  if(Input.keys['s'])pos.y+=speed;
  if(Input.keys['a'])pos.x-=speed;
  if(Input.keys['d'])pos.x+=speed;

  // Send update
  socket.send(JSON.stringify({type:'updatePlayer', id:playerID, state:{x:pos.x,y:pos.y,lvl,hp,mhp,str,agi,int,inv,quests,name:'Hero'+playerID}}));
}

function draw(){
  ctx.fillStyle='#000';ctx.fillRect(0,0,W,H);

  // Draw mobs
  world.mobs.forEach(m=>{
    ctx.fillStyle='#f44';
    ctx.fillRect(m.x-pos.x+W/2-8,m.y-pos.y+H/2-8,16,16);
  });

  // Draw NPCs
  world.npcs.forEach(n=>{
    ctx.fillStyle='#0f0';
    ctx.fillRect(n.x-pos.x+W/2-10,n.y-pos.y+H/2-10,20,20);
  });

  // Draw other players
  Object.values(world.players).forEach(p=>{
    ctx.fillStyle='#0ff';
    ctx.fillRect(p.x-pos.x+W/2-10,p.y-pos.y+H/2-10,20,20);
  });

  // Player
  ctx.fillStyle='#ff0';
  ctx.fillRect(W/2-12,H/2-12,24,24);

  // UI
  document.getElementById('ui').innerHTML=`LVL ${lvl} | HP ${Math.floor(hp)}/${mhp} | STR:${str} AGI:${agi} INT:${int} | Inv:${inv.length} | Quests:${quests.length}`;
  drawLeaderboard();
}

let last=0;
function loop(t){
  const dt=Math.min((t-last)/1000,1/60);
  last=t;
  update(dt);
  draw();
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

// Chat send
document.addEventListener('keypress',e=>{
  if(e.key==='Enter'){const msg=prompt('Mensaje:');if(msg)socket.send(JSON.stringify({type:'chat',from:'Hero'+playerID,message:msg}));}
});
</script>
</body>
</html>
`;

// Guardar client.html
fs.writeFileSync('client.html', clientHTML);
console.log('Cliente guardado en client.html. Abre http://localhost:3000 en tu navegador para jugar V1.1');
