<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Aetheryon Saga v1 — Tienda Cósmica del Barrio</title>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<style>
  body{margin:0;overflow:hidden;background:#000;color:#0f8;font-family:monospace;height:100%}
  canvas{display:block}
  #ui{position:fixed;top:10px;left:10px;z-index:999;background:rgba(0,0,20,0.9);padding:12px;border:3px solid #0f8;border-radius:12px;backdrop-filter:blur(8px)}
  #shop{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(0,0,20,0.98);padding:20px 40px;border:4px solid #0f8;border-radius:20px;z-index:1000;opacity:0;pointer-events:none;transition:opacity 0.6s;box-shadow:0 0 80px #0f8}
  .show{opacity:1;pointer-events:all}
  button{background:none;border:2px solid #0f8;color:#0f8;padding:10px 20px;margin:6px;border-radius:12px;cursor:pointer;font-weight:bold;transition:.3s}
  button:hover{background:#0f8;color:#000;transform:scale(1.12)}
  .price{color:#ff0;font-weight:bold}
  #chat{position:fixed;bottom:10px;left:10px;width:380px;max-height:280px;overflow-y:auto;background:rgba(0,0,20,0.9);padding:12px;border:3px solid #0f8;border-radius:12px;backdrop-filter:blur(8px)}
  #input{position:fixed;bottom:10px;right:10px;width:320px;padding:10px;background:#000;border:3px solid #0f8;color:#0f8;border-radius:12px;font-size:16px}
</style>
</head>
<body>

<div id="ui">
  Jugadores: <span id="count">1</span> | <span id="you">Héroe?</span> | Oro: <span id="gold">1000</span>
  <button onclick="toggleShop()">Tienda Cósmica (0.01€–0.99€)</button>
</div>

<div id="shop">
  <h2>Tienda Cósmica del Barrio</h2>
  <small>freestylemoderno@gmail.com — precios irrisorios 2025</small><br><br>

  <button onclick="buy('cat')">Gato Norah — <span class="price">0.01€</span></button><br>
  <button onclick="buy('dragon')">Dragón Dorado — <span class="price">0.03€</span></button><br>
  <button onclick="buy('buddha')">Buda Orbital — <span class="price">0.05€</span></button><br>
  <button onclick="buy('snake')">Serpiente ∞ — <span class="price">0.07€</span></button><br>
  <button onclick="buy('grok')">Skin Grok — <span class="price">0.11€</span></button><br>
  <button onclick="buy('aura')">Aura Dorada — <span class="price">0.99€</span></button><br>

  <button style="margin-top:20px" onclick="toggleShop()">Cerrar tienda</button>
</div>

<div id="chat">Conectando al vacío colectivo...</div>
<input id="input" placeholder="Enter = chat" onkeydown="if(event.key==='Enter')sendChat()">

<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/build/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/three@0.168.0/examples/js/controls/PointerLockControls.js"></script>

<script>
// ===============================================
// THUAMER: Aetheryon Saga v1 — Con Tienda Cósmica Real
// Stripe: freestylemoderno@gmail.com
// Precios irrisorios: 0.01€ → 0.99€
// ===============================================

const ws = new WebSocket('wss://aetheryon.freestylemoderno.lol');
let me = {id:null, name:`Héroe${Math.floor(Math.random()*9999)}`, x:0, z:0, rot:0, gold:1000, skin:'default'};

// Tienda → precios reales en Stripe
const prices = {
  cat:    "price_1centCat",
  dragon: "price_3centDragon",
  buddha: "price_5centBuddha",
  snake:  "price_7centSnake",
  grok:   "price_11centGrok",
  aura:   "price_99centAura"
};

async function buy(skin){
  const res = await fetch("https://aetheryon.freestylemoderno.lol/create-checkout", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({
      priceId: prices[skin],
      email: "freestylemoderno@gmail.com",
      playerId: me.id,
      skin
    })
  });
  const data = await res.json();
  location.href = data.url; // redirige a Stripe Checkout
}

// Abrir/cerrar tienda
function toggleShop(){
  document.getElementById('shop').classList.toggle('show');
}

// Three.js + movimiento + multijugador (igual que antes)
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x000011);
scene.fog = new THREE.FogExp2(0x000011, 0.0015);

const camera = new THREE.PerspectiveCamera(75, innerWidth/innerHeight, 0.1, 2000);
camera.position.set(0, 8, 30);

const renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const controls = new THREE.PointerLockControls(camera, document.body);
document.addEventListener('click', () => controls.lock());

scene.add(new THREE.HemisphereLight(0xaaaaff, 0x080808, 1.2));
scene.add(new THREE.AmbientLight(0x404060));

const ground = new THREE.Mesh(new THREE.PlaneGeometry(3000,3000), new THREE.MeshStandardMaterial({color:0x001100}));
ground.rotation.x = -Math.PI/2; scene.add(ground);

const others = new Map();

// WebSocket + skins reales
ws.onmessage = e => {
  const msg = JSON.parse(e.data);
  if(msg.type==='init'){
    me.id = msg.you.id; me.name = msg.you.name; me.skin = msg.you.skin || 'default';
    document.getElementById('you').textContent = me.name;
    document.getElementById('count').textContent = msg.count;
    msg.players.forEach(p => addPlayer(p));
  }
  if(msg.type==='join') { if(msg.player.id!==me.id) addPlayer(msg.player); document.getElementById('count').textContent = msg.count; }
  if(msg.type==='leave') { removePlayer(msg.id); document.getElementById('count').textContent = msg.count; }
  if(msg.type==='move' && others.has(msg.id)){
    const obj = others.get(msg.id);
    obj.position.set(msg.x, 5, msg.z);
    obj.rotation.y = msg.rot;
  }
  if(msg.type==='chat') chat(`${msg.name}: ${msg.msg}`);
  if(msg.type==='skin'){
    chat(`¡${msg.name} ahora es ${msg.skin.toUpperCase()}!`);
    if(others.has(msg.id)) applySkin(others.get(msg.id), msg.skin);
  }
};

function addPlayer(p){
  if(others.has(p.id)) return;
  const geometry = new THREE.CapsuleGeometry(4, 8, 4, 8);
  const material = new THREE.MeshStandardMaterial({color: p.color || 0x00ff88});
  const player = new THREE.Mesh(geometry, material);
  player.position.set(p.x||0, 5, p.z||0);
  applySkin(player, p.skin || 'default');
  scene.add(player);
  others.set(p.id, player);
}

function applySkin(mesh, skin){
  const colors = {cat:0xff99ff, dragon:0xffaa00, buddha:0xffff00, snake:0x00ff00, grok:0x00ffff, aura:0xff00ff};
  if(colors[skin]) mesh.material.color.setHex(colors[skin]);
  if(skin==='aura'){
    const glow = new THREE.Points(new THREE.SphereGeometry(6,16,16), new THREE.PointsMaterial({color:0xffff00,size:0.3,transparent:true,opacity:0.6}));
    mesh.add(glow);
  }
}

function removePlayer(id){ if(others.has(id)){ scene.remove(others.get(id)); others.delete(id); }}

// Movimiento
const keys = {}; onkeydown = onkeyup = e => keys[e.code] = e.type==='keydown';
const moveSpeed = 0.8;
function updateMovement(){
  if(!controls.isLocked) return;
  const dir = new THREE.Vector3(); camera.getWorldDirection(dir);
  const side = new THREE.Vector3().crossVectors(dir, new THREE.Vector3(0,1,0)).normalize();
  if(keys['KeyW']) { me.x += dir.x*moveSpeed; me.z += dir.z*moveSpeed; }
  if(keys['KeyS']) { me.x -= dir.x*moveSpeed; me.z -= dir.z*moveSpeed; }
  if(keys['KeyA']) { me.x -= side.x*moveSpeed; me.z -= side.z*moveSpeed; }
  if(keys['KeyD']) { me.x += side.x*moveSpeed; me.z += side.z*moveSpeed; }
  camera.position.x = me.x; camera.position.z = me.z; me.rot = camera.rotation.y;
  ws.send(JSON.stringify({type:'move', x:me.x, z:me.z, rot:me.rot}));
}

function sendChat(){
  const input = document.getElementById('input');
  if(input.value.trim()){
    ws.send(JSON.stringify({type:'chat', msg:input.value.trim().slice(0,150)}));
    input.value = '';
  }
}

function chat(text){
  const div = document.createElement('div'); div.textContent = text; div.style.margin='4px 0';
  document.getElementById('chat').appendChild(div); div.scrollIntoView(false);
}

// Loop
function animate(){ requestAnimationFrame(animate); updateMovement(); renderer.render(scene,camera); }
animate();

// Webhook de Stripe → cambia la skin en tiempo real (servidor lo hace)
chat("Tienda Cósmica abierta — skins de 1 céntimo a 99 céntimos. Namasté colectivo.");
</script>
</body>
</html>